<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MySQL3 | 易曦翰</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="花开亦花散">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.392636e6.css" as="style"><link rel="preload" href="/assets/js/app.e43ac33f.js" as="script"><link rel="preload" href="/assets/js/3.e4073929.js" as="script"><link rel="preload" href="/assets/js/1.de47dd8b.js" as="script"><link rel="preload" href="/assets/js/22.21950ee6.js" as="script"><link rel="prefetch" href="/assets/js/10.a6bf59f6.js"><link rel="prefetch" href="/assets/js/11.0945fe29.js"><link rel="prefetch" href="/assets/js/12.892c9174.js"><link rel="prefetch" href="/assets/js/13.cffb93a9.js"><link rel="prefetch" href="/assets/js/14.720f9b5d.js"><link rel="prefetch" href="/assets/js/15.6f81eb40.js"><link rel="prefetch" href="/assets/js/16.debed7b4.js"><link rel="prefetch" href="/assets/js/17.d0577156.js"><link rel="prefetch" href="/assets/js/18.6947f41e.js"><link rel="prefetch" href="/assets/js/19.c6506af2.js"><link rel="prefetch" href="/assets/js/20.d86fb233.js"><link rel="prefetch" href="/assets/js/21.945600e2.js"><link rel="prefetch" href="/assets/js/23.6079cb8a.js"><link rel="prefetch" href="/assets/js/24.dceecada.js"><link rel="prefetch" href="/assets/js/25.482b9d2d.js"><link rel="prefetch" href="/assets/js/26.e421afd4.js"><link rel="prefetch" href="/assets/js/27.c870161a.js"><link rel="prefetch" href="/assets/js/28.e3755dfa.js"><link rel="prefetch" href="/assets/js/29.bca3c528.js"><link rel="prefetch" href="/assets/js/30.e2d635b6.js"><link rel="prefetch" href="/assets/js/31.5056da5c.js"><link rel="prefetch" href="/assets/js/32.967c2653.js"><link rel="prefetch" href="/assets/js/33.77555a12.js"><link rel="prefetch" href="/assets/js/34.a7ce1efe.js"><link rel="prefetch" href="/assets/js/35.d09f03da.js"><link rel="prefetch" href="/assets/js/36.b76257e1.js"><link rel="prefetch" href="/assets/js/37.3a3c2e7e.js"><link rel="prefetch" href="/assets/js/38.aa1893c0.js"><link rel="prefetch" href="/assets/js/39.6e1c57a1.js"><link rel="prefetch" href="/assets/js/4.1c403fee.js"><link rel="prefetch" href="/assets/js/40.fbaa6c12.js"><link rel="prefetch" href="/assets/js/5.ba9c2a3c.js"><link rel="prefetch" href="/assets/js/6.7bc1a28c.js"><link rel="prefetch" href="/assets/js/7.7d67996f.js"><link rel="prefetch" href="/assets/js/8.1e07915a.js"><link rel="prefetch" href="/assets/js/9.d2a7f2ef.js">
    <link rel="stylesheet" href="/assets/css/0.styles.392636e6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>易曦翰</h3> <p class="description" data-v-59e6cb88>花开亦花散</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>易曦翰</span>
          
        <span data-v-59e6cb88>2023 - </span>
        2022
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="./pubilc/yixihan.png" alt="易曦翰" class="logo"> <span class="site-name">易曦翰</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/Go/" class="nav-link"><i class="undefined"></i>
  Go
</a></li><li class="dropdown-item"><!----> <a href="/categories/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/categories/MySQL/" class="nav-link"><i class="undefined"></i>
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/categories/Nginx/" class="nav-link"><i class="undefined"></i>
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/categories/面经/" class="nav-link"><i class="undefined"></i>
  面经
</a></li><li class="dropdown-item"><!----> <a href="/categories/RabbitMQ/" class="nav-link"><i class="undefined"></i>
  RabbitMQ
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/categories/go/" class="nav-link"><i class="iconfont reco-document"></i>
  Go
</a></div><div class="nav-item"><a href="/categories/Java/" class="nav-link"><i class="iconfont reco-document"></i>
  Java
</a></div><div class="nav-item"><a href="/categories/MySQL/" class="nav-link"><i class="iconfont reco-document"></i>
  MySQL
</a></div><div class="nav-item"><a href="/categories/Nginx/" class="nav-link"><i class="iconfont reco-document"></i>
  Nginx
</a></div><div class="nav-item"><a href="/categories/RabbitMQ/" class="nav-link"><i class="iconfont reco-document"></i>
  RabbitMQ
</a></div><div class="nav-item"><a href="/categories/面经/" class="nav-link"><i class="iconfont reco-document"></i>
  面经
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="./pubilc/yixihan.png" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    易曦翰
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>30</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>27</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/Go/" class="nav-link"><i class="undefined"></i>
  Go
</a></li><li class="dropdown-item"><!----> <a href="/categories/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/categories/MySQL/" class="nav-link"><i class="undefined"></i>
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/categories/Nginx/" class="nav-link"><i class="undefined"></i>
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/categories/面经/" class="nav-link"><i class="undefined"></i>
  面经
</a></li><li class="dropdown-item"><!----> <a href="/categories/RabbitMQ/" class="nav-link"><i class="undefined"></i>
  RabbitMQ
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/categories/go/" class="nav-link"><i class="iconfont reco-document"></i>
  Go
</a></div><div class="nav-item"><a href="/categories/Java/" class="nav-link"><i class="iconfont reco-document"></i>
  Java
</a></div><div class="nav-item"><a href="/categories/MySQL/" class="nav-link"><i class="iconfont reco-document"></i>
  MySQL
</a></div><div class="nav-item"><a href="/categories/Nginx/" class="nav-link"><i class="iconfont reco-document"></i>
  Nginx
</a></div><div class="nav-item"><a href="/categories/RabbitMQ/" class="nav-link"><i class="iconfont reco-document"></i>
  RabbitMQ
</a></div><div class="nav-item"><a href="/categories/面经/" class="nav-link"><i class="iconfont reco-document"></i>
  面经
</a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>MySQL3</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>易曦翰</span>
          
        <span data-v-59e6cb88>2023 - </span>
        2022
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">MySQL3</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>易曦翰</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2022/10/30</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>MySQL</span></i></div></div> <div class="theme-reco-content content__default"><h1 id="mysql-高级"><a href="#mysql-高级" class="header-anchor">#</a> MySQL 高级</h1> <h2 id="mysql-的架构介绍"><a href="#mysql-的架构介绍" class="header-anchor">#</a> MySQL 的架构介绍</h2> <h3 id="mysql-简介"><a href="#mysql-简介" class="header-anchor">#</a> MySQL 简介</h3> <blockquote><p>概述</p></blockquote> <p>MySQL 是一个关系型数据库管理系统, 由瑞段 MySQL AB 公司开发, 目前属于 Oracle 公司</p> <p>MySQL 是一种关联数据库管理系统, 将数据保存在不同的表中, 而不是将所有的数据放在一个大仓库中, 这样就增加了速度并且提高了灵活性</p> <p>MySQL 是开源的</p> <p>MySQL 支持大型的数据库, 可以处理拥有上千万条记录的大型数据库</p> <p>MySQL 使用标准的 sql 数据语言形式</p> <p>MySQL 可以运行在多个系统上, 并且支持多种语言, 这些编程语言包括 C, C++, Python, Java, Perl, PHP, Eiffel, Ruby 和 Tcl 等.</p> <p>MySQL 支持大型数据库, 支持 5000w 记录的数据仓库, 32 为系统表文件最大支持 4 GB, 64 为系统最大支持的表文件为 8TB</p> <p>MySQL 是可以定制了, 采用 GPL 协议, 你可以修改源码来开发自己的 MySQL 系统
 </p> <blockquote><p>高级 MySQL</p></blockquote> <ul><li>MySQL 内核</li> <li>sql 优化工程师</li> <li>MySQL 服务器的优化</li> <li>查询语句的优化</li> <li>主从复制</li> <li>软硬件升级</li> <li>容灾备份</li> <li>sql 编程
 </li></ul> <h3 id="yum-安装mysql-可行"><a href="#yum-安装mysql-可行" class="header-anchor">#</a> yum 安装MySQL (可行)</h3> <h3 id="安装-mysql"><a href="#安装-mysql" class="header-anchor">#</a> 安装 MySQL</h3> <blockquote><p>下载并安装 MySQL 官方的 Yum Repository</p></blockquote> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">wget</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-c</span> http://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>yum 安装 Yum Repository</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> mysql57-community-release-el7-10.noarch.rpm
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p></p> <blockquote><p>安装 MySQL 服务器</p></blockquote> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> mysql-community-server
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>以上三个指令, 最后出现 complete 即证明无错误</p> <p>可以输入 <code>mysql --version</code> 进行检查</p> <p><img src="https://typora-oss.yixihan.chat//img/202210302204050.png" alt="1"></p> <p>ps : 可能出现以下问题</p> <p><img src="https://typora-oss.yixihan.chat//img/202210302204455.png" alt="image-20220303190048146"></p> <p>解决方法 :</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>输入 
<span class="token function">rpm</span> <span class="token parameter variable">--import</span> https://repo.mysql.com/RPM-GPG-KEY-mysql-2022
再输入
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> mysql-community-server
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="mysql-数据库设置"><a href="#mysql-数据库设置" class="header-anchor">#</a> MySQL 数据库设置</h3> <blockquote><p>MySQL 常用命令</p></blockquote> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 启动 MySQL</span>
systemctl start mysqld.service

<span class="token comment"># 重启 MySQL</span>
systemctl restart mysqld.service

<span class="token comment"># 停止 MySQL</span>
systemctl stop mysqld.service

<span class="token comment"># 查看 MySQL 运行状态</span>
systemctl status mysqld.service

<span class="token comment"># 进入数据库</span>
mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p></p> <ol><li><p>启动 MySQL 服务器</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl start mysqld.service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>只要不出任何消息就没问题
 </p></li> <li><p>查看 MySQL 数据库状态</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl status mysqld.service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://typora-oss.yixihan.chat//img/202210302204685.png" alt="2"></p></li> <li><p>查看 root 密码</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">grep</span> <span class="token string">&quot;password&quot;</span> /var/log/mysqld.log 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://typora-oss.yixihan.chat//img/202210302204941.png" alt="3"></p></li> <li><p>进入数据库</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>再输入密码, 进入会话中</p> <p><img src="https://typora-oss.yixihan.chat//img/202210302204102.png" alt="4"></p></li> <li><p>修改密码</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">USER</span> <span class="token string">'root'</span><span class="token variable">@'localhost'</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'new password'</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">USER</span> <span class="token string">'root'</span><span class="token variable">@'localhost'</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'W6YnvKnLzpSFNGuc.'</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>新密码必须包含 大小写字母数字和特殊符号(,/';:等)
 </p></li> <li><p>开启 MySQL 的全程访问</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">grant</span> <span class="token keyword">all</span> <span class="token keyword">privileges</span> <span class="token keyword">on</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">to</span> <span class="token string">'root'</span><span class="token variable">@'%'</span> identified <span class="token keyword">by</span> <span class="token string">'password'</span> <span class="token keyword">with</span> <span class="token keyword">grant</span> <span class="token keyword">option</span><span class="token punctuation">;</span>
<span class="token keyword">grant</span> <span class="token keyword">all</span> <span class="token keyword">privileges</span> <span class="token keyword">on</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">to</span> <span class="token string">'root'</span><span class="token variable">@'%'</span> identified <span class="token keyword">by</span> <span class="token string">'W6YnvKnLzpSFNGuc.'</span> <span class="token keyword">with</span> <span class="token keyword">grant</span> <span class="token keyword">option</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>密码必须包含 大小写字母数字和特殊符号(,/';:等)
若指向指定的ip地址才能访问 MySQL, 可以将 <code>'root'@'%'</code> 修改为 <code>'root'@'192.168.0.1'</code></p></li> <li><p>最后刷新退出</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>flush <span class="token keyword">privileges</span><span class="token punctuation">;</span>
<span class="token keyword">exit</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p></p></li> <li><p>修改 mysql 默认端口号 (可选, 若搭建在服务器上, 则推荐)</p> <ol><li><p>vim 打开 my.cnf 配置文件</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /etc/my.cnf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p></p></li> <li><p>添加如下信息</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">1617</span> <span class="token comment"># 端口号自行选择</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://typora-oss.yixihan.chat//img/202210302204963.png" alt="1"></p></li> <li><p>重启 MySQL 服务</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl restart mysqld.service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果出现 <code>Job for mysqld.service failed because the control process exited with error code</code> 错误, 则检查 my.cnf 是否书写正确
 </p></li> <li><p>查看端口号是否已被修改
登录 MySQL</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql <span class="token operator">-</span>uroot <span class="token operator">-</span>p
<span class="token keyword">show</span> <span class="token keyword">global</span> variables <span class="token operator">like</span> <span class="token string">'port'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://typora-oss.yixihan.chat//img/202210302204826.png" alt="1"></p></li></ol></li> <li><p>开放 MySQL 端口号</p> <ol><li><p>检查防火墙是否开启</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl status firewalld
或者
firewall-cmd <span class="token parameter variable">--state</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>若未安装防火墙, 则不管</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>yum <span class="token function">install</span> firewalld firewalld-config <span class="token comment"># 安装防火墙</span>
systemctl start firewalld.service <span class="token comment"># 开启防火墙</span>

<span class="token comment"># 其余常用命令</span>
systemctl stop firewalld <span class="token comment"># 禁用防火墙</span>
systemctl <span class="token builtin class-name">enable</span> firewalld <span class="token comment"># 设置开机自启防火墙</span>
sytemctl disable firewalld <span class="token comment"># 停止并禁用开机自启</span>
firewall-cmd <span class="token parameter variable">--reload</span> <span class="token comment"># 重启防火墙</span>
<span class="token function">service</span> firewalld restart <span class="token comment"># 重启防火墙</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li> <li><p>开放端口号</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>firewall-cmd <span class="token parameter variable">--zone</span><span class="token operator">=</span>public --add-port<span class="token operator">=</span><span class="token number">1617</span>/tcp <span class="token parameter variable">--permanent</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>重启防火墙</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>firewall-cmd <span class="token parameter variable">--reload</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>出现 success 信息就算成功
 </p></li></ol></li> <li><p>更改 mysql 的语言 (后面有完整配置)</p> <ol><li><p>重新登录 MySQL, 并输入 <code>status</code></p> <p><img src="https://typora-oss.yixihan.chat//img/202210302205522.png" alt="1"></p> <p>正常刚安装上面两个编码集不是 utf8, 需要更改
 </p></li> <li><p>更改编码集</p> <p>退出 MySQL, 进入 <code>/etc/my.cnf</code></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /etc/my.cnf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>增加如下几行
<img src="https://typora-oss.yixihan.chat//img/202210302205564.png" alt="1"></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>client<span class="token punctuation">]</span>
default-character-set<span class="token operator">=</span>utf8

<span class="token assign-left variable">socket</span><span class="token operator">=</span>/var/lib/mysql/mysql.sock
character-set-server<span class="token operator">=</span>utf8
collation-server<span class="token operator">=</span>utf8_general_ci

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p></p></li> <li><p>重启 MySQL</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl restart mysqld.service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p></p></li> <li><p>再次查看, 确认已更改
 </p></li></ol></li> <li><p>最后, 使用可视化数据库管理软件连接 MySQL</p> <p><img src="https://typora-oss.yixihan.chat//img/202210302205108.png" alt="1"></p></li></ol> <p><strong>MySQL安装完成!</strong></p> <h3 id="my-cnf-完整配置"><a href="#my-cnf-完整配置" class="header-anchor">#</a> my.cnf 完整配置</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>client<span class="token punctuation">]</span>
port <span class="token operator">=</span> <span class="token number">1617</span>
socket <span class="token operator">=</span> /tmp/mysql.sock
default-character-set<span class="token operator">=</span>utf8mb4

<span class="token punctuation">[</span>mysql<span class="token punctuation">]</span>
no-auto-rehash
default-character-set <span class="token operator">=</span> utf8mb4


<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>

<span class="token comment">##############################基础设置#####################################</span>

<span class="token comment">#Mysql服务的唯一编号 每个mysql服务Id需唯一</span>
server-id <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment">#数据库错误日志文件</span>
log_error <span class="token operator">=</span> error.log

<span class="token comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span>
symbolic-links<span class="token operator">=</span><span class="token number">0</span>

pid-file<span class="token operator">=</span>/var/run/mysqld/mysqld.pid

<span class="token comment">#服务端口号 默认3306</span>
port <span class="token operator">=</span> <span class="token number">1617</span>

<span class="token comment">#mysql安装根目录</span>
basedir <span class="token operator">=</span> /var/lib/mysql

<span class="token comment">#mysql数据文件所在位置</span>
datadir <span class="token operator">=</span> /var/lib/mysql

<span class="token comment">#临时目录 比如load data infile会用到</span>
tmpdir  <span class="token operator">=</span> /tmp

<span class="token comment">#设置socke文件所在目录</span>
socket  <span class="token operator">=</span> /tmp/mysql.sock
<span class="token comment">#数据库默认字符集,主流字符集支持一些特殊表情符号（特殊表情符占用4个字节）</span>
character-set-server <span class="token operator">=</span> utf8mb4

<span class="token comment">#数据库字符集对应一些排序等规则，注意要和character-set-server对应</span>
collation-server <span class="token operator">=</span> utf8mb4_general_ci

<span class="token comment">#设置client连接mysql时的字符集,防止乱码</span>
<span class="token assign-left variable">init_connect</span><span class="token operator">=</span>‘SET NAMES utf8mb4‘

<span class="token comment">#是否对sql语句大小写敏感，1表示不敏感</span>
lower_case_table_names <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment">#最大连接数</span>
max_connections <span class="token operator">=</span> <span class="token number">400</span>

<span class="token comment">#最大错误连接数</span>
max_connect_errors <span class="token operator">=</span> <span class="token number">1000</span>

<span class="token comment">#TIMESTAMP如果没有显示声明NOT NULL，允许NULL值</span>
explicit_defaults_for_timestamp <span class="token operator">=</span> <span class="token boolean">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><blockquote><p>超级详细版</p></blockquote> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>client<span class="token punctuation">]</span>
port <span class="token operator">=</span> <span class="token number">3306</span>
socket <span class="token operator">=</span> /tmp/mysql.sock

<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>

<span class="token comment">###############################基础设置#####################################</span>

<span class="token comment">#Mysql服务的唯一编号 每个mysql服务Id需唯一</span>
server-id <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment">#服务端口号 默认3306</span>
port <span class="token operator">=</span> <span class="token number">3306</span>

<span class="token comment">#mysql安装根目录</span>
basedir <span class="token operator">=</span> /opt/mysql

<span class="token comment">#mysql数据文件所在位置</span>
datadir <span class="token operator">=</span> /opt/mysql/data

<span class="token comment">#临时目录 比如load data infile会用到</span>
tmpdir  <span class="token operator">=</span> /tmp

<span class="token comment">#设置socke文件所在目录</span>
socket  <span class="token operator">=</span> /tmp/mysql.sock

<span class="token comment">#主要用于MyISAM存储引擎,如果多台服务器连接一个数据库则建议注释下面内容</span>
skip-external-locking

<span class="token comment">#只能用IP地址检查客户端的登录，不用主机名</span>
skip_name_resolve <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment">#事务隔离级别，默认为可重复读，mysql默认可重复读级别（此级别下可能参数很多间隙锁，影响性能）</span>
transaction_isolation <span class="token operator">=</span> READ-COMMITTED

<span class="token comment">#数据库默认字符集,主流字符集支持一些特殊表情符号（特殊表情符占用4个字节）</span>
character-set-server <span class="token operator">=</span> utf8mb4

<span class="token comment">#数据库字符集对应一些排序等规则，注意要和character-set-server对应</span>
collation-server <span class="token operator">=</span> utf8mb4_general_ci

<span class="token comment">#设置client连接mysql时的字符集,防止乱码</span>
<span class="token assign-left variable">init_connect</span><span class="token operator">=</span>‘SET NAMES utf8mb4‘

<span class="token comment">#是否对sql语句大小写敏感，1表示不敏感</span>
lower_case_table_names <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment">#最大连接数</span>
max_connections <span class="token operator">=</span> <span class="token number">400</span>

<span class="token comment">#最大错误连接数</span>
max_connect_errors <span class="token operator">=</span> <span class="token number">1000</span>

<span class="token comment">#TIMESTAMP如果没有显示声明NOT NULL，允许NULL值</span>
explicit_defaults_for_timestamp <span class="token operator">=</span> <span class="token boolean">true</span>

<span class="token comment">#SQL数据包发送的大小，如果有BLOB对象建议修改成1G</span>
max_allowed_packet <span class="token operator">=</span> 128M

<span class="token comment">#MySQL连接闲置超过一定时间后(单位：秒)将会被强行关闭</span>
<span class="token comment">#MySQL默认的wait_timeout  值为8个小时, interactive_timeout参数需要同时配置才能生效</span>
interactive_timeout <span class="token operator">=</span> <span class="token number">1800</span>
wait_timeout <span class="token operator">=</span> <span class="token number">1800</span>

<span class="token comment">#内部内存临时表的最大值 ，设置成128M。</span>
<span class="token comment">#比如大数据量的group by ,order by时可能用到临时表，</span>
<span class="token comment">#超过了这个值将写入磁盘，系统IO压力增大</span>
tmp_table_size <span class="token operator">=</span> <span class="token number">134217728</span>
max_heap_table_size <span class="token operator">=</span> <span class="token number">134217728</span>

<span class="token comment">#禁用mysql的缓存查询结果集功能</span>
<span class="token comment">#后期根据业务情况测试决定是否开启</span>
<span class="token comment">#大部分情况下关闭下面两项</span>
query_cache_size <span class="token operator">=</span> <span class="token number">0</span>
query_cache_type <span class="token operator">=</span> <span class="token number">0</span>

<span class="token comment">#####################用户进程分配到的内存设置BEGIN#############################</span>

<span class="token comment">##每个session将会分配参数设置的内存大小</span>
<span class="token comment">#用于表的顺序扫描，读出的数据暂存于read_buffer_size中，当buff满时或读完，将数据返回上层调用者</span>
<span class="token comment">#一般在128kb ~ 256kb,用于MyISAM</span>
<span class="token comment">#read_buffer_size = 131072</span>
<span class="token comment">#用于表的随机读取，当按照一个非索引字段排序读取时会用到，</span>
<span class="token comment">#一般在128kb ~ 256kb,用于MyISAM</span>
<span class="token comment">#read_rnd_buffer_size = 262144</span>
<span class="token comment">#order by或group by时用到</span>

<span class="token comment">#建议先调整为2M，后期观察调整</span>
sort_buffer_size <span class="token operator">=</span> <span class="token number">2097152</span>

<span class="token comment">#一般数据库中没什么大的事务，设成1~2M，默认32kb</span>
binlog_cache_size <span class="token operator">=</span> <span class="token number">524288</span>

<span class="token comment">########################用户进程分配到的内存设置END############################</span>

<span class="token comment">#在MySQL暂时停止响应新请求之前的短时间内多少个请求可以被存在堆栈中</span>
<span class="token comment">#官方建议back_log = 50 + (max_connections / 5),封顶数为900</span>
back_log <span class="token operator">=</span> <span class="token number">130</span>

<span class="token comment">############################日志设置##########################################</span>

<span class="token comment">#数据库错误日志文件</span>
log_error <span class="token operator">=</span> error.log

<span class="token comment">#慢查询sql日志设置</span>
slow_query_log <span class="token operator">=</span> <span class="token number">1</span>
slow_query_log_file <span class="token operator">=</span> slow.log

<span class="token comment">#检查未使用到索引的sql</span>
log_queries_not_using_indexes <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment">#针对log_queries_not_using_indexes开启后，记录慢sql的频次、每分钟记录的条数</span>
log_throttle_queries_not_using_indexes <span class="token operator">=</span> <span class="token number">5</span>

<span class="token comment">#作为从库时生效,从库复制中如何有慢sql也将被记录</span>
log_slow_slave_statements <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment">#慢查询执行的秒数，必须达到此值可被记录</span>
long_query_time <span class="token operator">=</span> <span class="token number">8</span>

<span class="token comment">#检索的行数必须达到此值才可被记为慢查询</span>
min_examined_row_limit <span class="token operator">=</span> <span class="token number">100</span>

<span class="token comment">#mysql binlog日志文件保存的过期时间，过期后自动删除</span>
expire_logs_days <span class="token operator">=</span> <span class="token number">5</span>

<span class="token comment">############################主从复制设置#####################################</span>

<span class="token comment">#开启mysql binlog功能</span>
log-bin<span class="token operator">=</span>mysql-bin

<span class="token comment">#binlog记录内容的方式，记录被操作的每一行</span>
binlog_format <span class="token operator">=</span> ROW

<span class="token comment">#对于binlog_format = ROW模式时，减少记录日志的内容，只记录受影响的列</span>
binlog_row_image <span class="token operator">=</span> minimal

<span class="token comment">#master status and connection information输出到表mysql.slave_master_info中</span>
master_info_repository <span class="token operator">=</span> TABLE

<span class="token comment">#the slave‘s position in the relay logs输出到表mysql.slave_relay_log_info中</span>
relay_log_info_repository <span class="token operator">=</span> TABLE

<span class="token comment">#作为从库时生效,想进行级联复制，则需要此参数</span>
log_slave_updates

<span class="token comment">#作为从库时生效,中继日志relay-log可以自我修复</span>
relay_log_recovery <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment">#作为从库时生效,主从复制时忽略的错误</span>
slave_skip_errors <span class="token operator">=</span> ddl_exist_errors

<span class="token comment">#####################redo log和binlog的关系设置BEGIN#########################</span>

<span class="token comment">#(步骤1) prepare dml相关的SQL操作，然后将redo log buff中的缓存持久化到磁盘</span>
<span class="token comment">#(步骤2)如果前面prepare成功，那么再继续将事务日志持久化到binlog</span>
<span class="token comment">#(步骤3)如果前面成功，那么在redo log里面写上一个commit记录</span>
<span class="token comment">#当innodb_flush_log_at_trx_commit和sync_binlog都为1时是最安全的，</span>
<span class="token comment">#在mysqld服务崩溃或者服务器主机crash的情况下，binary log只有可能丢失最多一个语句或者一个事务。</span>
<span class="token comment">#但是都设置为1时会导致频繁的io操作，因此该模式也是最慢的一种方式。</span>
<span class="token comment">#当innodb_flush_log_at_trx_commit设置为0，mysqld进程的崩溃会导致上一秒钟所有事务数据的丢失。</span>
<span class="token comment">#当innodb_flush_log_at_trx_commit设置为2，只有在操作系统崩溃或者系统掉电的情况下，上一秒钟所有事务数据才可能丢失。</span>

<span class="token comment">#commit事务时,控制redo log buff持久化磁盘的模式 默认为1</span>
innodb_flush_log_at_trx_commit <span class="token operator">=</span> <span class="token number">2</span>

<span class="token comment">#commit事务时,控制写入mysql binlog日志的模式 默认为0</span>
<span class="token comment">#innodb_flush_log_at_trx_commit和sync_binlog都为1时，mysql最为安全但性能上压力也是最大</span>
sync_binlog <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment">####################redo log和binlog的关系设置END############################</span>

<span class="token comment">############################Innodb设置#####################################</span>

<span class="token comment">#数据块的单位8k，默认是16k，16kCPU压力稍小，8k对select的吞吐量大</span>
<span class="token comment">#innodb_page_size的参数值也影响最大索引长度，8k比16k的最大索引长度小</span>
<span class="token comment">#innodb_page_size = 8192</span>

<span class="token comment">#一般设置物理存储的60% ~ 70%</span>
innodb_buffer_pool_size <span class="token operator">=</span> 1G

<span class="token comment">#5.7.6之后默认16M</span>
<span class="token comment">#innodb_log_buffer_size = 16777216</span>

<span class="token comment">#该参数针对unix、linux，window上直接注释该参数.默认值为NULL</span>
<span class="token comment">#O_DIRECT减少操作系统级别VFS的缓存和Innodb本身的buffer缓存之间的冲突</span>
innodb_flush_method <span class="token operator">=</span> O_DIRECT

<span class="token comment">#此格式支持压缩, 5.7.7之后为默认值</span>
innodb_file_format <span class="token operator">=</span> Barracuda

<span class="token comment">#CPU多核处理能力设置，假设CPU是2颗4核的，设置如下</span>
<span class="token comment">#读多，写少可以设成2:6的比例</span>
innodb_write_io_threads <span class="token operator">=</span> <span class="token number">4</span>
innodb_read_io_threads <span class="token operator">=</span> <span class="token number">4</span>

<span class="token comment">#提高刷新脏页数量和合并插入数量，改善磁盘I/O处理能力</span>
<span class="token comment">#默认值200（单位：页）</span>
<span class="token comment">#可根据磁盘近期的IOPS确定该值</span>
innodb_io_capacity <span class="token operator">=</span> <span class="token number">500</span>

<span class="token comment">#为了获取被锁定的资源最大等待时间，默认50秒，超过该时间会报如下错误:</span>
<span class="token comment"># ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span>
innodb_lock_wait_timeout <span class="token operator">=</span> <span class="token number">30</span>

<span class="token comment">#调整buffer pool中最近使用的页读取并dump的百分比,通过设置该参数可以减少转储的page数</span>
innodb_buffer_pool_dump_pct <span class="token operator">=</span> <span class="token number">40</span>

<span class="token comment">#设置redoLog文件所在目录, redoLog记录事务具体操作内容</span>
innodb_log_group_home_dir <span class="token operator">=</span> /opt/mysql/redolog/

<span class="token comment">#设置undoLog文件所在目录, undoLog用于事务回滚操作</span>
innodb_undo_directory <span class="token operator">=</span> /opt/mysql/undolog/

<span class="token comment">#在innodb_log_group_home_dir中的redoLog文件数, redoLog文件内容是循环覆盖写入。</span>
innodb_log_files_in_group <span class="token operator">=</span> <span class="token number">3</span>

<span class="token comment">#MySql5.7官方建议尽量设置的大些，可以接近innodb_buffer_pool_size的大小</span>
<span class="token comment">#之前设置该值较大时可能导致mysql宕机恢复时间过长，现在恢复已经加快很多了</span>
<span class="token comment">#该值减少脏数据刷新到磁盘的频次</span>
<span class="token comment">#最大值innodb_log_file_size * innodb_log_files_in_group &lt;= 512GB,单文件&lt;=256GB</span>
innodb_log_file_size <span class="token operator">=</span> 1024M

<span class="token comment">#设置undoLog文件所占空间可以回收</span>
<span class="token comment">#5.7之前的MySql的undoLog文件一直增大无法回收</span>
innodb_undo_log_truncate <span class="token operator">=</span> <span class="token number">1</span>
innodb_undo_tablespaces <span class="token operator">=</span> <span class="token number">3</span>
innodb_undo_logs <span class="token operator">=</span> <span class="token number">128</span>

<span class="token comment">#5.7.7默认开启该参数 控制单列索引长度最大达到3072</span>
<span class="token comment">#innodb_large_prefix = 1</span>

<span class="token comment">#5.7.8默认为4个, Inodb后台清理工作的线程数</span>
<span class="token comment">#innodb_purge_threads = 4</span>

<span class="token comment">#通过设置配置参数innodb_thread_concurrency来限制并发线程的数量，</span>
<span class="token comment">#一旦执行线程的数量达到这个限制，额外的线程在被放置到对队列中之前，会睡眠数微秒，</span>
<span class="token comment">#可以通过设定参数innodb_thread_sleep_delay来配置睡眠时间</span>
<span class="token comment">#该值默认为0,在官方doc上，对于innodb_thread_concurrency的使用，也给出了一些建议:</span>
<span class="token comment">#(1)如果一个工作负载中，并发用户线程的数量小于64，建议设置innodb_thread_concurrency=0；</span>
<span class="token comment">#(2)如果工作负载一直较为严重甚至偶尔达到顶峰，建议先设置innodb_thread_concurrency=128,</span>
<span class="token comment">###并通过不断的降低这个参数，96, 80, 64等等，直到发现能够提供最佳性能的线程数</span>
<span class="token comment">#innodb_thread_concurrency = 0</span>

<span class="token comment">#强所有发生的死锁错误信息记录到error.log中，之前通过命令行只能查看最近一次死锁信息</span>
innodb_print_all_deadlocks <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment">############################其他设置########################################</span>

<span class="token punctuation">[</span>mysqldump<span class="token punctuation">]</span>
quick
max_allowed_packet <span class="token operator">=</span> 128M

<span class="token punctuation">[</span>mysql<span class="token punctuation">]</span>
no-auto-rehash

<span class="token punctuation">[</span>myisamchk<span class="token punctuation">]</span>
key_buffer_size <span class="token operator">=</span> 20M
sort_buffer_size <span class="token operator">=</span> 256k
read_buffer <span class="token operator">=</span> 2M
write_buffer <span class="token operator">=</span> 2M

<span class="token punctuation">[</span>mysqlhotcopy<span class="token punctuation">]</span>
interactive-timeout

<span class="token punctuation">[</span>mysqld_safe<span class="token punctuation">]</span>
<span class="token comment">#增加每个进程的可打开文件数量</span>
open-files-limit <span class="token operator">=</span> <span class="token number">28192</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br></div></div><p><strong>注意 : 上述的文件不建议全部拷贝使用，当需要哪块时单独复制是最好的，因为每台服务器的需求都不一样</strong></p> <h3 id="mysql-配置文件"><a href="#mysql-配置文件" class="header-anchor">#</a> MySQL 配置文件</h3> <ul><li>二进制文件 log-bin : 主从复制</li> <li>错误日志 log-err : 默认是关闭的, 记录严重的警告和错误信息, 每次启动和关闭的详细信息等</li> <li>查询日志 log : 默认关闭, 记录查询的 sql 语句, 如果开启会减低 mysql 的整体性能</li> <li>数据文件
<ul><li>两系统 :
<ul><li>windows : MySQL 安装路径下的 data 目录下</li> <li>linux : 默认路径 <code>/var/lib/mysql</code></li></ul></li> <li>frm 文件 : 存放表结构</li> <li>myd 文件 : 存放表数据</li> <li>myi 文件 : 存放表索引</li></ul></li> <li>如何配置 :
<ul><li>windows : my.ini 文件</li> <li>linux : <code>/etc/my.cnf</code> 文件</li></ul></li></ul> <p></p> <h3 id="mysql-逻辑架构介绍"><a href="#mysql-逻辑架构介绍" class="header-anchor">#</a> MySQL 逻辑架构介绍</h3> <blockquote><p>总体概述</p></blockquote> <p>和其他数据相比, mysql有点儿与众不同, 它的架构可以在多种不同场景中应用并发挥良好作用, 主要体现在存储引擎的架构上
插件式的存储引擎架构将查询出来和其他的系统任务以及数据库的存储提取相分离, 这种架构可以根据业务的需求和实际需求选择合适的存储引擎
 </p> <p><img src="https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/123.png" alt="1"></p> <blockquote><p>图解</p></blockquote> <ol><li>Connectors
指的是不同语言中与 sql 的交互
 </li> <li>Management Serveices &amp; Utilities
系统管理和控制工具
 </li> <li>Connection Pool : 连接池
管理缓冲用户连接, 线程处理等需要缓存的需求.
负责监听对 MySQL Server 的各种请求，接收连接请求，转发所有连接请求到线程管理模块。每一个连接上 MySQL Server 的客户端请求都会被分配 (或创建) 一个连接线程为其单独服务。而连接线程的主要工作就是负责 MySQL Server 与客户端的通信.
接受客户端的命令请求，传递 Server 端的结果信息等, 线程管理模块则负责管理维护这些连接线程. 包括线程的创建, 线程的 cache 等
 </li> <li>SQL Interface : SQL接口
接受用户的SQL命令, 并且返回用户需要查询的结果.
比如 select from 就是调用 SQL Interface
 </li> <li>Parser : 解析器
SQL命令传递到解析器的时候会被解析器验证和解析. 解析器是由Lex和YACC实现的, 是一个很长的脚本
在 MySQL中我们习惯将所有 Client 端发送给 Server 端的命令都称为 query, 在 MySQL Server 里面, 连接线程接收到客户端的一个 Query 后, 会直接将该 query 传递给专门负责将各种 Query 进行分类然后转发给各个对应的处理模块
 
主要功能 :
<ol><li>将SQL语句进行语义和语法的分析, 分解成数据结构, 然后按照不同的操作类型进行分类, 然后做出针对性的转发到后续步骤, 以后SQL语句的传递和处理就是基于这个结构的</li> <li>如果在分解构成中遇到错误, 那么就说明这个sql语句是不合理的
 </li></ol></li> <li>Optimizer : 查询优化器
SQL语句在查询之前会使用查询优化器对查询进行优化. 就是优化客户端请求的 query(sql语句), 根据客户端请求的 query 语句, 和数据库中的一些统计信息, 在一系列算法的基础上进行分析, 得出一个最优的策略, 告诉后面的程序如何取得这个 query 语句的结果
他使用的是 &quot;选取 - 投影 - 联接&quot; 策略进行查询
 
用一个例子就可以理解 ： <code>select uid,name from user where gender = 1;</code>
这个 select 查询先根据 where 语句进行选取, 而不是先将表全部查询出来以后再进行 gender 过滤
这个 select 查询先根据 uid 和 name 进行属性投影, 而不是将属性全部取出以后再进行过滤
将这两个查询条件联接起来生成最终查询结果
 </li> <li>Cache和Buffer ： 查询缓存
他的主要功能是将客户端提交给 MySQL 的 Select 类 query 请求的返回结果集 cache 到内存中, 与该 query 的一个 hash 值做一个对应. 该 Query 所取数据的基表发生任何数据的变化之后, MySQL 会自动使该 query 的 Cache 失效. 在读写比例非常高的应用系统中，Query Cache 对性能的提高是非常显著的. 当然它对内存的消耗也是非常大的
如果查询缓存有命中的查询结果, 查询语句就可以直接去查询缓存中取数据. 这个缓存机制是由一系列小缓存组成的. 比如表缓存, 记录缓存, key缓存, 权限缓存等
 </li> <li>Pluggable Stroage Engines : 存储引擎接口
存储引擎接口模块可以说是 MySQL 数据库中最有特色的一点了. 目前各种数据库产品中, 基本上只有 MySQL 可以实现其底层数据存储引擎的插件式管理. 这个模块实际上只是一个抽象类, 但正是因为它成功地将各种数据处理高度抽象化, 才成就了今天 MySQL 可插拔存储引擎的特色.
从图中还可以看出, MySQL区别于其他数据库的最重要的特点就是其插件式的表存储引擎. MySQL插件式的存储引擎架构提供了一系列标准的管理和服务支持, 这些标准与存储引擎本身无关, 可能是每个数据库系统本身都必需的, 如SQL分析器和优化器等, 而存储引擎是底层物理结构的实现, 每个存储引擎开发者都可以按照自己的意愿来进行开发.
 
<strong>注意 : 存储引擎是基于表的, 而不是数据库</strong></li></ol> <blockquote><p>层解</p></blockquote> <ol><li>连接层
最上面是一些客户端和连接服务, 包含本地 sock 通信和大多数基于客户端/服务端工具实现的类似于 tcp/ip 的通信. 主要完成一些类似于连接处理, 授权认证及相关的安全方案. 在该层上引入了线程池的概念, 为通过认真安全接入的客户端提供线程, 同样在该层上可以实现基于 SSL 的安全链接, 服务器也会为安全接入的每个客户端验证它所具有的操作权限
 </li> <li>服务层
第二层架构主要完成主要的核心服务功能, 如 sql 接口, 并完成缓存的查询, sql 的分析和优化及部分内置函数的执行. 所有跨存储引擎的功能也在这一层实现, 如过程, 函数等. 在这层, 服务器会解析查询并创建相应的内部解析树, 并对其完成相应的优化如确定查询表的顺序, 是否利用索引等, 最后生成相应的执行操作, 如果是 select 语句, 服务器还会查询内部的缓存, 如果缓存空间够大, 这样在解决大量读操作的环境中能很好的提升系统的性能
 </li> <li>引擎层
存储引擎层, 存储引擎真正的负责了 MySQL 中数据的存储和提取, 服务器通过 API 与存储引擎进行通信, 不同的存储引擎具有不同的功能, 这样我们可以根据自己的实际需求进行选取, 主要是 MyLSAM 和 InnoDB
 </li> <li>存储层
数据存储层, 主要是将数据存储在运行于裸设备的文件系统之上, 并完成于存储系统的交互
 </li></ol> <blockquote><p>MySQL 存储引擎</p></blockquote> <p>查看命令
<code>show engines;</code> <img src="https://typora-oss.yixihan.chat//img/202210302212669.png" alt="1"></p> <p>查看 mysql 当前的默认存储引擎
<code>show variables like '%storage_engine';</code></p> <p><img src="https://typora-oss.yixihan.chat//img/202210302212538.png" alt="1"></p> <blockquote><p>MyLSAM 和 InnoDB</p></blockquote> <p><img src="https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/MyIn.bmp" alt="1"></p> <h2 id="索引优化分析"><a href="#索引优化分析" class="header-anchor">#</a> 索引优化分析</h2> <h3 id="常见通用的-join-查询"><a href="#常见通用的-join-查询" class="header-anchor">#</a> 常见通用的 join 查询</h3> <h4 id="sql-执行顺序"><a href="#sql-执行顺序" class="header-anchor">#</a> sql 执行顺序</h4> <blockquote><p>手写</p></blockquote> <p><img src="https://typora-oss.yixihan.chat//img/202210302212292.png" alt="1"></p> <blockquote><p>机读</p></blockquote> <p><img src="https://typora-oss.yixihan.chat//img/202210302212390.png" alt="1"></p> <blockquote><p>总结</p></blockquote> <p><img src="https://typora-oss.yixihan.chat//img/202210302212935.png" alt="1"></p> <h4 id="join-图"><a href="#join-图" class="header-anchor">#</a> join 图</h4> <p><img src="https://typora-oss.yixihan.chat//img/202210302212711.png" alt="1"></p> <h4 id="代码"><a href="#代码" class="header-anchor">#</a> 代码</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>use test1<span class="token punctuation">;</span>

create table tbl_dept <span class="token punctuation">(</span>
    <span class="token function">id</span> INT<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> not null auto_increment,
    deptName varchar<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> default null,
    locAdd varchar<span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> default null,
    PRIMARY KEY <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> INNODB AUTO_INCREMENT <span class="token operator">=</span> <span class="token number">1</span> DeFAULT CHARSET <span class="token operator">=</span> utf8<span class="token punctuation">;</span>

create table tbl_emp <span class="token punctuation">(</span>
    <span class="token function">id</span> INT<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> not null auto_increment,
    name varchar<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> default null,
    deptId INT<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> default null,
    primary key <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    <span class="token comment"># CONSTRAINT fk_dept_id FOREIGN KEY (deptId) REFERENCES tbl_dept(id)</span>
<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> INNODB AUTO_INCREMENT <span class="token operator">=</span> <span class="token number">1</span> DeFAULT CHARSET <span class="token operator">=</span> utf8<span class="token punctuation">;</span>

insert into tbl_dept<span class="token punctuation">(</span>deptName, locAdd<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span><span class="token string">'RD'</span>, <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into tbl_dept<span class="token punctuation">(</span>deptName, locAdd<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span><span class="token string">'HR'</span>, <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into tbl_dept<span class="token punctuation">(</span>deptName, locAdd<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span><span class="token string">'MK'</span>, <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into tbl_dept<span class="token punctuation">(</span>deptName, locAdd<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span><span class="token string">'MIS'</span>, <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into tbl_dept<span class="token punctuation">(</span>deptName, locAdd<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span><span class="token string">'FD'</span>, <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

insert into tbl_emp<span class="token punctuation">(</span>name, deptId<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span><span class="token string">'z3'</span>, <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into tbl_emp<span class="token punctuation">(</span>name, deptId<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span><span class="token string">'z4'</span>, <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into tbl_emp<span class="token punctuation">(</span>name, deptId<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span><span class="token string">'z5'</span>, <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

insert into tbl_emp<span class="token punctuation">(</span>name, deptId<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span><span class="token string">'w5'</span>, <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into tbl_emp<span class="token punctuation">(</span>name, deptId<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span><span class="token string">'w6'</span>, <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

insert into tbl_emp<span class="token punctuation">(</span>name, deptId<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span><span class="token string">'s7'</span>, <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

insert into tbl_emp<span class="token punctuation">(</span>name, deptId<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span><span class="token string">'s8'</span>, <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

insert into tbl_emp<span class="token punctuation">(</span>name, deptId<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span><span class="token string">'s9'</span>, <span class="token number">51</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment"># 单表查询 tbl_dept</span>
<span class="token keyword">select</span> * from tbl_dept<span class="token punctuation">;</span>

<span class="token comment"># 单表查询 tbl_emp</span>
<span class="token keyword">select</span> * from tbl_emp<span class="token punctuation">;</span>

<span class="token comment"># 笛卡尔乘积</span>
<span class="token keyword">select</span> * from tbl_emp, tbl_dept<span class="token punctuation">;</span>

<span class="token comment"># 情况一</span>
<span class="token keyword">select</span> * from tbl_emp te <span class="token function">join</span> tbl_dept td on td.id <span class="token operator">=</span> te.deptId<span class="token punctuation">;</span>

<span class="token comment"># 情况二</span>
<span class="token keyword">select</span> * from tbl_emp te left <span class="token function">join</span> tbl_dept td on td.id <span class="token operator">=</span> te.deptId<span class="token punctuation">;</span>

<span class="token comment"># 情况三</span>
<span class="token keyword">select</span> * from tbl_emp te right <span class="token function">join</span> tbl_dept td on td.id <span class="token operator">=</span> te.deptId<span class="token punctuation">;</span>

<span class="token comment"># 情况四</span>
<span class="token keyword">select</span> * from tbl_emp te left <span class="token function">join</span> tbl_dept td on te.deptId <span class="token operator">=</span> td.id where td.id is null<span class="token punctuation">;</span>

<span class="token comment"># 情况五</span>
<span class="token keyword">select</span> * from tbl_emp te right <span class="token function">join</span> tbl_dept td on te.deptId <span class="token operator">=</span> td.id where te.deptId is null<span class="token punctuation">;</span>

<span class="token comment"># full join MySQL不支持</span>
<span class="token comment"># 情况六</span>
<span class="token comment"># select * from tbl_emp te full join tbl_dept td on te.deptId = td.id;</span>

<span class="token comment"># 情况七</span>
<span class="token comment"># select * from tbl_emp te full join tbl_dept td on te.deptId = td.id where td.id is null and te.deptId is null;</span>

<span class="token comment"># 方式一 : union</span>
<span class="token comment"># 情况六</span>
<span class="token keyword">select</span> * from tbl_emp te left <span class="token function">join</span> tbl_dept td on td.id <span class="token operator">=</span> te.deptId
union
<span class="token keyword">select</span> * from tbl_emp te right <span class="token function">join</span> tbl_dept td on te.deptId <span class="token operator">=</span> td.id<span class="token punctuation">;</span>

<span class="token comment"># 情况七</span>
Explain <span class="token keyword">select</span> * from tbl_emp te left <span class="token function">join</span> tbl_dept td on td.id <span class="token operator">=</span> te.deptId where td.id is null
union
<span class="token keyword">select</span> * from tbl_emp te right <span class="token function">join</span> tbl_dept td on te.deptId <span class="token operator">=</span> td.id where te.deptId is null<span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br></div></div><h3 id="索引"><a href="#索引" class="header-anchor">#</a> 索引</h3> <h4 id="简介"><a href="#简介" class="header-anchor">#</a> 简介</h4> <blockquote><p>概念</p></blockquote> <p>MySQL 官方对索引的定义为 : 索引 (index) 是帮助 MySQL 高效获取数据的<strong>数据结构</strong></p> <p>可以将其简单理解为 : ==排好序的快速查找数据结构==</p> <p><img src="https://typora-oss.yixihan.chat//img/202210302214729.png" alt="1"></p> <p>结论 : 数据本身之外,数据库还维护着一个满足特定查找算法的数据结构，这些数据结构以某种方式指向数据, 这样就可以在这些数据结构的基础上实现高级查找算法,这种数据结构就是索引。</p> <p>一般来说索引本身也很大，不可能全部存储在内存中，因此索引往往以文件形式存储在硬盘上</p> <p>我们平时所说的索引，如果没有特别指明，都是指==B树== (多路搜索树，并不一定是二叉树) 结构组织的索引</p> <p>其中聚集索引, 次要索引, 覆盖索引, 复合索引, 前缀索引, 唯一索引默认都是使用 B+ 树索引, 统称索引. 当然, 除了 B+ 树这种类型的索引之外, 还有哈希索引 (hash index) 等。
 </p> <blockquote><p>优势</p></blockquote> <ul><li>类似于大学图书馆建书目索引, 提高数据的检索效率, 降低了数据库的 IO 成本</li> <li>通过索引列对数据进行排序, 降低数据排序成本, 降低了 CPU 的消耗</li></ul> <blockquote><p>劣势</p></blockquote> <ul><li>实际上索引也是一张表, 该表保存了主键和索引字段, 并指向实体表的记录, 索引索引列也是要占用空间的</li> <li>虽然索引大大提高了查询速度, 同时却会降低更新表的速度, 如果对表 insert update delete, 将会消耗更多的时间, 因为更新表时, MySQL 不仅要修改数据, 还要修改索引列</li> <li>索引只是提高效率的一个因素, 如果你的 MySQL 有大数据量的表, 就需要花时间研究建立优秀的索引, 或优化查询语句
 </li></ul> <h4 id="mysql-索引分类"><a href="#mysql-索引分类" class="header-anchor">#</a> MySQL 索引分类</h4> <blockquote><p>单值索引</p></blockquote> <p>即一个索引值包含单个列, 一个表可以有多个单列索引</p> <p><strong>注意 : 建议一张表索引不要超过5个, 优先考虑复合索引</strong></p> <blockquote><p>唯一索引</p></blockquote> <p>索引列的值必须唯一, 但是允许有空值 (unique)
 </p> <blockquote><p>复合索引</p></blockquote> <p>即一个索引包含多个列 (最常使用)
 </p> <h4 id="索引的基本语法"><a href="#索引的基本语法" class="header-anchor">#</a> 索引的基本语法</h4> <blockquote><p>创建</p></blockquote> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment"># alter 方式</span>
<span class="token comment"># 该语句添加一个主键, 这意味着索引值必须是唯一的</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> tbl_name <span class="token keyword">add</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>column_list<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 这条语句创建索引的值必须是唯一的 (除了 null, null 可能会出现多次)</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> tbl_name <span class="token keyword">add</span> <span class="token keyword">unique</span> index_name <span class="token punctuation">(</span>column_list<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 添加普通索引, 索引值可出现多次</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> tbl_name <span class="token keyword">add</span> <span class="token keyword">index</span> index_name <span class="token punctuation">(</span>column_list<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 该语句指定类索引为 fulltext, 用于全文索引</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> tbl_name <span class="token keyword">add</span> fulltext index_name <span class="token punctuation">(</span>column_list<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># create 方式</span>
<span class="token comment"># 如果是 CHAR, VARCHAR 类型，length 可以小于字段实际长度；</span>
<span class="token comment"># 如果是 BLOB 和 TEXT 类型，必须指定 length。</span>
<span class="token keyword">CREATE</span> <span class="token punctuation">[</span><span class="token keyword">UNIQUE</span><span class="token punctuation">]</span> <span class="token keyword">INDEX</span>  indexName <span class="token keyword">ON</span> mytable<span class="token punctuation">(</span>columnname<span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p></p> <blockquote><p>删除</p></blockquote> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">drop</span> <span class="token keyword">index</span> <span class="token punctuation">[</span>indexName<span class="token punctuation">]</span> <span class="token keyword">on</span> mytable<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p></p> <blockquote><p>查看</p></blockquote> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> table_name
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p></p> <h4 id="mysql-索引结构"><a href="#mysql-索引结构" class="header-anchor">#</a> MySQL 索引结构</h4> <ul><li>BTree 索引</li> <li>Hash 索引 (了解)</li> <li>full-text 全文索引 (了解)</li> <li>R-Tree 索引 (了解)</li></ul> <p></p> <h5 id="btree"><a href="#btree" class="header-anchor">#</a> BTree</h5> <p><img src="https://typora-oss.yixihan.chat//img/202210302214969.png" alt="1"></p> <ul><li><p>初始化介绍
一颗 b+ 树, 浅蓝色的块我们称之为一个磁盘块, 可以看到每个磁盘块包含了几个数据项 (深蓝色显示) 和指针 (黄色显示). 如磁盘块 1 包含了数据项 17 - 35, 包含指针 P1, P2, P3
P1 表示小于 17 的磁盘块, P2 表示在 17 - 35 之间的磁盘块, P3 表示大于 35 的磁盘块
 
<strong>真实的数据存在于叶子节点</strong>, 即 3, 5, 9, 10 ...
<strong>非叶子节点不存储真实的数据</strong>, 只存储指引搜索方法的数据项, 如 17, 35 并不存在与数据表中
 </p></li> <li><p>查找过程
如果要查找数据项 20, 那么首先会把磁盘块 1 由磁盘加载到内存, 此时发生一次 IO, 在内充中用二分法查找确定 29 在 17 和 35 之间, 锁定磁盘块 1 的 P2 指针, 内存时间非常短 (相较于磁盘的 IO), 可以忽略不急, 通过磁盘块 1 的 P2 指针指向的磁盘地址, 将磁盘块 3 加载到内存中吗发生第二次 IO, 确认 29 在 26 和 30 之间, 锁定磁盘块的 P2 指针, 通过指针将磁盘块 8 加载到内存, 发生第三次 IO, 同时在内存中做二分查找到 29, 结束查询, 总计 3 次 IO
 </p></li></ul> <p>Btree索引 (或Balanced Tree), 是一种很普遍的数据库索引结构, oracle 默认的索引类型 (本文也主要依据 oracle 来讲). 其特点是定位高效  利用率高  自我平衡, 特别适用于高基数字段, 定位单条或小范围数据非常高效. 理论上, 使用 Btree 在亿条数据与 100 条数据中定位记录的花销相同
 </p> <p>数据结构利用率高, 定位高效
Btree索引的数据结构如下 :
<img src="https://typora-oss.yixihan.chat//img/202210302214987.png" alt="1">
结构看起来 Btree 索引与 Binary Tree 相似, 但在细节上有所不同</p> <p>Btree 索引的几个主要特点 :</p> <ul><li>树形结构 : 由根节 (root), 分支 (branches), 叶 (leaves)三级节点组成, 其中分支节点可以有多层</li> <li>多分支结构 : 与 binary tree 不相同的是, btree 索引中单 root/branch 可以有多个子节点 (超过2个)</li> <li>双向链表 : 整个叶子节点部分是一个双向链表 (后面会描述这个设计的作用)</li> <li>单个数据块中包括多条索引记录</li></ul> <p></p> <blockquote><p>结构上Btree与Binary Tree的区别</p></blockquote> <p>结构上 Btree 与 Binary Tree 的区别, 在于 binary 中每节点代表一个数值, 而 balanced 中 root 和 Btree 节点中记录了多条 &quot;值范围&quot; 条目 (如 : [60-70][70-80]), 这些 &quot;值范围&quot; 条目分别指向在其范围内的叶子节点. 即 root 与 branch 可以有多个分支, 而不一定是两个, 对数据块的利用率更高</p> <p>在 Leaf 节点中, 同样也是存放了多条索引记录, 这些记录就是具体的索引列值, 和与其对应的 rowid. 另外, 在叶节点层上, 所有的节点在组成了一个双向链表</p> <p>了解基本结构后，下图展示定位数值 82 的过程：</p> <p><img src="https://typora-oss.yixihan.chat//img/202210302214036.png" alt="1"></p> <p>演算如下</p> <ul><li>读取 root 节点, 判断 82 大于在 0 - 120 之间, 走左边分支</li> <li>读取左边 branch 节点, 判断 82 大于 80 且小于等于 120, 走右边分支</li> <li>读取右边 leaf 节点, 在该节点中找到数据 82 及对应的 rowid</li> <li>使用 rowid 去物理表中读取记录数据块 (如果是 count 或者只 select rowid, 则最后一次读取不需要)</li></ul> <p>在整个索引定位过程中，数据块的读取只有 3 次. 既三次 I/O 后定位到 rowid</p> <p>而由于 Btree 索引对结构的利用率很高, 定位高效. 当 1 千万条数据时, Btree 索引也是三层结构 (依稀记得亿级数据才是 3 层与 4 层的分水岭). 定位记录仍只需要三次 I/O, 这便是开头所说的, 100 条数据和 1 千万条数据的定位, 在 btree 索引中的花销是一样的
 </p> <blockquote><p>平衡扩张</p></blockquote> <p>除了利用率高, 定位高效外, Btree 的另一个特点是能够永远保持平衡, 这与它的扩张方式有关.  (unbalanced 和 hotspot 是两类问题, 之前我一直混在一起), 先描述下 Btree 索引的扩张方式 :</p> <p>新建一个索引, 索引上只会有一个 leaf 节点, 取名为 Node A, 不断的向这个 leaf 节点中插入数据后, 直到这个节点满, 这个过程如下图(绿色表示新建/空闲状态, 红色表示节点没有空余空间) :</p> <p><img src="https://typora-oss.yixihan.chat//img/202210302215316.png" alt="1"></p> <p>当 Node A 满之后, 我们再向表中插入一条记录, 此时索引就需要做拆分处理 : 会新分配两个数据块 NodeB &amp; C, 如果新插入的值大于当前最大值, 则将 Node A 中的值全部插入 Node B 中, 将新插入的值放到 Node C 中; 否则按照 5 - 5 比例, 将已有数据分别插入到 NodeB 与 C 中</p> <p>无论采用哪种分割方式, 之前的 leaf 节点 A, 将变成一个 root 节点, 保存两个范围条目, 指向 B 与 C , 结构如下图(按第一种拆分形式) :</p> <p><img src="https://typora-oss.yixihan.chat//img/202210302215889.png" alt="1"></p> <p>当 Node C 满之后, 此时 Node A 仍有空余空间存放条目, 所以不需要再拆分, 而只是新分配一个数据块 Node D, 将在 Node A 中创建指定到 Node D 的条目 :</p> <p><img src="https://typora-oss.yixihan.chat//img/202210302215501.png" alt="1"></p> <p>如果当根节点 Node A 也满了, 则需要进一步拆分 : 新建 Node E &amp; F &amp; G, 将 Node A 中范围条目拆分到 E &amp; F 两个节点中, 并建立 E &amp; F 到 BCD 节点的关联, 向 Node G 插入索引值. 此时 E &amp; F 为 branch 节点, G 为 leaf 节点, A 为 Root 节点 :</p> <p><img src="https://typora-oss.yixihan.chat//img/202210302215662.png" alt="1"></p> <p>在整个扩张过程中, Btree 自身总能保持平衡, Leaf 节点的深度能一直保持一致
 </p> <h4 id="何时该建索引"><a href="#何时该建索引" class="header-anchor">#</a> 何时该建索引 ?</h4> <blockquote><p>何时该建索引</p></blockquote> <ul><li>主键自动建立唯一索引</li> <li>频繁作为查询的条件的字段应该创建索引</li> <li>查询中与其他表关联的字段，外键关系建立索引</li> <li>频繁更新的字段不适合创建索引
<ul><li>因为每次更新不单单是更新了记录还会更新索引，加重IO负担</li></ul></li> <li>Where条件里用不到的字段不创建索引</li> <li>单间/组合索引的选择问题, who ? (在高并发下倾向创建组合索引)</li> <li>查询中排序的字段，排序字段若通过索引去访问将大大提高排序的速度</li> <li>查询中统计或者分组字段</li></ul> <p></p> <blockquote><p>何时不该建索引</p></blockquote> <ul><li>表记录太少</li> <li>经常增删改的表</li> <li>数据重复且分布平均的表字段, 因此应该只为经常查询和经常排序的数据列建立索引</li> <li>如果某个数据列包含许多重复的内容, 为它建立索引就没有太大的实际效果</li></ul> <p></p> <h3 id="性能分析"><a href="#性能分析" class="header-anchor">#</a> 性能分析</h3> <blockquote><p>MySQL Query Optimizer</p></blockquote> <p>MySQL 中有专门赋值优化 select 语句的优化器模块, 即 MySQL Query Optimizer</p> <p>主要功能 : 通过计算分析系统中收集到的统计信息, 为客户端请求的 Query 提供它认为最优的执行计划 (这部分也许是最耗时间的)</p> <p>当客户端向 MySQL 请求一条 Query, 命令解析器模块完成请求分类, 区别出是 select 并转发给MySQL Query Optimizer 时, MySQL Query Optimizer 首先会对整条 query 语句进行优化, 处理掉一些常量表达式的预算, 直接转换成常量值, 并对 query 中查询条件进行简化和转换, 然后分析 query 中的 hint 信息 (如果有的话), 看显示 hint 信息是否可以完全确定该 query 的执行计划, 如果没有 hint 或 hint 信息还不足完全确定执行计划, 则会读取所涉及对象的统计信息, 根据 query 进行写相应的计算分析, 然后再得出最后的执行计划
 </p> <blockquote><p>MySQL 常见瓶颈</p></blockquote> <ul><li>CPU : CPU 在饱和的时候一般发生在数据装入在内存或从磁盘上读取数据时候</li> <li>IO : 磁盘 I/O 瓶颈发生在装入数据远大于内存容量时</li> <li>服务器硬件的性能瓶颈 : top, free, iostat 和 vmstat 来查看系统的性能状态</li></ul> <p></p> <h4 id="explain"><a href="#explain" class="header-anchor">#</a> explain</h4> <blockquote><p>概念</p></blockquote> <p>使用 explain 关键字可以模拟优化器执行 sql 语句，从而知道 MySQL 是如何处理你的 sql 语句的, 分析你的查询语句或是结构的性能瓶颈
 </p> <blockquote><p>explain 的作用</p></blockquote> <ul><li>获取表的读取顺序 (id)</li> <li>获取数据读取操作的操作类型 (type)</li> <li>获取哪些索引可以使用 (possible_key)</li> <li>获取哪些索引被实际使用 (key)</li> <li>获取表之间的引用 (ref)</li> <li>获取每张表有多少行被优化 (rows)</li></ul> <p></p> <blockquote><p>explain 使用语法</p></blockquote> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">explain</span> <span class="token operator">+</span> <span class="token keyword">sql</span> 语句<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p></p> <p>执行计划包含的信息
<img src="https://typora-oss.yixihan.chat//img/202210302215670.png" alt="1"></p> <h5 id="explain-字段解析"><a href="#explain-字段解析" class="header-anchor">#</a> explain 字段解析</h5> <blockquote><p>id ☆</p></blockquote> <p>select 查询的序列号, 包含一组数字, 表示查询中执行 select 子句或操作表的顺序</p> <p>id 分为三种情况 :</p> <ul><li><p>id 相同 : 执行顺序由上至下
<img src="https://typora-oss.yixihan.chat//img/202210302215191.png" alt="1"></p></li> <li><p>id 不同 : 如果是子查询, id 的序号会递增, id 值越大优先级越高, 越先被执行
<img src="https://typora-oss.yixihan.chat//img/202210302215720.png" alt="1"></p></li> <li><p>id 相同不同, 同时存在
<img src="https://typora-oss.yixihan.chat//img/202210302215109.png" alt="1"></p></li></ul> <blockquote><p>select_type</p></blockquote> <p>select_type 分为以下几种</p> <ul><li>SIMPLE : 简单的 select 查询, 查询中不包含子查询或者 union</li> <li>PRIMARY : 查询中若包含任何复杂的子部分, 最外层查询则被标记为 PRIMARY</li> <li>SUBQUERY : 在 select 或者 where 列表中包含了子查询</li> <li>DERIUED : 在 from 列表中包含的子查询被标记为 DERIVED(衍生), MySQL 会递归执行这些子查询, 把结果放在临时表里</li> <li>UNION :
若第二个 select 出现在 union 之后, 则被标记为 UNION;
若 union 包含在 FROM 子句的子查询中, select : DERIVED</li> <li>UNION RESULT : 从 union 表获取结果的 select</li></ul> <p></p> <blockquote><p>table</p></blockquote> <p>显示这一行的数据是关于哪张表的
 </p> <blockquote><p>partitions</p></blockquote> <p></p> <blockquote><p>type ☆</p></blockquote> <p>大致分为以下几种 :</p> <ul><li>ALL</li> <li>index</li> <li>range</li> <li>ref</li> <li>eq_ref</li> <li>const, system</li> <li>Null</li></ul> <p></p> <p>type 显示的是访问类型, 是较为重要的一个值, 结果值从好到坏依次是 :</p> <p>全面对比 :
system &gt; const &gt; eq_ref &gt; ref &gt; fulltest &gt; ref_or_not &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range &gt; index &gt; All</p> <p>常见对比 :
system &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; All</p> <p><strong>一般来说, 得保证查询至少达到 range 级别, 最好能达到 ref</strong></p> <p>常见 type 类型详解 :</p> <ul><li>system :
表只有一行记录 (等于系统表), 这是 const 类型的特例, 平时不会出现, 这个可以忽略不计
 </li> <li>const
表示通过索引一次就找到了, const 用于比较 primary key 或者 unique 索引. 因为只匹配一行数据, 所以很快. 如将主键至于 where 列表中, MySQL 就能将该查询转换为一个常量
 </li> <li>eq_ref
唯一性索引, 对于每个索引键, 表中只有一条记录与之匹配, 常见于主键或唯一索引扫描
 </li> <li>ref
非唯一索引扫描, 返回匹配某个单独值的所有行
本质上也是一种索引访问, 它返回所有匹配某个单独值的行. 然而, 它可能会找到多个符合条件的行, 所以他应该属于查找和扫描的混合体
 </li> <li>range
只检索给定范围的行, 使用一个索引来选择行. key 列显示使用了哪个索引
一般就是在你的 where 语句中出现了 between, &lt;, &gt;, in 等的查询
这种范围扫描索引扫描比全表扫描要好, 因为他只需要开始索引的某一点, 而结束于另一点, 不用扫描全部索引
 </li> <li>index
Full Index Scan
index 与 ALL 区别为 index 类型只遍历索引树. 这通常比 ALL 快, 因为索引文件通常比数据文件小
(也就是说虽然 all 和 index 都是读全表, 但 index 是从索引中读取的, 而 all 是从硬盘中读的)
 </li> <li>all
FullTable Scan, 将遍历全表以找到匹配的行
 </li></ul> <blockquote><p>possible_key</p></blockquote> <p>显示可能应用在这张表中的索引, 一个或多个
查询涉及的字段上若存在索引, 则该索引将被列出, 但不一定被查询实际使用
 </p> <blockquote><p>key ☆</p></blockquote> <p>实际使用的索引, 如果为 null 则没有使用索引
查询中若使用了覆盖索引, 则索引和查询的 select 字段重叠, 此时 Extra 显示 Using index
 </p> <blockquote><p>key_len</p></blockquote> <p>表示索引中使用的字节数, 可通过该列计算查询中使用的索引的长度
在不损失精确性的情况下, 长度越短越好
key_len 显示的值为索引最大可能长度, 并非实际使用长度, 即 <strong>key_len 是根据表定义计算而得, 不是通过表内检索出的</strong></p> <blockquote><p>ref ☆</p></blockquote> <p>显示索引那一列被使用了, 如果可能的话, 是一个常数. 那些列或常量被用于查找索引列上的值
 
<img src="https://typora-oss.yixihan.chat//img/202210302215072.png" alt="1"></p> <blockquote><p>rows ☆</p></blockquote> <p>根据表统计信息及索引选用情况, 大致估算出找到所需的记录所需要读取的行数, 越少越好
 
<img src="https://typora-oss.yixihan.chat//img/202210302215987.png" alt="1"></p> <blockquote><p>filtered</p></blockquote> <p></p> <blockquote><p>Extra ☆</p></blockquote> <p>包含不适合在其他列中显示但十分重要的额外信息
大致分为以下几种 :</p> <ul><li><strong>Using filesort (九死一生)</strong>
说明 MySQL 会对数据使用一个外部的索引排序, 而不是按照表内的索引顺序进行读取
MySQL 中无法利用索引完成排序操作成为 &quot;文件排序&quot;
 
<img src="https://typora-oss.yixihan.chat//img/202210302215770.png" alt="1"></li> <li><strong>Using temporary (十死无生)</strong>
使用了临时表保存中间结果, MySQL 在对查询结果排序时使用临时表.
常见于排序 order by 和分组查询 group by
 
<img src="https://typora-oss.yixihan.chat//img/202210302215070.png" alt="1"></li> <li><strong>Using index (好 !)</strong>
表示相应的 select 操作中使用了覆盖索引 (Coveing Index), 避免访问了表的数据行, 效率不错 !
如果同时出现 using where, 表明索引被用来执行索引键值的查找
如果没有同时出现 using where, 表面索引用来读取数据而非执行查找动作
 
<img src="https://typora-oss.yixihan.chat//img/202210302215632.png" alt="1"></li> <li>Using where
表面使用了where过滤
 </li> <li>Using join buffer
使用了连接缓存
 </li> <li>impossible where
where 子句的值总是 false, 不能用来获取任何元组
 
<img src="https://typora-oss.yixihan.chat//img/202210302215908.png" alt="1"></li> <li>select tables optimized away
在没有 group by 子句的情况下, 基于索引优化 MIN/MAX 操作或者对于 MyISAM 存储引擎优化COUNT(*) 操作, 不必等到执行阶段再进行计算, 查询执行计划生成的阶段即完成优化.
 </li> <li>distinct
优化 distinct, 在找到第一匹配的元组后即停止找同样值的工作
 </li></ul> <h3 id="索引优化"><a href="#索引优化" class="header-anchor">#</a> 索引优化</h3> <h4 id="索引分析"><a href="#索引分析" class="header-anchor">#</a> 索引分析</h4> <h5 id="单表分析"><a href="#单表分析" class="header-anchor">#</a> 单表分析</h5> <blockquote><p>代码</p></blockquote> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> article <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
    author_id <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    category_id <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    views <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    comments <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    title <span class="token keyword">VARBINARY</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    content <span class="token keyword">TEXT</span> <span class="token operator">not</span> <span class="token boolean">null</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">truncate</span> <span class="token keyword">table</span> article<span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> article<span class="token punctuation">(</span>author_id<span class="token punctuation">,</span> category_id<span class="token punctuation">,</span> views<span class="token punctuation">,</span> comments<span class="token punctuation">,</span> title<span class="token punctuation">,</span> content<span class="token punctuation">)</span> <span class="token keyword">VALUES</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> article<span class="token punctuation">;</span>

<span class="token comment"># 查询 category_id 为 1, 且 comments 大于 1 的情况下, views 最多的 article_id</span>
<span class="token comment"># type = ALL, key = null, ref = null, rows = 3, Extra 包含 Using filesort</span>
<span class="token comment"># 结论, type = ALL 且 Extra 出现了 Using filesort, 需要优化</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span> author_id <span class="token keyword">from</span> article <span class="token keyword">where</span> category_id <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">and</span> comments <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token keyword">order</span> <span class="token keyword">by</span> views <span class="token keyword">DESC</span> <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment"># 查看表的索引</span>
<span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> article<span class="token punctuation">;</span>

<span class="token comment"># 开始优化</span>
<span class="token comment"># 1.1 建立索引 + 删除索引</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> article <span class="token keyword">add</span> <span class="token keyword">index</span> idx_article_ccv<span class="token punctuation">(</span>category_id<span class="token punctuation">,</span> comments<span class="token punctuation">,</span> views<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> article<span class="token punctuation">;</span>

<span class="token comment"># type = range, key = idx_article_ccv, ref = null rows = 3 Extra 包含 Using index condition; Using filesort</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span> author_id <span class="token keyword">from</span> article <span class="token keyword">where</span> category_id <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">and</span> comments <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token keyword">order</span> <span class="token keyword">by</span> views <span class="token keyword">DESC</span> <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment"># Extra 包含 Using where</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span> author_id <span class="token keyword">from</span> article <span class="token keyword">where</span> category_id <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">and</span> comments <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">order</span> <span class="token keyword">by</span> views <span class="token keyword">DESC</span> <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">#</span>
<span class="token comment">/*
 结论 :
 type 变成了 range, 这是可以忍受的, 但是 Extra 中使用 Using filesort, 这是无法接受的
 但是我们已经建立了索引, 为啥没用呢 ?
 这是因为按照 BTree 索引的工作原理,
 先排序 category_id, 如果遇到相同的 category_id, 则再排序 comments, 如果遇到相同的 comments, 则再排序 views
 当 comments 字段在联合索引中处于中间位置时,
 因 comments &gt; 1 条件是一个范围值 (所谓 range),
 MySQL 无法利用索引再对后面的 views 部分进行检索, 级 range 类型查询字段后面的索引无效
 */</span>


<span class="token comment"># 删除索引</span>
<span class="token keyword">drop</span> <span class="token keyword">index</span> idx_article_ccv <span class="token keyword">on</span> article<span class="token punctuation">;</span>

<span class="token comment"># 1.2 建立索引</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> article <span class="token keyword">add</span> <span class="token keyword">index</span> idx_article_cv<span class="token punctuation">(</span>category_id<span class="token punctuation">,</span> views<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> article<span class="token punctuation">;</span>

<span class="token comment"># type = ref, key = idx_article_cv, ref = const, rows = 2 Extra 包含 Using where 完美!</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span> author_id <span class="token keyword">from</span> article <span class="token keyword">where</span> category_id <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">and</span> comments <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token keyword">order</span> <span class="token keyword">by</span> views <span class="token keyword">DESC</span> <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment"># 删除索引</span>
<span class="token keyword">drop</span> <span class="token keyword">index</span> idx_article_cv <span class="token keyword">on</span> article<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><h5 id="双表分析"><a href="#双表分析" class="header-anchor">#</a> 双表分析</h5> <blockquote><p>代码</p></blockquote> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> class <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
    card <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> book <span class="token punctuation">(</span>
    bookid <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
    card <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>bookid<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 执行多次, 20+</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 两表均 24 行数据</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> class<span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> book<span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> book b <span class="token keyword">inner</span> <span class="token keyword">join</span> class c <span class="token keyword">on</span> b<span class="token punctuation">.</span>card <span class="token operator">=</span> c<span class="token punctuation">.</span>card<span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> book b <span class="token keyword">left</span> <span class="token keyword">join</span> class c <span class="token keyword">on</span> b<span class="token punctuation">.</span>card <span class="token operator">=</span> c<span class="token punctuation">.</span>card<span class="token punctuation">;</span>

<span class="token comment"># 案例 : 下面开始 explain 分析</span>
<span class="token comment"># class : type = ALL, key = null, ref = null, rows = 24, Extra = null</span>
<span class="token comment"># book : type = ALL, key = null, ref = null, rows = 24, Extra = Using where; Using join buffer (Block Nested Loop)</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> class <span class="token keyword">left</span> <span class="token keyword">join</span> book <span class="token keyword">on</span> class<span class="token punctuation">.</span>card <span class="token operator">=</span> book<span class="token punctuation">.</span>card<span class="token punctuation">;</span>
<span class="token comment"># 结论 : Type = ALL, qie Extra 中有 Using join buffer (Block Nested Loop), 需要优化</span>


<span class="token comment"># 1.1 添加索引 book 表</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> book <span class="token keyword">add</span> <span class="token keyword">index</span> Y<span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> book<span class="token punctuation">;</span>

<span class="token comment"># class : type = ALL, key = null, ref = null, rows = 24, Extra = null</span>
<span class="token comment"># book : type = ref, key = Y, ref = test1.class.card, rows = 1, Extra = Using index</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> class <span class="token keyword">left</span> <span class="token keyword">join</span> book <span class="token keyword">on</span> class<span class="token punctuation">.</span>card <span class="token operator">=</span> book<span class="token punctuation">.</span>card<span class="token punctuation">;</span>

<span class="token keyword">drop</span> <span class="token keyword">index</span> Y <span class="token keyword">on</span> book<span class="token punctuation">;</span>

<span class="token comment"># 1.2 添加索引 class 表</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> class <span class="token keyword">add</span> <span class="token keyword">index</span> Y<span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> class<span class="token punctuation">;</span>

<span class="token comment"># 左连接</span>
<span class="token comment"># class : type = index, key = Y, ref = null, rows = 24, Extra = Using index</span>
<span class="token comment"># book : type = ALL, key = null, ref = null, rows = 24, Extra = Using where; Using join buffer (Block Nested Loop)</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> class <span class="token keyword">left</span> <span class="token keyword">join</span> book <span class="token keyword">on</span> class<span class="token punctuation">.</span>card <span class="token operator">=</span> book<span class="token punctuation">.</span>card<span class="token punctuation">;</span>

<span class="token comment"># 右连接</span>
<span class="token comment"># book : type = ALL, key = null, ref = null, rows = 24, Extra = null</span>
<span class="token comment"># class : type = ref, key = Y, ref = test1.class.card, rows = 1, Extra = Using index</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> class <span class="token keyword">right</span> <span class="token keyword">join</span> book <span class="token keyword">on</span> class<span class="token punctuation">.</span>card <span class="token operator">=</span> book<span class="token punctuation">.</span>card<span class="token punctuation">;</span>

<span class="token keyword">drop</span> <span class="token keyword">index</span> Y <span class="token keyword">on</span> class<span class="token punctuation">;</span>
<span class="token comment">/*
 结论 :
 可以看到第二行的 type 变成了 ref, rows 优化也比较明显
 这是由左连接特性决定的,
 left join 条件用于确定如何从右表搜索行, 左边一定都有
 所以右边是我们的关注点, 一定要建立索引
 同理
 right join 条件用于确定如何从左边搜索行, 右边一定都有
 所以左边是我们的关注点, 一定要建立索引
 */</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br></div></div><h5 id="三表分析"><a href="#三表分析" class="header-anchor">#</a> 三表分析</h5> <blockquote><p>代码</p></blockquote> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> phone <span class="token punctuation">(</span>
    phoneid <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unique</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
    card <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>phoneid<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">engine</span> <span class="token operator">=</span> <span class="token keyword">INNODB</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> phone<span class="token punctuation">;</span>

<span class="token comment"># 建立索引</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> phone <span class="token keyword">add</span> <span class="token keyword">index</span> Z<span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> class <span class="token keyword">add</span> <span class="token keyword">index</span> Y<span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> phone<span class="token punctuation">;</span>
<span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> class<span class="token punctuation">;</span>
<span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> book<span class="token punctuation">;</span>

<span class="token comment"># 删除索引</span>
<span class="token keyword">drop</span> <span class="token keyword">index</span> Y <span class="token keyword">on</span> class<span class="token punctuation">;</span>
<span class="token keyword">drop</span> <span class="token keyword">index</span> Z <span class="token keyword">on</span> phone<span class="token punctuation">;</span>

<span class="token comment"># 案例</span>
<span class="token comment"># book : type = ALL, key = null, ref = null, rows = 24, Extra = null</span>
<span class="token comment"># class : type = ALL, key = null, ref = null, rows = 24, Extra = Using where; Using join buffer (Block Nested Loop)</span>
<span class="token comment"># phone : type = ALL, key = null, ref = null, rows = 24, Extra = Using where; Using join buffer (Block Nested Loop)</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> book b <span class="token keyword">left</span> <span class="token keyword">join</span> class c <span class="token keyword">on</span> b<span class="token punctuation">.</span>card <span class="token operator">=</span> c<span class="token punctuation">.</span>card <span class="token keyword">left</span> <span class="token keyword">join</span> phone p <span class="token keyword">on</span> b<span class="token punctuation">.</span>card <span class="token operator">=</span> p<span class="token punctuation">.</span>card<span class="token punctuation">;</span>
<span class="token comment"># 需要优化</span>

<span class="token comment"># 1.1 建立索引, phone class</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> phone <span class="token keyword">add</span> <span class="token keyword">index</span> Z<span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> class <span class="token keyword">add</span> <span class="token keyword">index</span> Y<span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> phone<span class="token punctuation">;</span>
<span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> class<span class="token punctuation">;</span>

<span class="token comment"># book : type = ALL, key = null, ref = null, rows = 24, Extra = null</span>
<span class="token comment"># class : type = ref, key = Y, ref = test1.b.card, rows = 1, Extra = Using index</span>
<span class="token comment"># phone : type = ref, key = Z, ref = test1.b.card, rows = 1, Extra = Using index</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> book b <span class="token keyword">left</span> <span class="token keyword">join</span> class c <span class="token keyword">on</span> b<span class="token punctuation">.</span>card <span class="token operator">=</span> c<span class="token punctuation">.</span>card <span class="token keyword">left</span> <span class="token keyword">join</span> phone p <span class="token keyword">on</span> b<span class="token punctuation">.</span>card <span class="token operator">=</span> p<span class="token punctuation">.</span>card<span class="token punctuation">;</span>

<span class="token comment">/*
 结论 :
    后两行的 type 都是 ref 且总 rows 优化很好, 效果不错, 隐藏索引最好设置在需要经常查询的字段中

 结论 : join 语句的优化
    1. 尽可能减少 join 语句中的 NestedLoop 的循环总次数 : &quot;永远用小结果集驱动大的结果集&quot;
    2. 优先优化 NestedLoop 的内存循环
    3. 保证 join 语句中被驱动表上 join 条件字段已经被索引
    4. 当无法保证被驱动表的 join 条件字段被索引且内存资源充足的前提下, 不要太吝啬 JoinBuffer 的设置
 */</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><h5 id="练习"><a href="#练习" class="header-anchor">#</a> 练习</h5> <blockquote><p>代码</p></blockquote> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> test03 <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
    c1 <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    c2 <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    c3 <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    c4 <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    c5 <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> test03<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> c3<span class="token punctuation">,</span> c4<span class="token punctuation">,</span> c5<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'a1'</span><span class="token punctuation">,</span> <span class="token string">'a2'</span><span class="token punctuation">,</span> <span class="token string">'a3'</span><span class="token punctuation">,</span> <span class="token string">'a4'</span><span class="token punctuation">,</span> <span class="token string">'a5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> test03<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> c3<span class="token punctuation">,</span> c4<span class="token punctuation">,</span> c5<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'b1'</span><span class="token punctuation">,</span> <span class="token string">'b2'</span><span class="token punctuation">,</span> <span class="token string">'b3'</span><span class="token punctuation">,</span> <span class="token string">'b4'</span><span class="token punctuation">,</span> <span class="token string">'b5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> test03<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> c3<span class="token punctuation">,</span> c4<span class="token punctuation">,</span> c5<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'c1'</span><span class="token punctuation">,</span> <span class="token string">'c2'</span><span class="token punctuation">,</span> <span class="token string">'c3'</span><span class="token punctuation">,</span> <span class="token string">'c4'</span><span class="token punctuation">,</span> <span class="token string">'c5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> test03<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> c3<span class="token punctuation">,</span> c4<span class="token punctuation">,</span> c5<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'d1'</span><span class="token punctuation">,</span> <span class="token string">'d2'</span><span class="token punctuation">,</span> <span class="token string">'d3'</span><span class="token punctuation">,</span> <span class="token string">'d4'</span><span class="token punctuation">,</span> <span class="token string">'d5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> test03<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> c3<span class="token punctuation">,</span> c4<span class="token punctuation">,</span> c5<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'e1'</span><span class="token punctuation">,</span> <span class="token string">'e2'</span><span class="token punctuation">,</span> <span class="token string">'e3'</span><span class="token punctuation">,</span> <span class="token string">'e4'</span><span class="token punctuation">,</span> <span class="token string">'e5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test03<span class="token punctuation">;</span>

<span class="token comment"># 建立索引</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> test03 <span class="token keyword">add</span> <span class="token keyword">index</span> idx_create_c1234<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> c3<span class="token punctuation">,</span> c4<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> test03<span class="token punctuation">;</span>

<span class="token comment"># 问题 : 我们创建了复合索引 idx_test_c1234, 根据以下 sql 分析下索引使用情况</span>

<span class="token comment"># type = ref key_len = 31 ref = const</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test03 <span class="token keyword">where</span> c1 <span class="token operator">=</span> <span class="token string">'a1'</span><span class="token punctuation">;</span>

<span class="token comment"># type = ref key_len = 62 ref = const, const</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test03 <span class="token keyword">where</span> c1 <span class="token operator">=</span> <span class="token string">'a1'</span> <span class="token operator">and</span> c2 <span class="token operator">=</span> <span class="token string">'a2'</span><span class="token punctuation">;</span>

<span class="token comment"># type = ref key_len = 93 ref = const, const, const</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test03 <span class="token keyword">where</span> c1 <span class="token operator">=</span> <span class="token string">'a1'</span> <span class="token operator">and</span> c2 <span class="token operator">=</span> <span class="token string">'a2'</span> <span class="token operator">and</span> c3 <span class="token operator">=</span> <span class="token string">'a3'</span><span class="token punctuation">;</span>

<span class="token comment"># type = ref key_len = 124 ref = const, const, const, const</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test03 <span class="token keyword">where</span> c1 <span class="token operator">=</span> <span class="token string">'a1'</span> <span class="token operator">and</span> c2 <span class="token operator">=</span> <span class="token string">'a2'</span> <span class="token operator">and</span> c3 <span class="token operator">=</span> <span class="token string">'a3'</span> <span class="token operator">and</span> c4 <span class="token operator">=</span> <span class="token string">'a4'</span><span class="token punctuation">;</span>



<span class="token comment"># type = ref key_len = 124 ref = const, const, const, const</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test03 <span class="token keyword">where</span> c1 <span class="token operator">=</span> <span class="token string">'a1'</span> <span class="token operator">and</span> c2 <span class="token operator">=</span> <span class="token string">'a2'</span> <span class="token operator">and</span> c3 <span class="token operator">=</span> <span class="token string">'a3'</span> <span class="token operator">and</span> c4 <span class="token operator">=</span> <span class="token string">'a4'</span><span class="token punctuation">;</span>

<span class="token comment"># 1.</span>
<span class="token comment"># type = ref key_len = 124 ref = const, const, const, const</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test03 <span class="token keyword">where</span> c1 <span class="token operator">=</span> <span class="token string">'a1'</span> <span class="token operator">and</span> c2 <span class="token operator">=</span> <span class="token string">'a2'</span> <span class="token operator">and</span> c4 <span class="token operator">=</span> <span class="token string">'a4'</span> <span class="token operator">and</span> c3 <span class="token operator">=</span> <span class="token string">'a3'</span><span class="token punctuation">;</span>

<span class="token comment"># 2.</span>
<span class="token comment"># type = ref key_len = 124 ref = const, const, const, const</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test03 <span class="token keyword">where</span> c4 <span class="token operator">=</span> <span class="token string">'a4'</span> <span class="token operator">and</span> c3 <span class="token operator">=</span> <span class="token string">'a3'</span> <span class="token operator">and</span> c2 <span class="token operator">=</span> <span class="token string">'a2'</span> <span class="token operator">and</span> c1 <span class="token operator">=</span> <span class="token string">'a1'</span><span class="token punctuation">;</span>

<span class="token comment"># 3.</span>
<span class="token comment"># type = range key_len = 93 ref = null</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test03 <span class="token keyword">where</span> c1 <span class="token operator">=</span> <span class="token string">'a1'</span> <span class="token operator">and</span> c2 <span class="token operator">=</span> <span class="token string">'a2'</span> <span class="token operator">and</span> c3 <span class="token operator">&gt;</span> <span class="token string">'a3'</span> <span class="token operator">and</span> c4 <span class="token operator">=</span> <span class="token string">'a4'</span><span class="token punctuation">;</span>

<span class="token comment"># 4.</span>
<span class="token comment"># type = range key_len = 124 ref = null</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test03 <span class="token keyword">where</span> c1 <span class="token operator">=</span> <span class="token string">'a1'</span> <span class="token operator">and</span> c2 <span class="token operator">=</span> <span class="token string">'a2'</span> <span class="token operator">and</span> c4 <span class="token operator">&gt;</span> <span class="token string">'a4'</span> <span class="token operator">and</span> c3 <span class="token operator">=</span> <span class="token string">'a3'</span><span class="token punctuation">;</span>

<span class="token comment"># 5.</span>
<span class="token comment"># type = ref key_len = 62 ref = const, const filtered = 20(c3 作用在于排序, 而非查找, 也是用到了的)</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test03 <span class="token keyword">where</span> c1 <span class="token operator">=</span> <span class="token string">'a1'</span> <span class="token operator">and</span> c2 <span class="token operator">=</span> <span class="token string">'a2'</span> <span class="token operator">and</span> c4 <span class="token operator">=</span> <span class="token string">'a4'</span> <span class="token keyword">order</span> <span class="token keyword">by</span> c3<span class="token punctuation">;</span>

<span class="token comment"># 6.</span>
<span class="token comment"># type = ref key_len = 62 ref = const, const filtered = 100</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test03 <span class="token keyword">where</span> c1 <span class="token operator">=</span> <span class="token string">'a1'</span> <span class="token operator">and</span> c2 <span class="token operator">=</span> <span class="token string">'a2'</span> <span class="token keyword">order</span> <span class="token keyword">by</span> c3<span class="token punctuation">;</span>

<span class="token comment"># 7.</span>
<span class="token comment"># type = ref key_len = 62 ref = const, const filtered = 100, Extra : Using filesort **</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test03 <span class="token keyword">where</span> c1 <span class="token operator">=</span> <span class="token string">'a1'</span> <span class="token operator">and</span> c2 <span class="token operator">=</span> <span class="token string">'a2'</span> <span class="token keyword">order</span> <span class="token keyword">by</span> c4<span class="token punctuation">;</span>

<span class="token comment"># type = ref key_len = 62 ref = const, const filtered = 100</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test03 <span class="token keyword">where</span> c1 <span class="token operator">=</span> <span class="token string">'a1'</span> <span class="token operator">and</span> c2 <span class="token operator">=</span> <span class="token string">'a2'</span> <span class="token keyword">order</span> <span class="token keyword">by</span> c3<span class="token punctuation">,</span> c4<span class="token punctuation">;</span>


<span class="token comment"># 8</span>
<span class="token comment"># 8.1</span>
<span class="token comment"># type = ref key_len = 31 ref = const Extra : Using where (c2, c3 用于排序)</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test03 <span class="token keyword">where</span> c1 <span class="token operator">=</span> <span class="token string">'a1'</span> <span class="token operator">and</span> c5 <span class="token operator">=</span> <span class="token string">'a5'</span> <span class="token keyword">order</span> <span class="token keyword">by</span> c2<span class="token punctuation">,</span> c3<span class="token punctuation">;</span>

<span class="token comment"># 8.2</span>
<span class="token comment"># type = ref key_len = 31 ref = const Extra : Using filesort (c2, c3 颠倒了)</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test03 <span class="token keyword">where</span> c1 <span class="token operator">=</span> <span class="token string">'a1'</span> <span class="token operator">and</span> c5 <span class="token operator">=</span> <span class="token string">'a5'</span> <span class="token keyword">order</span> <span class="token keyword">by</span> c3<span class="token punctuation">,</span> c2<span class="token punctuation">;</span>

<span class="token comment"># 9</span>
<span class="token comment"># type = ref key_len = 62 ref = const const Extra : Using index condition</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test03 <span class="token keyword">where</span> c1 <span class="token operator">=</span> <span class="token string">'a1'</span> <span class="token operator">and</span> c2 <span class="token operator">=</span> <span class="token string">'a2'</span> <span class="token keyword">order</span> <span class="token keyword">by</span> c2<span class="token punctuation">,</span> c3<span class="token punctuation">;</span>

<span class="token comment"># 10</span>
<span class="token comment"># type = ref key_len = 62 ref = const, const Extra : Using where</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test03 <span class="token keyword">where</span> c1 <span class="token operator">=</span> <span class="token string">'a1'</span> <span class="token operator">and</span> c2 <span class="token operator">=</span> <span class="token string">'a2'</span> <span class="token operator">and</span> c5 <span class="token operator">=</span> <span class="token string">'a5'</span> <span class="token keyword">order</span> <span class="token keyword">by</span> c2<span class="token punctuation">,</span> c3<span class="token punctuation">;</span>

<span class="token comment"># type = ref key_len = 62 ref = const const Extra : Using where (c2 已经是一个常量了, 排序无用)</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test03 <span class="token keyword">where</span> c1 <span class="token operator">=</span> <span class="token string">'a1'</span> <span class="token operator">and</span> c2 <span class="token operator">=</span> <span class="token string">'a2'</span> <span class="token operator">and</span> c5 <span class="token operator">=</span> <span class="token string">'a5'</span> <span class="token keyword">order</span> <span class="token keyword">by</span> c3<span class="token punctuation">,</span> c2<span class="token punctuation">;</span>

<span class="token comment"># type = ref key_len = 31 ref = const Extra : Using filesort (c2, c3 颠倒了, 且 c2 非常量)</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test03 <span class="token keyword">where</span> c1 <span class="token operator">=</span> <span class="token string">'a1'</span> <span class="token operator">and</span> c5 <span class="token operator">=</span> <span class="token string">'a5'</span> <span class="token keyword">order</span> <span class="token keyword">by</span> c3<span class="token punctuation">,</span> c2<span class="token punctuation">;</span>

<span class="token comment"># 11</span>
<span class="token comment"># type = ref key_len = 31 ref = const Extra : Using where</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> test03 <span class="token keyword">where</span> c1 <span class="token operator">=</span> <span class="token string">'a1'</span> <span class="token operator">and</span> c4 <span class="token operator">=</span> <span class="token string">'a4'</span> <span class="token keyword">group</span> <span class="token keyword">by</span> c2<span class="token punctuation">,</span> c3<span class="token punctuation">;</span>

<span class="token comment"># 12</span>
<span class="token comment"># type = ref key_len = 31 ref = const Extra : Using temporary; Using filesort (GG)</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> test03 <span class="token keyword">where</span> c1 <span class="token operator">=</span> <span class="token string">'a1'</span> <span class="token operator">and</span> c4 <span class="token operator">=</span> <span class="token string">'a4'</span> <span class="token keyword">group</span> <span class="token keyword">by</span> c3<span class="token punctuation">,</span> c2<span class="token punctuation">;</span>

<span class="token comment">/*
 总结 :
    定值、范围还是排序, 一般 order by 是给个范围
    group by 基本上都需要进行排序, 会有临时表产生
 一般性建议 :
    对于单键索引, 尽量选择针对当前 query 过滤性更好的索引
    在选择组合索引的时候, 当前 query 中过滤性最好的字段在索引顺序中, 位置越靠前越好(最佳左前缀法则)
    在选择组合索引的时候, 尽量选择可以能包含当前 query 中的 where 子句中更多字段的所有
    尽可能通过分析统计信息和调整 query 的写法来达到选择合适索引的目的
 */</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br></div></div><h4 id="索引失效"><a href="#索引失效" class="header-anchor">#</a> 索引失效</h4> <blockquote><p>概念</p></blockquote> <p>索引失效大致分为以下几种 :</p> <ul><li>全值匹配我最爱</li> <li>最佳左前缀法则 : 如果索引了多例, 要遵循最左前缀发展, 指的是从索引的最左前列开始并且 不跳过索引中的列</li> <li>不在索引上做任何操作 (计算, 函数, (自动 or 手动) 类型转换), 会导致索引失效而转向全表扫描</li> <li>存储引擎不能使用索引中范围条件右边的列</li> <li>尽量使用覆盖索引 (只访问索引的查询 (索引列和查询列一致)), 减少 select</li> <li>mysql 在使用不等于 (!= 或者 &lt;&gt;) 的时候无法使用索引会导致全表扫描</li> <li>is null, is not null 也无法使用索引</li> <li>like 以通配符开头 ('$abc...') mysql 索引会失效变成全表扫描操作</li> <li>字符串不加单引号 ('') 索引失效</li> <li>少用 or, 用它连接是索引会失效</li></ul> <p></p> <blockquote><p>代码</p></blockquote> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> staffs <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
    name <span class="token keyword">VARBINARY</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">default</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'姓名'</span><span class="token punctuation">,</span>
    age <span class="token keyword">INT</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">default</span> <span class="token number">0</span> <span class="token keyword">COMMENT</span> <span class="token string">'年龄'</span><span class="token punctuation">,</span>
    pos <span class="token keyword">VARBINARY</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">default</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'职位'</span><span class="token punctuation">,</span>
    add_time <span class="token keyword">TIMESTAMP</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">default</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'入职时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">CHARSET</span> utf8 <span class="token keyword">COMMENT</span> <span class="token string">'员工记录表'</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> staffs <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> add_time<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'z3'</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token string">'manager'</span><span class="token punctuation">,</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> staffs <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> add_time<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'l4'</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token string">'dev'</span><span class="token punctuation">,</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> staffs <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> add_time<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'w5'</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token string">'dev'</span><span class="token punctuation">,</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> staffs <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> add_time<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2000'</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token string">'dev'</span><span class="token punctuation">,</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">truncate</span> <span class="token keyword">table</span> staffs<span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> staffs<span class="token punctuation">;</span>

<span class="token keyword">alter</span> <span class="token keyword">table</span> staffs <span class="token keyword">add</span> <span class="token keyword">index</span> idx_staff_nameAgePos<span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> pos<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> staffs<span class="token punctuation">;</span>

<span class="token comment"># 索引失效案例</span>
<span class="token comment">/*
 1. 全值匹配我最爱
 2. 最佳左前缀法则 : 如果索引了多例, 要遵循最左前缀发展, 指的是从索引的最左前列开始并且 不跳过索引中的列
 3. 不在索引上做任何操作 (计算, 函数, (自动 or 手动) 类型转换), 会导致索引失效而转向全表扫描
 4. 存储引擎不能使用索引中范围条件右边的列
 5. 尽量使用覆盖索引 (只访问索引的查询 (索引列和查询列一致)), 减少 select
 6. mysql 在使用不等于 (!= 或者 &lt;&gt;) 的时候无法使用索引会导致全表扫描
 7. is null, is not null 也无法使用索引
 8. like 以通配符开头 ('$abc...') mysql 索引会失效变成全表扫描操作 问题 : 解决 like '%字符串%' 索引不被使用的方法 ?
 9. 字符串不加单引号 ('') 索引失效
 10. 少用 or, 用它连接是索引会失效
 */</span>

<span class="token comment"># 1. 全值匹配我最爱</span>
<span class="token comment"># type = ref, key = idx_staff_nameAgePos, key_len = 26, ref = const, rows = 1</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> staffs <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'l4'</span><span class="token punctuation">;</span>

<span class="token comment"># type = ref, key = idx_staff_nameAgePos, key_len = 30, ref = const,const rows = 1</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> staffs <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'l5'</span> <span class="token operator">and</span> age <span class="token operator">=</span> <span class="token number">23</span><span class="token punctuation">;</span>

<span class="token comment"># type = ref, key = idx_staff_nameAgePos, key_len = 52, ref = const,const,const rows = 1</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> staffs <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'l4'</span> <span class="token operator">and</span> age <span class="token operator">=</span> <span class="token number">23</span> <span class="token operator">and</span> pos <span class="token operator">=</span> <span class="token string">'dev'</span><span class="token punctuation">;</span>

<span class="token comment"># 2. 最佳左前缀法则</span>
<span class="token comment"># type = ALL, key = NULL, ref = NULL, rows = 3</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> staffs <span class="token keyword">where</span> age <span class="token operator">=</span> <span class="token number">23</span> <span class="token operator">and</span> pos <span class="token operator">=</span> <span class="token string">'dev'</span><span class="token punctuation">;</span>

<span class="token comment"># type = ALL, key = NULL, ref = NULL, rows = 3</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> staffs <span class="token keyword">where</span> pos <span class="token operator">=</span> <span class="token string">'dev'</span><span class="token punctuation">;</span>

<span class="token comment"># type = ref, key = idx_staff_nameAgePos, key_len = 26, ref = const, rows = 1</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> staffs <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'l4'</span><span class="token punctuation">;</span>


<span class="token comment"># type = ref, key = idx_staff_nameAgePos, key_len = 26, ref = const, rows = 1</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> staffs <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'l4'</span> <span class="token operator">and</span> pos <span class="token operator">=</span> <span class="token string">'dev'</span><span class="token punctuation">;</span>

<span class="token comment"># 3. 不在索引上做任何操作 (计算, 函数, (自动 or 手动) 类型转换), 会导致索引失效而转向全表扫描</span>
<span class="token comment"># type = ref</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> staffs <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'l4'</span><span class="token punctuation">;</span>

<span class="token comment"># type = ALL</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> staffs <span class="token keyword">where</span> length<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token comment"># type = ALL</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> staffs <span class="token keyword">where</span> <span class="token keyword">left</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">'l4'</span><span class="token punctuation">;</span>

<span class="token comment"># type = ALL (类型转换)</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> staffs <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span>

<span class="token comment"># 4. 存储引擎不能使用索引中范围条件右边的列</span>
<span class="token comment"># type = ref</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> staffs <span class="token keyword">where</span>  name <span class="token operator">=</span> <span class="token string">'z3'</span><span class="token punctuation">;</span>

<span class="token comment"># type = ref</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> staffs <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'z3'</span> <span class="token operator">and</span> age <span class="token operator">=</span> <span class="token number">22</span> <span class="token operator">and</span> pos <span class="token operator">=</span> <span class="token string">'manager'</span><span class="token punctuation">;</span>

<span class="token comment"># type = range (age 用到了, 但是 pos 没用到)</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> staffs <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'z3'</span> <span class="token operator">and</span> age <span class="token operator">&gt;</span> <span class="token number">21</span> <span class="token operator">and</span> pos <span class="token operator">=</span> <span class="token string">'manager'</span><span class="token punctuation">;</span>

<span class="token comment"># 5. 尽量使用覆盖索引</span>
<span class="token comment"># Extra : Using index condition</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> staffs <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'z3'</span> <span class="token operator">and</span> age <span class="token operator">=</span> <span class="token number">22</span> <span class="token operator">and</span> pos <span class="token operator">=</span> <span class="token string">'manager'</span><span class="token punctuation">;</span>

<span class="token comment"># Extra : Using where; Using index</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> pos <span class="token keyword">from</span> staffs <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'z3'</span> <span class="token operator">and</span> age <span class="token operator">=</span> <span class="token number">22</span> <span class="token operator">and</span> pos <span class="token operator">=</span> <span class="token string">'manager'</span><span class="token punctuation">;</span>

<span class="token comment"># key_len = 52</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> pos <span class="token keyword">from</span> staffs <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'z3'</span> <span class="token operator">and</span> age <span class="token operator">=</span> <span class="token number">22</span> <span class="token operator">and</span> pos <span class="token operator">=</span> <span class="token string">'manager'</span><span class="token punctuation">;</span>

<span class="token comment"># key_len = 30</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> pos <span class="token keyword">from</span> staffs <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'z3'</span> <span class="token operator">and</span> age <span class="token operator">&gt;</span> <span class="token number">21</span> <span class="token operator">and</span> pos <span class="token operator">=</span> <span class="token string">'manager'</span><span class="token punctuation">;</span>

<span class="token comment"># key_len = 30 &amp;&amp; Extra : Using where; Using index</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> name<span class="token punctuation">,</span> age <span class="token keyword">from</span> staffs <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'z3'</span> <span class="token operator">and</span> age <span class="token operator">&gt;</span> <span class="token number">21</span> <span class="token operator">and</span> pos <span class="token operator">=</span> <span class="token string">'manager'</span><span class="token punctuation">;</span>

<span class="token comment"># 6. mysql 在使用不等于 (!= 或者 &lt;&gt;) 的时候无法使用索引会导致全表扫描</span>
<span class="token comment"># type = ref</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> staffs <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'l4'</span><span class="token punctuation">;</span>

<span class="token comment"># type = ALL</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> staffs <span class="token keyword">where</span> name <span class="token operator">!=</span> <span class="token string">'l4'</span><span class="token punctuation">;</span>

<span class="token comment"># type = ALL</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> staffs <span class="token keyword">where</span> name <span class="token operator">&lt;&gt;</span> <span class="token string">'l4'</span><span class="token punctuation">;</span>


<span class="token comment"># 7. is null, is not null 也无法使用索引</span>
<span class="token comment"># type = NULL</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> staffs <span class="token keyword">where</span> name <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">;</span>

<span class="token comment"># type = ALL</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> staffs <span class="token keyword">where</span> name <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">;</span>


<span class="token comment"># 8. like 以通配符开头 ('$abc...') mysql 索引会失效变成全表扫描操作</span>
<span class="token comment"># type = ALL</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> staffs <span class="token keyword">where</span> name <span class="token operator">like</span> <span class="token string">'%l4%'</span><span class="token punctuation">;</span>

<span class="token comment"># type = ALL</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> staffs <span class="token keyword">where</span> name <span class="token operator">like</span> <span class="token string">'%l4'</span><span class="token punctuation">;</span>

<span class="token comment"># type = range</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> staffs <span class="token keyword">where</span> name <span class="token operator">like</span> <span class="token string">'l4%'</span><span class="token punctuation">;</span>


<span class="token comment"># 9. 字符串不加单引号 ('') 索引失效 (类型转换)</span>
<span class="token comment"># type = ref</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> staffs <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'2000'</span><span class="token punctuation">;</span>

<span class="token comment"># type = ALL</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> staffs <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span>


<span class="token comment"># 10. 少用 or, 用它连接是索引会失效</span>
<span class="token comment"># type = ALL</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> staffs <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'l4'</span> <span class="token operator">or</span> name <span class="token operator">=</span> <span class="token string">'z3'</span><span class="token punctuation">;</span>

<span class="token comment">/*
 总结 :
    like KK%相当于=常量     %KK和%KK% 相当于范围
    优化总结口诀 :
        全值匹配我最爱, 最左前缀要遵守;
        带头大哥不能死, 中间兄弟不能断;
        索引列上少计算, 范围之后全失效;
        LIKE百分写最右, 覆盖索引不写星;
        不等空值还有or, 索引失效要少用;
        VAR引号不可丢 ,SQL高级也不难!

 */</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br></div></div><h5 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h5> <p>假设 index(a, b, c)</p> <table><thead><tr><th style="text-align:center;">where 语句</th> <th style="text-align:center;">索引是否被引用</th></tr></thead> <tbody><tr><td style="text-align:center;">where a = 3</td> <td style="text-align:center;">y, 使用到 a(ref)</td></tr> <tr><td style="text-align:center;">where a = 3 and b = 5</td> <td style="text-align:center;">y, 使用到 a, b(ref)</td></tr> <tr><td style="text-align:center;">where a = 3 and b = 5 and c = 4</td> <td style="text-align:center;">y, 使用到 a, b, c(ref)</td></tr> <tr><td style="text-align:center;">where b = 3 或者 where b = 3 and c = 4 或者 where c = 4</td> <td style="text-align:center;">n(ref)</td></tr> <tr><td style="text-align:center;">where a = 3 and c = 5</td> <td style="text-align:center;">使用到 a, 但是 c 不可以, b 中间断了(ref)</td></tr> <tr><td style="text-align:center;">where a = 3 and b &gt; 4 and c = 5</td> <td style="text-align:center;">使用到 , b, c 不能使用在范围之后, b 断了(rang)</td></tr> <tr><td style="text-align:center;">where a = 3 and b like 'kk%' and c = 4</td> <td style="text-align:center;">y, a 能用, b 能用, c 能用(range)</td></tr> <tr><td style="text-align:center;">where a = 3 and b like '%kk' and c = 4</td> <td style="text-align:center;">y, a 能用, b 不能用, c 不能用(ref)</td></tr> <tr><td style="text-align:center;">where a = 3 and b like '%kk%' and c = 4</td> <td style="text-align:center;">y, a 能用, b 不能用, c 不能用(ref)</td></tr> <tr><td style="text-align:center;">where a = 3 and b like 'k%k%' and c = 4</td> <td style="text-align:center;">y, a 能用, b 能用, c 能用(range)</td></tr></tbody></table> <p></p> <p>总结 :
like KK%相当于=常量     %KK和%KK% 相当于范围
优化总结口诀 :
全值匹配我最爱, 最左前缀要遵守;
带头大哥不能死, 中间兄弟不能断;
索引列上少计算, 范围之后全失效;
LIKE百分写最右, 覆盖索引不写星;
不等空值还有or, 索引失效要少用;
VAR 引号不可丢, SQL高级也不难!</p> <p></p> <h5 id="解决like索引失效问题"><a href="#解决like索引失效问题" class="header-anchor">#</a> 解决like索引失效问题</h5> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment"># 问题 : 解决 like '%字符串%' 索引不被使用的方法 ?</span>
<span class="token comment">/*
 1. 可以使用主键索引
 2. 使用覆盖索引, 查询字段必须是建立覆盖索引字段
 3. 当覆盖索引指向的字段是varchar(380)及380以上的字段时, 覆盖索引会失效
 */</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> tbl_user <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
    name <span class="token keyword">VARBINARY</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    age <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    email <span class="token keyword">VARBINARY</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">INNODB</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8<span class="token punctuation">;</span>

<span class="token comment"># drop table tbl_user</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> tbl_user<span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> email<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'1aa1'</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token string">'b@163.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> tbl_user<span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> email<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2aa2'</span><span class="token punctuation">,</span> <span class="token number">222</span><span class="token punctuation">,</span> <span class="token string">'a@163.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> tbl_user<span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> email<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'3aa3'</span><span class="token punctuation">,</span> <span class="token number">265</span><span class="token punctuation">,</span> <span class="token string">'c@163.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> tbl_user<span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> email<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'4aa4'</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token string">'d@163.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> tbl_user<span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> email<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'5aa5'</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token string">'f@163.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment"># 建立索引之前</span>
<span class="token comment"># type = ALL, key = NULL</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> name<span class="token punctuation">,</span> age <span class="token keyword">from</span> tbl_user <span class="token keyword">where</span> name <span class="token operator">like</span> <span class="token string">'%aa%'</span><span class="token punctuation">;</span>

<span class="token comment"># type = ALL, key = NULL</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> id <span class="token keyword">from</span> tbl_user <span class="token keyword">where</span> name <span class="token operator">like</span> <span class="token string">'%aa%'</span><span class="token punctuation">;</span>

<span class="token comment"># type = ALL, key = NULL</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> name <span class="token keyword">from</span> tbl_user <span class="token keyword">where</span> name <span class="token operator">like</span> <span class="token string">'%aa%'</span><span class="token punctuation">;</span>

<span class="token comment"># type = ALL, key = NULL</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> age <span class="token keyword">from</span> tbl_user <span class="token keyword">where</span> name <span class="token operator">like</span> <span class="token string">'%aa%'</span><span class="token punctuation">;</span>

<span class="token comment"># type = ALL, key = NULL</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span> name <span class="token keyword">from</span> tbl_user <span class="token keyword">where</span> name <span class="token operator">like</span> <span class="token string">'%aa%'</span><span class="token punctuation">;</span>

<span class="token comment"># type = ALL, key = NULL</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tbl_user <span class="token keyword">where</span> name <span class="token operator">like</span> <span class="token string">'%aa%'</span><span class="token punctuation">;</span>

<span class="token comment"># type = ALL, key = NULL</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> email <span class="token keyword">from</span> tbl_user <span class="token keyword">where</span> name <span class="token operator">like</span> <span class="token string">'%aa%'</span><span class="token punctuation">;</span>


<span class="token comment"># 建立索引</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> tbl_user <span class="token keyword">add</span> <span class="token keyword">index</span> idx_user_nameAge<span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> tbl_user<span class="token punctuation">;</span>

<span class="token keyword">drop</span> <span class="token keyword">index</span> idx_user_nameAge <span class="token keyword">on</span> tbl_user<span class="token punctuation">;</span>

<span class="token comment"># type = index, key = idx_user_nameAge</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> name<span class="token punctuation">,</span> age <span class="token keyword">from</span> tbl_user <span class="token keyword">where</span> name <span class="token operator">like</span> <span class="token string">'%aa%'</span><span class="token punctuation">;</span>

<span class="token comment"># type = index, key = idx_user_nameAge</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> id <span class="token keyword">from</span> tbl_user <span class="token keyword">where</span> name <span class="token operator">like</span> <span class="token string">'%aa%'</span><span class="token punctuation">;</span>

<span class="token comment"># type = index, key = idx_user_nameAge</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> name <span class="token keyword">from</span> tbl_user <span class="token keyword">where</span> name <span class="token operator">like</span> <span class="token string">'%aa%'</span><span class="token punctuation">;</span>

<span class="token comment"># type = index, key = idx_user_nameAge</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> age <span class="token keyword">from</span> tbl_user <span class="token keyword">where</span> name <span class="token operator">like</span> <span class="token string">'%aa%'</span><span class="token punctuation">;</span>

<span class="token comment"># type = index, key = idx_user_nameAge</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span> name <span class="token keyword">from</span> tbl_user <span class="token keyword">where</span> name <span class="token operator">like</span> <span class="token string">'%aa%'</span><span class="token punctuation">;</span>

<span class="token comment"># type = ALL, key = NULL</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tbl_user <span class="token keyword">where</span> name <span class="token operator">like</span> <span class="token string">'%aa%'</span><span class="token punctuation">;</span>

<span class="token comment"># type = ALL, key = NULL</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> email <span class="token keyword">from</span> tbl_user <span class="token keyword">where</span> name <span class="token operator">like</span> <span class="token string">'%aa%'</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br></div></div><p></p> <h4 id="索引优化总结"><a href="#索引优化总结" class="header-anchor">#</a> 索引优化总结</h4> <ul><li>对于单键索引，尽量选择针对当前query过滤性更好的索引</li> <li>在选择组合索引的时候，当前Query中过滤性最好的字段在索引字段顺序中，位置越靠前越好。</li> <li>在选择组合索引的时候，尽量选择可以能包含当前query中的where子句中更多字段的索引</li> <li>尽可能通过分析统计信息和调整query的写法来达到选择合适索引的目的</li></ul> <p></p> <h2 id="查询截取分析"><a href="#查询截取分析" class="header-anchor">#</a> 查询截取分析</h2> <h3 id="查询优化"><a href="#查询优化" class="header-anchor">#</a> 查询优化</h3> <blockquote><p>永远谨记 : 小表驱动大表</p></blockquote> <p><img src="https://typora-oss.yixihan.chat//img/202210302215827.png" alt="1"></p> <h4 id="exists"><a href="#exists" class="header-anchor">#</a> exists</h4> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">/*
 sql 分析
    1. 观察, 至少跑一天, 看看生产的慢 sql 情况
    2. 开启慢查询日志, 设置阙值, 比如超过 5 秒的就是慢 sql, 并将它抓取出来
    3. explain + 慢 sql 分析
    4. show profile
    5. 运维经理 or dba, 进行 sql 数据库服务器的参数调优
 总结 :
    1. 慢查询的开启并捕获
    2. explain + 慢查询分析
    3. show profile 查询 sql 在 MySQL 服务器里面的执行细节和声明周期情况
    4. sql 数据库服务器的参数调优


 数据库中, 优先选择选择上面的循环
 for (int i = 5; ...) {
    for (int j = 1000; ... (
    }
 }

 =============================

 for (int i = 1000; ...) {
    for (int j = 5; ... (
    }
 }
查询优化 :
    优化原则 : 小表驱动大表, 级小的数据集驱动大的数据集
    原理 : RBO
    select * from A where id in (select id from B)
    等价于
    for select id from B
    for select * from A where A.id = B.id;

    当 B 表的数据必须小于 A 表的数据集是, 用 in 优于 exists

    select * from A exists (select 1 from B where B.id = A.id)
    等价于
    for select * from A
    for select * from B where B.id = A.id

    当 A 表的数据集系小于 B 表的数据集是, 用 exists 优于 in
    注意 : A 表与 B 表的 id 字段应建立索引


    exists :
        语法 : select ... from table where exists (subQuery)
            该语法可以理解为 : 将主查询的数据, 放到子查询中做条件验证, 根据验证结果 (true/false) 来决定主查询的数据是否得以保留

        提示 :
            1. exists(subQuery) 只返回 true/false, 因此子查询中的 select * 也可以是 select 1 或者 select 'X', 官方的说法是
               实际执行的时候会忽略 select 清单, 因此没有区别
            2. exists 子查询的实际执行过程可能经过了优化而不是我们理解上的逐条对比, 如果担心效率问题, 可进行实际校验以确实是否有效率问题
            3. exists 子查询往往也可以用条件表达式, 其他子查询或者 join 代替, 何种最优需要具体问题具体分析
 */</span>

<span class="token comment"># exists 案例</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tbl_emp e <span class="token keyword">where</span> e<span class="token punctuation">.</span>deptId <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> id <span class="token keyword">from</span> tbl_dept d<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tbl_emp e <span class="token keyword">where</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span> <span class="token keyword">from</span> tbl_dept d <span class="token keyword">where</span> e<span class="token punctuation">.</span>deptId <span class="token operator">=</span> d<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tbl_emp e <span class="token keyword">where</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token string">'X'</span> <span class="token keyword">from</span> tbl_dept d <span class="token keyword">where</span> e<span class="token punctuation">.</span>deptId <span class="token operator">=</span> d<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><h4 id="order-by-优化"><a href="#order-by-优化" class="header-anchor">#</a> order by 优化</h4> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment"># order by 关键字优化</span>
<span class="token comment">/*
 order by 子句, 尽量使用 index 方式进行排序, 避免使用 filesort 方式排序
 */</span>

<span class="token keyword">create</span> <span class="token keyword">table</span> tblA <span class="token punctuation">(</span>
    <span class="token comment"># id INT primary key not null auto_increment,</span>
    age <span class="token keyword">INT</span><span class="token punctuation">,</span>
    birth <span class="token keyword">TIMESTAMP</span> <span class="token operator">not</span> <span class="token boolean">null</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> tblA<span class="token punctuation">(</span>age<span class="token punctuation">,</span> birth<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">,</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> tblA<span class="token punctuation">(</span>age<span class="token punctuation">,</span> birth<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> tblA<span class="token punctuation">(</span>age<span class="token punctuation">,</span> birth<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">,</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tblA<span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">index</span> idx_A_ageBirth <span class="token keyword">on</span> tblA<span class="token punctuation">(</span>age<span class="token punctuation">,</span> birth<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> tblA<span class="token punctuation">;</span>

<span class="token comment"># Extra : Using where; Using index</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tblA <span class="token keyword">where</span> age <span class="token operator">&gt;</span> <span class="token number">20</span> <span class="token keyword">order</span> <span class="token keyword">by</span> age<span class="token punctuation">;</span>

<span class="token comment"># Extra : Using where; Using index</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tblA <span class="token keyword">where</span> age <span class="token operator">&gt;</span> <span class="token number">20</span> <span class="token keyword">order</span> <span class="token keyword">by</span> age<span class="token punctuation">,</span> birth<span class="token punctuation">;</span>

<span class="token comment"># Extra : Using where; Using index; Using filesort</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tblA <span class="token keyword">where</span> age <span class="token operator">&gt;</span> <span class="token number">20</span> <span class="token keyword">order</span> <span class="token keyword">by</span> birth<span class="token punctuation">;</span>

<span class="token comment"># Extra : Using where; Using index; Using filesort</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tblA <span class="token keyword">where</span> age <span class="token operator">&gt;</span> <span class="token number">20</span> <span class="token keyword">order</span> <span class="token keyword">by</span> birth<span class="token punctuation">,</span> age<span class="token punctuation">;</span>

<span class="token comment"># Extra : Using index; Using filesort</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tblA <span class="token keyword">order</span> <span class="token keyword">by</span> birth<span class="token punctuation">;</span>

<span class="token comment"># Extra : Using where; Using index; Using filesort</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tblA <span class="token keyword">where</span> birth <span class="token operator">&gt;</span> <span class="token string">'2021-11-05 00:00:00'</span> <span class="token keyword">order</span> <span class="token keyword">by</span> birth<span class="token punctuation">;</span>

<span class="token comment"># Extra : Using where; Using index; Using filesort</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tblA <span class="token keyword">where</span> birth <span class="token operator">&gt;</span> <span class="token string">'2021-11-05 00:00:00'</span> <span class="token keyword">order</span> <span class="token keyword">by</span> age<span class="token punctuation">;</span>

<span class="token comment"># Extra : Using where; Using index</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tblA <span class="token keyword">where</span> birth <span class="token operator">&gt;</span> <span class="token string">'2021-11-05 00:00:00'</span> <span class="token keyword">order</span> <span class="token keyword">by</span> age <span class="token keyword">ASC</span><span class="token punctuation">,</span> birth <span class="token keyword">DESC</span><span class="token punctuation">;</span>

<span class="token comment">/*
 MySQL 支持两种排序, filesort 和 index,
 index 效率高, 它指 MySQL 扫描所有本身完成排序, filesort 方式效率较低

 order by 满足以下两种情况, 会使用 index 排序 : (最佳左前缀法则)
    1. order by 语句使用索引最左前列
    2. 使用 where 子句与 order by 子句条件列组合满足索引最左前列

 因此, 尽可能在索引列上完成排序操作, 遵照索引键的最佳左前缀


 如果不在索引列上, filesort 有两种算法 :
    1. 双路排序 :
        MySQL 4.1 之前使用的是双路排序, 字面意思是两次扫描磁盘, 最终得到数据
        从磁盘中取出排序字段, 在 buffer 中进行排序, 再从磁盘中取出其他字段

    2. 单路排序 :
        从磁盘读取查询需要的所有列, 按照 order by 列在 buffer 对它们进行排序, 然后扫描排序后的列表进行输出
        它的效率更快一些, 避免了第二次读取数据, 并且把随机IO变成顺序IO, 但是它会使用更多的空间, 因为它把每一行都保存在内存中了

    结论级引申出的问题 :
        1. 单路总体而言优于双路
        2. 使用单路有问题

    优化策略 :
        1. 增大 sort_buffer_size 参数的设置
        2. 增大 max_length_for_sort_data 参数的设置
        原因 : 如下

 */</span>


 <span class="token comment">/*
  单路使用可能出现的问题 :
    在 sort_buffer 中, 方法 B 要比 方法 A 多占用很多空间, 因为方法 B 是把所有字段都取出, 所以有可能取出的数据的总大小超出了 sort_buffer
    的容量, 导致每次只能去 sort_buffer 容量大小的数据, 进行排序(新建 tmp 文件, 多路合并), 排完再取出 sort_buffer 容量大小的数据, 再一次
    进行排序, 从而多次 I/O
    本来想省一次 I/O 操作, 反而导致了大量了 I/O 操作, 反而得不偿失
  */</span>

<span class="token comment">/*
 优化策略提高 sort_buffer_size 参数和 max_length_for_sort_data 参数的原因 :
    1. order by 时 select * 是一个大忌, 只 query 需要的字段, 这点儿非常重要, 在这里的影响是 :
        1. 当 query 的字段大小总和小于 max_length_for_sort_data 而且排序字段不是 TEXT | BLOB 类型时, 会用改进后的算法 -- 单路排序
           否则使用老算法 -- 多路排序
        2. 两种算法的数据都有可能超出 sort_buffer 的容量, 超出之后, 会创建 tmp 文件进行合并排序, 导致多次 I/O, 但是用单路排序算法的风险
           会更大一些, 所以要提高 sort_buffer_size
    2. 尝试提高 sort_buffer_size
        不管用哪种算法, 提高这个参数都会提高效率, 当然, 要根据系统的能力去提高, 因为这个参数是针对每个进程的
    3. 尝试提高 max_length_for_sort_data
        提高这个参数, 会增加用改进算法的概率, 但是如果设置的太大, 数据总容量超出 sort_buffer_size 的概率就会增大, 明显症状是高的磁盘 I/O
        活动和低的处理器使用率
 */</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br></div></div><p></p> <h4 id="order-by-优化总结"><a href="#order-by-优化总结" class="header-anchor">#</a> order by 优化总结</h4> <p>key a_b_c(a, b, c)
 </p> <p>order by 能使用索引最前缀
- order by a
- order by a, b
- order by a, b, c
- order by a DESC, b DESC, c DESC
 </p> <p>如果 where 使用索引的最左前缀定义为常量, 则 order by 能使用索引
- where a = const order by b, c
- where a = const and b = const order by c
- where a = const order by b, c
- where a = const and b &gt; const order by b, c
 </p> <p>不能使用索引进行排序
- order by a ASC, b DESC, c DESC    # 排序不一致
- where g = const order by b, c     # 丢失 a 索引
- where a = const order by c        # 丢失 b 索引
- where a = const order by a, d     # d 不是索引的一部分
- where a in (...) order by b, c    # 对于排序来说, 多个相等条件也是范围查询
 </p> <h5 id="group-by-优化"><a href="#group-by-优化" class="header-anchor">#</a> group by 优化</h5> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment"># group by 关键字优化</span>

<span class="token comment">/*
 group by 优化总体和 order by 优化规则一致

 有以下几点需注意 :
    1. group by 实质是先排序后进行分组, 遵照索引建的最佳左前缀
    2. 当无法使用索引列时, 增大 max_length_for_sort_data 参数的设置 + 增大 sort_buffer_size 参数的设置
    3. where 高于 having, 能写在 where 限定的条件就不要去 having 限定了
 */</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="慢查询日志"><a href="#慢查询日志" class="header-anchor">#</a> 慢查询日志</h3> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment"># 慢查询日志</span>

<span class="token comment">/*

 概念 :
    MySQL 的慢查询日志是 MySQL 提供的一种日志记录, 它用来记录在 MySQL 中响应时间超过阙值的语句,
    具体指运行时间超过 long_query_time 值的 sql 语句, 则会被记录到慢查询日志中

    具体指运行时间超过 long_query_time 值的 sql 语句, 则会被记录到慢查询日志中, long_query_time 的默认值是 10,
    意思是运行 10s 以上的语句

    由他来查看哪些 sql 超出了我们的最大忍耐时间值, 比如一条 sql 执行超过 5s, 我们就算慢 sql, 希望能收集超过 5s 的 sql,
    结合之前的 explain 进行全面分析

 如果要慢查询日志永久生效, 需要修改 my.cnf 文件
    在 [mysqld] 下配置以下参数, 然后重启服务器即可

    slow_query_log=1;
    slow_query_log_file=/var/lib/mysql/VM-4-8-centos-slow.log
    long_query_time=3;
    log_output=FILE

 开启慢查询日志后, 什么样的 sql 会被记录到慢查询日志中 ?
    这个是由参数 long_query_time 控制, 默认情况下为 10s, 可以通过命令行或者在 my.cnf 中进行修改
    MySQL 源码里是判断 大于 long_query_time, 而非大于等于

 慢查询日志在 /var/lib/mysql 目录下, 名为 xxx-slow.log


 日记分析工具 mysqldumpshow
    查看 mysqldumpshow 的帮助信息
        s : 是表示按何种方式排序
        c : 访问次数
        l : 锁定时间
        r : 返回记录
        t : 查询时间
        al : 平均锁定时间
        ar : 平均返回记录数
        at : 平均查询时间
        t : 即为返回前面多少条的数据
        g : 后边搭配一个正则匹配模式, 大小写不敏感的

    工作常用参考
        得到返回记录最多的 10 个 sql
        mysqldumpslow -s r -t 10 /var/lib/mysql/VM-4-8-centos-slow.log

        得到访问次数最多的 10 条 sql
        mysqldumpslow -s c -t 10 /var/lib/mysql/VM-4-8-centos-slow.log

        得到按照时间排序的前 10 条里面含有左连接的查询语句
        mysqldumpslow -s t -t 10 -g &quot;left join&quot; /var/lib/mysql/VM-4-8-centos-slow.log

        另外建议在使用这些命令时结合 | 和 more 使用, 否则有可能出现爆屏清理
        mysqldumpslow -s r -t 10 /var/lib/mysql/VM-4-8-centos-slow.log | more
 */</span>

<span class="token comment"># 查看慢查询日志是否开启</span>
<span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%slow_query_log%'</span><span class="token punctuation">;</span>

<span class="token comment"># 开启慢查询日志</span>
<span class="token keyword">set</span> <span class="token keyword">global</span> slow_query_log <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment"># 查看 long_query_time</span>
<span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%long_query_time%'</span><span class="token punctuation">;</span>

<span class="token comment"># 修改 long_query_time 修改完之后需要重新连接或者新开一个会话, 才能刷新成功</span>
<span class="token keyword">set</span> <span class="token keyword">global</span> long_query_time <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

<span class="token comment"># 睡 4s</span>
<span class="token keyword">select</span> sleep<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 查看当前数据库有多少条慢 sql 查询记录</span>
<span class="token keyword">show</span> <span class="token keyword">global</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'%Slow_queries%'</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br></div></div><h3 id="批量数据脚本"><a href="#批量数据脚本" class="header-anchor">#</a> 批量数据脚本</h3> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment"># 批量脚本数据</span>

<span class="token comment"># 1. 建表 dept</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> dept <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">unsigned</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
    deptno <span class="token keyword">MEDIUMINT</span> <span class="token keyword">unsigned</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">,</span>
    dname <span class="token keyword">VARBINARY</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">default</span> <span class="token string">''</span><span class="token punctuation">,</span>
    loc <span class="token keyword">VARBINARY</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">default</span> <span class="token string">''</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">INNODB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> GBK<span class="token punctuation">;</span>

<span class="token comment"># 2. 建表 emp</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> emp <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">unsigned</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
    empno <span class="token keyword">MEDIUMINT</span> <span class="token keyword">unsigned</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">default</span> <span class="token number">0</span> <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    ename <span class="token keyword">VARBINARY</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">default</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'名字'</span><span class="token punctuation">,</span>
    job <span class="token keyword">VARBINARY</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">default</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'工作'</span><span class="token punctuation">,</span>
    mgr <span class="token keyword">MEDIUMINT</span> <span class="token keyword">unsigned</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">default</span> <span class="token number">0</span> <span class="token keyword">COMMENT</span> <span class="token string">'上级编号'</span><span class="token punctuation">,</span>
    hiredate <span class="token keyword">DATE</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">COMMENT</span> <span class="token string">'入职时间'</span><span class="token punctuation">,</span>
    sal <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">COMMENT</span> <span class="token string">'薪水'</span><span class="token punctuation">,</span>
    comm <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">COMMENT</span> <span class="token string">'红利'</span><span class="token punctuation">,</span>
    deptno <span class="token keyword">MEDIUMINT</span> <span class="token keyword">unsigned</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">default</span> <span class="token number">0</span> <span class="token keyword">COMMENT</span> <span class="token string">'部门编号'</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">INNODB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> GBK<span class="token punctuation">;</span>

<span class="token keyword">show</span> <span class="token keyword">tables</span><span class="token punctuation">;</span>


<span class="token comment"># 开启 log_bin_trust_function_creators</span>
<span class="token comment">/*
 永久开启方法 : 在 my.cnf 中 [mysqld] 下面加上
    log_bin_trust_function_creators = 1
 */</span>
<span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%log_bin_trust_function_creators%'</span><span class="token punctuation">;</span>

<span class="token keyword">set</span> <span class="token keyword">global</span> log_bin_trust_function_creators <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment"># 创建函数, 保证每条数据都不同</span>

<span class="token comment"># 创建 随机产生字符串的函数</span>

<span class="token keyword">drop</span> <span class="token keyword">function</span> rand_string<span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">function</span> rand_string<span class="token punctuation">(</span>n <span class="token keyword">INT</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token keyword">VARBINARY</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>
<span class="token keyword">begin</span>

    <span class="token keyword">declare</span> chars_str <span class="token keyword">VARBINARY</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'</span><span class="token punctuation">;</span>
    <span class="token keyword">declare</span> return_str <span class="token keyword">VARBINARY</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">declare</span> i <span class="token keyword">INT</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> i <span class="token operator">&lt;</span> n <span class="token keyword">do</span>
        <span class="token keyword">set</span> return_str <span class="token operator">=</span> CONCAT<span class="token punctuation">(</span>return_str<span class="token punctuation">,</span> SUBSTR<span class="token punctuation">(</span>chars_str<span class="token punctuation">,</span> FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">52</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">set</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">end</span> <span class="token keyword">while</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> return_str<span class="token punctuation">;</span>

<span class="token keyword">end</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> rand_string<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 随机产生部门编号</span>
<span class="token keyword">drop</span> <span class="token keyword">function</span> rand_num<span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">function</span> rand_num <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token keyword">begin</span>

    <span class="token keyword">declare</span> i <span class="token keyword">INT</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">set</span> i <span class="token operator">=</span> FLOOR<span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">+</span> RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> i<span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> rand_num<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 往 emp 中插入数据</span>
<span class="token keyword">create</span> <span class="token keyword">procedure</span> inset_emp<span class="token punctuation">(</span><span class="token operator">IN</span> <span class="token keyword">start</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">IN</span> max_run <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">begin</span>

    <span class="token keyword">declare</span> i <span class="token keyword">INT</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">set</span> autocommit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">repeat</span>
        <span class="token keyword">set</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token keyword">insert</span> <span class="token keyword">into</span>
            emp<span class="token punctuation">(</span>empno<span class="token punctuation">,</span> ename<span class="token punctuation">,</span> job<span class="token punctuation">,</span> mgr<span class="token punctuation">,</span> hiredate<span class="token punctuation">,</span> sal<span class="token punctuation">,</span> comm<span class="token punctuation">,</span> deptno<span class="token punctuation">)</span>
        <span class="token keyword">VALUES</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">start</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> rand_string<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'SALESMAN'</span><span class="token punctuation">,</span> <span class="token number">0001</span><span class="token punctuation">,</span> CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">,</span> rand_num<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    until i <span class="token operator">=</span> max_run
    <span class="token keyword">end</span>  <span class="token keyword">repeat</span><span class="token punctuation">;</span>

    <span class="token keyword">commit</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>

<span class="token comment"># 往 dept 中插入数据</span>
<span class="token keyword">create</span> <span class="token keyword">procedure</span> inset_dept<span class="token punctuation">(</span><span class="token operator">IN</span> <span class="token keyword">start</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">IN</span> max_run <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">begin</span>
    <span class="token keyword">declare</span> i <span class="token keyword">INT</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">set</span> autocommit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">repeat</span>
        <span class="token keyword">set</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token keyword">insert</span> <span class="token keyword">into</span> dept<span class="token punctuation">(</span>deptno<span class="token punctuation">,</span> dname<span class="token punctuation">,</span> loc<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">start</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> rand_string<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rand_string<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    until i <span class="token operator">=</span> max_run
    <span class="token keyword">end</span>  <span class="token keyword">repeat</span><span class="token punctuation">;</span>

    <span class="token keyword">commit</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>

<span class="token comment"># 调用存储过程</span>
<span class="token keyword">call</span> inset_dept<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dept<span class="token punctuation">;</span>

<span class="token keyword">call</span> inset_emp<span class="token punctuation">(</span><span class="token number">600002</span><span class="token punctuation">,</span> <span class="token number">10000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> ename <span class="token operator">like</span> <span class="token string">'e%'</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br></div></div><h3 id="show-profiles"><a href="#show-profiles" class="header-anchor">#</a> show profiles</h3> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment"># show profile</span>
<span class="token comment">/*
 注意 : 最好在 linux 系统上执行, 不会有其余 sql 混淆, 特别是 DataGrip

 简介 : 是 MySQL 提供可以用来分析当前会话中语句执行的资源消耗情况, 可以用于 sql 的调优测量
       默认情况下, 参数处于关闭状态, 并保存最近 15 此的运行结果

 使用步骤 :
    查看 show profile 状态
        show variables like '%profiling%';

    开启 show profile
        set profiling = on;

    运行一些 sql

    查看结果 :
        show profiles;

    诊断 sql :
        show profile cpu, block io for query Query_ID;

 开发中需要注意的结论 : 有以下四个, 都急需优化
    converting HEAP to MyISAM : 查询结果太大, 内存都不够用了往磁盘上搬了
    Creating tmp table : 创建临时表, 拷贝数据到临时表, 用完再删除
    Copying to tmp table on disk : 把内存中临时表复制到磁盘, 危险 !!!
    locked

 */</span>

<span class="token comment"># 查看</span>
<span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%profiling%'</span><span class="token punctuation">;</span>

<span class="token comment"># 开启</span>
<span class="token keyword">set</span> profiling <span class="token operator">=</span> <span class="token keyword">on</span><span class="token punctuation">;</span>

<span class="token comment"># 预热</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tbl_emp e <span class="token keyword">join</span> tbl_dept d <span class="token keyword">on</span> e<span class="token punctuation">.</span>deptId <span class="token operator">=</span> d<span class="token punctuation">.</span>id<span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tbl_emp e <span class="token keyword">left</span> <span class="token keyword">join</span> tbl_dept d <span class="token keyword">on</span> e<span class="token punctuation">.</span>deptId <span class="token operator">=</span> d<span class="token punctuation">.</span>id<span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">group</span> <span class="token keyword">by</span> id<span class="token operator">%</span><span class="token number">10</span> <span class="token keyword">limit</span> <span class="token number">150000</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">group</span> <span class="token keyword">by</span> id<span class="token operator">%</span><span class="token number">20</span> <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">5</span><span class="token punctuation">;</span>

<span class="token comment"># 如果报错, 执行这条 sql</span>
<span class="token keyword">SET</span> sql_mode <span class="token operator">=</span><span class="token string">'STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION'</span><span class="token punctuation">;</span>


<span class="token comment"># 查看结果</span>
<span class="token keyword">show</span> profiles<span class="token punctuation">;</span>

<span class="token comment"># 诊断 sql, 可以查看执行这条 sql 的全部过程</span>
<span class="token keyword">show</span> profile cpu<span class="token punctuation">,</span> block io <span class="token keyword">for</span> query <span class="token number">9</span><span class="token punctuation">;</span>

<span class="token comment">/*
 show profile 参数备注 :
    | all                   -- 显示所有的开销信息
    | block io              -- 显示块 IO 相关的开销信息
    | context switches      -- 上下文切换相关的开销信息
    | cpu                   -- 显示 CPU 相关的开销信息
    | ipc                   -- 显示发送和接收相关的开销信息
    | memory                -- 显示内存相关的开销信息
    | page faults           -- 显示页面错误相关的开销信息
    | source                -- 显示和 Source_function, Source_file, Source_line 相关的开销信息
    | swaps                 -- 显示交换次数相关的开销信息
 */</span>

<span class="token comment"># 全局日志查询</span>

<span class="token comment">/*
 永远不要在生成环境中开启这个功能


 */</span>
<span class="token comment"># 编码启用</span>
<span class="token keyword">set</span> <span class="token keyword">global</span> general_log <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">set</span> <span class="token keyword">global</span> log_output <span class="token operator">=</span> <span class="token string">'TABLE'</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dept<span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> mysql<span class="token punctuation">.</span>general_log<span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br></div></div></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间: </span> <span class="time">2022/12/31 下午3:20:26</span></div></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/blogs/MySQL/MySQL3.html#mysql-的架构介绍" class="sidebar-link reco-side-mysql-的架构介绍" data-v-b57cc07c>MySQL 的架构介绍</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/MySQL/MySQL3.html#mysql-简介" class="sidebar-link reco-side-mysql-简介" data-v-b57cc07c>MySQL 简介</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/MySQL/MySQL3.html#yum-安装mysql-可行" class="sidebar-link reco-side-yum-安装mysql-可行" data-v-b57cc07c>yum 安装MySQL (可行)</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/MySQL/MySQL3.html#安装-mysql" class="sidebar-link reco-side-安装-mysql" data-v-b57cc07c>安装 MySQL</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/MySQL/MySQL3.html#mysql-数据库设置" class="sidebar-link reco-side-mysql-数据库设置" data-v-b57cc07c>MySQL 数据库设置</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/MySQL/MySQL3.html#my-cnf-完整配置" class="sidebar-link reco-side-my-cnf-完整配置" data-v-b57cc07c>my.cnf 完整配置</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/MySQL/MySQL3.html#mysql-配置文件" class="sidebar-link reco-side-mysql-配置文件" data-v-b57cc07c>MySQL 配置文件</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/MySQL/MySQL3.html#mysql-逻辑架构介绍" class="sidebar-link reco-side-mysql-逻辑架构介绍" data-v-b57cc07c>MySQL 逻辑架构介绍</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/MySQL/MySQL3.html#索引优化分析" class="sidebar-link reco-side-索引优化分析" data-v-b57cc07c>索引优化分析</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/MySQL/MySQL3.html#常见通用的-join-查询" class="sidebar-link reco-side-常见通用的-join-查询" data-v-b57cc07c>常见通用的 join 查询</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/MySQL/MySQL3.html#索引" class="sidebar-link reco-side-索引" data-v-b57cc07c>索引</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/MySQL/MySQL3.html#性能分析" class="sidebar-link reco-side-性能分析" data-v-b57cc07c>性能分析</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/MySQL/MySQL3.html#索引优化" class="sidebar-link reco-side-索引优化" data-v-b57cc07c>索引优化</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/MySQL/MySQL3.html#查询截取分析" class="sidebar-link reco-side-查询截取分析" data-v-b57cc07c>查询截取分析</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/MySQL/MySQL3.html#查询优化" class="sidebar-link reco-side-查询优化" data-v-b57cc07c>查询优化</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/MySQL/MySQL3.html#慢查询日志" class="sidebar-link reco-side-慢查询日志" data-v-b57cc07c>慢查询日志</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/MySQL/MySQL3.html#批量数据脚本" class="sidebar-link reco-side-批量数据脚本" data-v-b57cc07c>批量数据脚本</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/MySQL/MySQL3.html#show-profiles" class="sidebar-link reco-side-show-profiles" data-v-b57cc07c>show profiles</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.e43ac33f.js" defer></script><script src="/assets/js/3.e4073929.js" defer></script><script src="/assets/js/1.de47dd8b.js" defer></script><script src="/assets/js/22.21950ee6.js" defer></script>
  </body>
</html>
