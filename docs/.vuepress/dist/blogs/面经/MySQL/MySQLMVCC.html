<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MySQL - MVCC | 摸鱼小屋</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="花开亦花散">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.392636e6.css" as="style"><link rel="preload" href="/assets/js/app.fa49d2c1.js" as="script"><link rel="preload" href="/assets/js/3.e4073929.js" as="script"><link rel="preload" href="/assets/js/1.de47dd8b.js" as="script"><link rel="preload" href="/assets/js/36.0279340d.js" as="script"><link rel="prefetch" href="/assets/js/10.672405fe.js"><link rel="prefetch" href="/assets/js/11.3f481dd0.js"><link rel="prefetch" href="/assets/js/12.c8f8d536.js"><link rel="prefetch" href="/assets/js/13.4d4618fb.js"><link rel="prefetch" href="/assets/js/14.beac459e.js"><link rel="prefetch" href="/assets/js/15.7ec128ed.js"><link rel="prefetch" href="/assets/js/16.400c0891.js"><link rel="prefetch" href="/assets/js/17.e88fa7ae.js"><link rel="prefetch" href="/assets/js/18.5c42faeb.js"><link rel="prefetch" href="/assets/js/19.30d92a08.js"><link rel="prefetch" href="/assets/js/20.685ceaf3.js"><link rel="prefetch" href="/assets/js/21.666de2a5.js"><link rel="prefetch" href="/assets/js/22.02a85236.js"><link rel="prefetch" href="/assets/js/23.5fc2aca8.js"><link rel="prefetch" href="/assets/js/24.1d4d3656.js"><link rel="prefetch" href="/assets/js/25.5a5cb261.js"><link rel="prefetch" href="/assets/js/26.80079ba5.js"><link rel="prefetch" href="/assets/js/27.4b507d27.js"><link rel="prefetch" href="/assets/js/28.d28f4937.js"><link rel="prefetch" href="/assets/js/29.2fb5cea3.js"><link rel="prefetch" href="/assets/js/30.411d7492.js"><link rel="prefetch" href="/assets/js/31.f4fa6ae1.js"><link rel="prefetch" href="/assets/js/32.63df52d9.js"><link rel="prefetch" href="/assets/js/33.a4cfa817.js"><link rel="prefetch" href="/assets/js/34.62e7a2bc.js"><link rel="prefetch" href="/assets/js/35.8b42f64a.js"><link rel="prefetch" href="/assets/js/37.7a0a903b.js"><link rel="prefetch" href="/assets/js/38.83fa5f6b.js"><link rel="prefetch" href="/assets/js/39.460a20d0.js"><link rel="prefetch" href="/assets/js/4.1c403fee.js"><link rel="prefetch" href="/assets/js/40.94120e07.js"><link rel="prefetch" href="/assets/js/41.64e5ce62.js"><link rel="prefetch" href="/assets/js/42.75cff1ef.js"><link rel="prefetch" href="/assets/js/43.c435571d.js"><link rel="prefetch" href="/assets/js/44.86a13630.js"><link rel="prefetch" href="/assets/js/5.ba9c2a3c.js"><link rel="prefetch" href="/assets/js/6.7bc1a28c.js"><link rel="prefetch" href="/assets/js/7.7d67996f.js"><link rel="prefetch" href="/assets/js/8.1e07915a.js"><link rel="prefetch" href="/assets/js/9.be53e664.js">
    <link rel="stylesheet" href="/assets/css/0.styles.392636e6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>摸鱼小屋</h3> <p class="description" data-v-59e6cb88>花开亦花散</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>易曦翰</span>
          
        <!---->
        2022
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/yixihan.png" alt="摸鱼小屋" class="logo"> <span class="site-name">摸鱼小屋</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/categories/Go/" class="nav-link"><i class="undefined"></i>
  Go
</a></li><li class="dropdown-item"><!----> <a href="/categories/MySQL/" class="nav-link"><i class="undefined"></i>
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/categories/Nginx/" class="nav-link"><i class="undefined"></i>
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/categories/面经/" class="nav-link"><i class="undefined"></i>
  面经
</a></li><li class="dropdown-item"><!----> <a href="/categories/RabbitMQ/" class="nav-link"><i class="undefined"></i>
  RabbitMQ
</a></li><li class="dropdown-item"><!----> <a href="/categories/编程环境搭建/" class="nav-link"><i class="undefined"></i>
  编程环境搭建
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont icon-gongju"></i>
      工具箱
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://xpdf.net/?s" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  PDF转Word
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://tool.lu/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  在线工具箱
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://openyyy.com/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  音乐格式转换
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.shopify.com/tools/logo-maker" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  logo 生成
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://sms-activate.ru/cn/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  虚拟短信接收
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://fanyi.phpstudyhelper.com/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  代码变量名称翻译
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-account"></i>
      关于
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/yixihan" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/yixihan" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-mayun"></i>
  gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/yixihan.png" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    易曦翰
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>34</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>32</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/categories/Go/" class="nav-link"><i class="undefined"></i>
  Go
</a></li><li class="dropdown-item"><!----> <a href="/categories/MySQL/" class="nav-link"><i class="undefined"></i>
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/categories/Nginx/" class="nav-link"><i class="undefined"></i>
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/categories/面经/" class="nav-link"><i class="undefined"></i>
  面经
</a></li><li class="dropdown-item"><!----> <a href="/categories/RabbitMQ/" class="nav-link"><i class="undefined"></i>
  RabbitMQ
</a></li><li class="dropdown-item"><!----> <a href="/categories/编程环境搭建/" class="nav-link"><i class="undefined"></i>
  编程环境搭建
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont icon-gongju"></i>
      工具箱
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://xpdf.net/?s" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  PDF转Word
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://tool.lu/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  在线工具箱
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://openyyy.com/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  音乐格式转换
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.shopify.com/tools/logo-maker" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  logo 生成
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://sms-activate.ru/cn/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  虚拟短信接收
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://fanyi.phpstudyhelper.com/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  代码变量名称翻译
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-account"></i>
      关于
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/yixihan" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/yixihan" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-mayun"></i>
  gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><a href="/blogs/面经/MySQL/MySQLMVCC.html" class="active sidebar-link">MySQL - MVCC</a></li><li><a href="/blogs/面经/MySQL/MySQL事务.html" class="sidebar-link">MySQL - 事务</a></li><li><a href="/blogs/面经/MySQL/MySQL优化.html" class="sidebar-link">MySQL - 优化</a></li><li><a href="/blogs/面经/MySQL/MySQL日志.html" class="sidebar-link">MySQL - 日志</a></li><li><a href="/blogs/面经/MySQL/MySQL索引.html" class="sidebar-link">MySQL - 索引</a></li><li><a href="/blogs/面经/MySQL/MySQL面经.html" class="sidebar-link">MySQL - 面经</a></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>MySQL - MVCC</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>易曦翰</span>
          
        <!---->
        2022
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">MySQL - MVCC</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>易曦翰</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2022/10/30</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>MySQL</span><span class="tag-item" data-v-8a445198>面经</span><span class="tag-item" data-v-8a445198>MVCC</span></i></div></div> <div class="theme-reco-content content__default"><h1 id="mysql-mvcc"><a href="#mysql-mvcc" class="header-anchor">#</a> MySQL - MVCC</h1> <h2 id="一致性非锁定读和锁定读"><a href="#一致性非锁定读和锁定读" class="header-anchor">#</a> 一致性非锁定读和锁定读</h2> <h3 id="一致性非锁定读"><a href="#一致性非锁定读" class="header-anchor">#</a> 一致性非锁定读</h3> <p>对于 <a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-consistent-read.html" target="_blank" rel="noopener noreferrer">一致性非锁定读 (Consistent Nonlocking Reads)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的实现, 通常做法是加一个 <strong>版本号</strong> 或者 <strong>时间戳</strong> 字段, 在更新数据的同时更新版本号或者时间戳. 查询时, 将当前可见的版本号与对应记录的版本号进行对比, 如果记录的版本号小于可见版本号, 则表示该记录可见</p> <p>在 <code>InnoDB</code> 存储引擎中, <a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-multi-versioning.html" target="_blank" rel="noopener noreferrer">多版本控制 (multi versioning)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 就是对非锁定读的实现. 如果读取的行正在执行 <code>DELETE</code> 或 <code>UPDATE</code> 操作, 这时读取操作不会去等待行上锁的释放. 相反的, <code>InnoDB</code> 存储引擎会去读取行的一个快照数据, 对于这种读取历史数据的方式, 称之为 <strong>快照读 (snapshot read)</strong></p> <p>在可重复读 ( <code>Repeatable Read</code>) 和读已提交 (<code>Read Commit</code>) 两个隔离级别下, 如果执行普通的 <code>SELECT</code> 语句 (不包括 <code>select .... lock in share mode</code>, <code>select ... for update</code>) 则会使用 <strong>一致性非锁定读 (MVCC)</strong>. 并且在 <strong>可重复读 (<code>Repeatable Read</code>) 下 <code>MVCC</code> 实现了可重复读和防止部分幻读</strong></p> <h3 id="锁定读"><a href="#锁定读" class="header-anchor">#</a> 锁定读</h3> <p>如果执行的是下列语句, 就是 <a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-locking-reads.html" target="_blank" rel="noopener noreferrer">锁定读 (Locking Reads)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li><code>select ... lock in share mode</code></li> <li><code>select ... for update</code></li> <li><code>insert</code>, <code>update</code>, <code>delete</code> 操作</li></ul> <p>在锁定读下, 读取的是数据的最新版本, 这种读也被称为 <strong>当前读 (current read)</strong>. 锁定读会对读取到的记录加锁 :</p> <ul><li><code>select ... lock in share mode</code> : 对记录加 <code>S</code> 锁, 其他事务也可以加 <code>S</code> 锁, 如果加 <code>X</code> 锁则会被阻塞</li> <li><code>select ... for update</code>, <code>insert</code>, <code>update</code>, <code>delete</code> : 对记录加 <code>X</code> 锁, 且其他事务不能加任何锁</li></ul> <p>在一致性非锁定读下, 即使读取的记录已经被其他事务加上 <code>X</code> 锁, 这时记录也是可以被读取的, 即读取的是快照数据.</p> <p>在可重复读 (<code>Repeatable Read</code>) 下 <code>MVCC</code> 防止了部分幻读, 这里的&quot;部分&quot;是指在 <strong>一致性非锁定读</strong> 的情况下, 只能读取到第一次查询之前所插入的数据 (根据 <code>Read View</code> 判断数据可见性, <code>Read View</code> 在第一次查询时生成).</p> <p>但是, 如果是 <strong>当前读</strong>, 每次读取的都是最新数据, 这时如果两次查询中间有其他事务插入数据, 就会产生幻读.</p> <p>所以, <strong><code>InnoDB</code> 在实现可重复读 (<code>Repeatable Read</code>) 时, 如果执行的是==当前读==, 则会对读取的记录使用 <code>Next-key lock</code>, 来防止其他事务在间隙间插入数据</strong></p> <h2 id="innodb-对-mvcc-的实现"><a href="#innodb-对-mvcc-的实现" class="header-anchor">#</a> InnoDB 对 MVCC 的实现</h2> <p><code>MVCC</code> 的实现依赖于 :</p> <ul><li><strong>隐藏字段</strong></li> <li><strong><code>Read View</code></strong></li> <li><strong><code>undo log</code></strong></li></ul> <p>在内部实现中, <code>InnoDB</code> 通过数据行的 <code>DB_TRX_ID</code> 和 <code>Read View</code> 来判断数据的可见性.</p> <p>如果数据不可见, 则通过数据行的 <code>DB_ROLL_PTR</code> 找到 <code>undo log</code> 中的历史版本. 每个事务读到的数据版本可能是不一样的, <strong>在同一个事务中, 用户只能看到该事务创建 <code>Read View</code> 之前已经提交的修改和改事务本身做的修改</strong></p> <h3 id="隐藏字段"><a href="#隐藏字段" class="header-anchor">#</a> 隐藏字段</h3> <p>在内部, <code>InnoDB</code> 存储引擎为每行数据添加了三个 <a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-multi-versioning.html" target="_blank" rel="noopener noreferrer">隐藏字段<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> :</p> <ul><li><code>DB_TRX_ID</code> (6 字节) : <strong>表示最后一次插入或更新该行的事务 ID</strong>. 此外, <code>delete</code> 操作在内部被视为更新, 只不过会在记录头 <code>Record header</code> 中的 <code>deleted_flag</code> 字段将其标记为已删除</li> <li><code>DB_ROLL_PTR</code> (7 字节) : <strong>回滚指针</strong>, 指向该行的 <code>undo log</code>. 如果该行未被更新, 则为空</li> <li><code>DB_ROW_ID</code> (6 字节) : 如果没有设置主键且该表没有唯一非空索引时, <code>InnoDB</code> 会使用该 id 来生成聚集索引</li></ul> <h3 id="read-view"><a href="#read-view" class="header-anchor">#</a> Read View</h3> <blockquote><p>用途</p></blockquote> <p><a href="https://github.com/facebook/mysql-8.0/blob/8.0/storage/innobase/include/read0types.h#L298" target="_blank" rel="noopener noreferrer">Read View<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 主要是用来做 <strong>可见性判断</strong>, 里面保存了 &quot;当前对本事务不可见的其他活跃事务&quot;</p> <blockquote><p>字段</p></blockquote> <div class="language-c++ line-numbers-mode"><pre class="language-text"><code>class ReadView {
  /* ... */
private
  trx_id_t m_low_limit_id;      /* 大于等于这个 ID 的事务均不可见 */

  trx_id_t m_up_limit_id;       /* 小于这个 ID 的事务均可见 */

  trx_id_t m_creator_trx_id;    /* 创建该 Read View 的事务ID */

  trx_id_t m_low_limit_no;      /* 事务 Number, 小于该 Number 的 Undo Logs 均可以被 Purge */

  ids_t m_ids;                  /* 创建 Read View 时的活跃事务列表 */

  m_closed;                     /* 标记 Read View 是否 close */
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><code>Read View</code> 主要有以下字段 :</p> <ul><li><code>m_low_limit_id</code> : 目前出现过的最大的事务 ID + 1, 即 <strong>下一个即将被分配的事务 ID, 大于等于这个 ID 的数据版本均不可见</strong></li> <li><code>m_up_limit_id</code> : 活跃事务列表 <code>m_ids</code> 中最小的事务 ID, 如果 <code>m_ids</code> 为空, 则 <code>m_up_limit_id</code> 为 <code>m_low_limit_id</code>. <strong>小于这个 ID 的事务版本均可见</strong></li> <li><code>m_ids</code> : <code>Read View</code> 创建时其他未提交的活跃事务 ID 列表. 创建 <code>Read View</code> 时, 将当前未提交事务 ID 记录下来, 后续即使它们修改了记录行的值, 对于当前事务也是不可见的. <code>m_ids</code> 不包括当前事务自己和已提交的事务 (正在内存中)</li> <li><code>m_creator_trx_id</code> : 创建该 <code>Read View</code> 的事务 ID</li></ul> <blockquote><p>事务可见性示意图</p></blockquote> <p><img src="https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/trans_visible.jpg" alt="trans_visible"></p> <h3 id="undo-log"><a href="#undo-log" class="header-anchor">#</a> undo log</h3> <blockquote><p>作用</p></blockquote> <p><code>undo log</code> 主要有两个作用 :</p> <ul><li><p>当事务回滚时用于将数据恢复到修改前的样子</p></li> <li><p>同 隐藏字段, <code>Read View</code> 共同实现 <code>MVCC</code></p> <p>当读取记录时, 若该记录被其他事务占用或当前版本对该事务不可见, 则可以通过 <code>undo log</code> 读取之前的版本数据, 以此实现非锁定读</p></li></ul> <blockquote><p>类型</p></blockquote> <p>在 <code>InnoDB</code> 存储引擎中, <code>undo log</code> 分为两种 :</p> <ul><li><code>insert undo log</code></li> <li><code>update undo log</code></li></ul> <h4 id="insert-undo-log"><a href="#insert-undo-log" class="header-anchor">#</a> insert undo log</h4> <p><code>insert undo log</code> 指在 <code>insert</code> 操作中产生的 <code>undo log</code></p> <p>因为 <code>insert</code> 操作的记录只对事务本身可见, 对其他事务不可见, 故该 <code>undo log</code> 可以在事务提交后直接删除. 不需要进行 <code>purge</code> 操作</p> <h5 id="原理"><a href="#原理" class="header-anchor">#</a> 原理</h5> <blockquote><p><code>insert</code> 时的数据初始状态</p></blockquote> <p><img src="https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/317e91e1-1ee1-42ad-9412-9098d5c6a9ad.png" alt="img"></p> <h4 id="update-undo-log"><a href="#update-undo-log" class="header-anchor">#</a> update undo log</h4> <p><code>update undo log</code> 是指在 <code>update</code> 或 <code>delete</code> 操作中产生的 <code>undo log</code></p> <p>该 <code>undo log</code> 可能需要提供 <code>MVCC</code> 机制, 因此不能在事务提交时就进行删除. 提交时放入 <code>undo log</code> 链表, 等待 <code>purge</code> 线程进行最后的删除</p> <h5 id="原理-2"><a href="#原理-2" class="header-anchor">#</a> 原理</h5> <blockquote><p>数据第一次被修改时</p></blockquote> <p><img src="https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/c52ff79f-10e6-46cb-b5d4-3c9cbcc1934a.png" alt="img"></p> <blockquote><p>数据第二次被修改时</p></blockquote> <p><img src="https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/6a276e7a-b0da-4c7b-bdf7-c0c7b7b3b31c.png" alt="img"></p> <p>不同事务或者相同事务的对同一记录行的修改, 会使该记录行的 <code>undo log</code> 称为一条链表, 链首就是最新的记录, 链尾就是最早的旧记录</p> <h3 id="数据可见性算法"><a href="#数据可见性算法" class="header-anchor">#</a> 数据可见性算法</h3> <p>在 <code>InnoDB</code> 存储引擎中, 创建一个新事务后, 执行每个 <code>select</code> 语句前, 都会创建一个快照 (<code>Read View</code>), <strong>快照中保存了当前数据库系统中正处于活跃 (没有 <code>commit</code>) 的事务的 ID 号</strong>. 其实简单的说保存的是系统中当前不应该被本事务看到的其他事务 ID 列表 (即 <code>m_ids</code>).</p> <p>当用户在这个事务中尧都区某个记录行的时候, <code>InnoDB</code> 存储引擎会将该记录行的 <code>DB_TRX_ID</code> 与 <code>Read View</code> 中的一些变量及当前事务 ID 进行比较, 判断是否满足可见性条件</p> <h4 id="算法实现"><a href="#算法实现" class="header-anchor">#</a> 算法实现</h4> <blockquote><p>算法原址 (github)</p></blockquote> <p><a href="https://github.com/facebook/mysql-8.0/blob/8.0/storage/innobase/include/read0types.h#L161" target="_blank" rel="noopener noreferrer">算法原址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p>图示</p></blockquote> <p><img src="https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/8778836b-34a8-480b-b8c7-654fe207a8c2.png" alt="img"></p> <h4 id="算法原理"><a href="#算法原理" class="header-anchor">#</a> 算法原理</h4> <ol><li><p>如果记录 <code>DB_TRX_ID</code> &lt; <code>m_up_limit_id</code>, 那么表明最新修改该行的事务 (<code>DB_TRX_ID</code>) 在当前事务创建快照之前就提交了, 所以该记录行的值对当前事务是可见的</p></li> <li><p>如果 <code>DB_TRX_ID</code> &gt;= <code>m_low_limit_id</code>, 那么表明最新修改该行的事务 (<code>DB_TRX_ID</code>) 在当前事务创建快照之后才进行修改, 所以该记录行的值对当前事务不可见. 跳到步骤 5</p></li> <li><p><code>m_ids</code> 为空, 则表明在当前事务创建快照之前, 修改该行的事务就已经提交了, 所以该记录行的值对当前事务是可见的</p></li> <li><p>如果 <code>m_up_limit_id</code> &lt;= <code>DB_TRX_ID</code> &lt; <code>m_low_limit_id</code>, 表明最新修改该行的事务 (<code>DB_TRX_ID</code>) 在当前事务创建快照的时候可能处于 &quot;活动状态&quot; 或者 &quot;已提交状态&quot;. 所以就要对活跃事务列表 <code>m_ids</code> 进行查找 (因为事务 ID 是有序的, 所以使用二分查找)</p> <ol><li><p>如果在活跃事务列表 <code>m_ids</code> 中能找到 <code>DB_TRX_ID</code>, 表名 :</p> <ol><li><p>在当前事务创建快照前, 该记录行的值被事务 ID 为 <code>DB_TRX_ID</code> 的事务修改了, 但没有提交</p></li> <li><p>在当前事务创建快照后, 该记录行的值被事务 ID 为 <code>DB_TRX_ID</code> 的时候修改了</p> <p>这些情况下, 这个记录行的值对于当前事务都是不可见的. 跳到步骤 5</p></li></ol></li> <li><p>在活跃事务列表中找不到, 则表明 &quot;ID 为 <code>DB_TRX_ID</code> 的事务&quot; 在修改 &quot;该记录行的值&quot; 后, 在 &quot;当前事务&quot; 创建快照之前就已经提交了, 所以记录行对当前事务可见</p></li></ol></li> <li><p>在改记录行的 <code>DB_ROLL_PTR</code> 指针指向的 <code>undo log</code> 取出快照记录, 用快照记录的 <code>DB_TRX_ID</code> 跳到步骤 1 重新开始判断, 直到找到满足的快照版本或者返回空</p></li></ol> <h2 id="rc-和-rr-隔离级别下-mvcc-的差异"><a href="#rc-和-rr-隔离级别下-mvcc-的差异" class="header-anchor">#</a> RC 和 RR 隔离级别下 MVCC 的差异</h2> <p>在事务隔离级别为 读已提交 (<code>Read Commit</code>) 和 可重复读 (<code>Repeatable Read</code>) 下, <code>InnoDB</code> 存储引擎使用 <code>MVCC</code> (非锁定一致性读), 但它们生成 <code>Read View</code> 的时机不同</p> <ul><li>在 <code>RC</code> 隔离级别下, <strong>每次 <code>select</code> 查询前都生成一个 <code>Read View</code> (m_ids 列表)</strong></li> <li>在 <code>RR</code> 隔离级别下, 只有事务创建后, <strong>第一次 <code>select</code> 数据前生成一个 <code>Read View</code> (m_ids 列表)</strong></li></ul> <h2 id="mvcc-解决不可重复读问题"><a href="#mvcc-解决不可重复读问题" class="header-anchor">#</a> MVCC 解决不可重复读问题</h2> <p>虽然 <code>RC</code> 和 <code>RR</code> 都通过 <code>MVCC</code> 来读取快照数据, 但由于 <strong>生成 <code>Read VIew</code> 时机不同</strong>, 从而在 <code>RR</code> 级别下实现可重复读</p> <blockquote><p>例子</p></blockquote> <p><img src="https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/6fb2b9a1-5f14-4dec-a797-e4cf388ed413.png" alt="img"></p> <h3 id="在-rc-下-read-view-生成情况"><a href="#在-rc-下-read-view-生成情况" class="header-anchor">#</a> 在 RC 下 Read View 生成情况</h3> <p><strong>在读已提交级别下，事务在每次查询开始时都会生成并设置新的 <code>Read View</code>, (<code>m_ids</code> 列表)</strong></p> <blockquote><p>T4 时间点, 数据行 ID = 1 的版本链</p></blockquote> <p><img src="https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/a3fd1ec6-8f37-42fa-b090-7446d488fd04.png" alt="img"></p> <p>由于 <code>RC</code> 级别下每次查询都会生成 <code>Read View</code>, 这时事务 101, 102 并未提交</p> <p>此时 **103 事务生成的 <code>Read View</code> 中活跃的事务 <code>m_ids</code> 为 [101, 102], <code>m_up_limit_id</code> 为 101, <code>m_low_limit_id</code> 为 104, <code>m_creator_trx_id</code> 为 103 **</p> <ul><li>此时最新记录的 <code>DB_TRX_ID</code> 为 101, <code>m_up_limit_id</code> &lt;= 101 &lt; <code>m_low_limit_id</code>, 所以要在 <code>m_ids</code> 列表中查找, 发现 <code>DB_TRX_ID</code> 存在列表中, 那么这个记录不可见</li> <li>根据 <code>DB_ROLL_PTR</code> 找到 <code>undo log</code> 的上一版记录, 上一条记录的 <code>DB_TRX_ID</code> 还是 101, 不可见</li> <li>继续找上一条 <code>DB_TRX_ID</code> 为 1, 满足 1 &lt; <code>m_up_limit_id</code>, 可见, 所以事务 103 在 T4 时间点查询到数据为 <code>name = 菜花</code></li></ul> <blockquote><p>T6 时间点, 数据行 ID = 1 的版本链</p></blockquote> <p><img src="https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/528559e9-dae8-4d14-b78d-a5b657c88391.png" alt="markdown"></p> <p>由于 <code>RC</code> 级别下每次查询都会生成 <code>Read View</code>, 这时事务 101 已经提交, 事务 102 并未提交</p> <p>此时 <strong>103 事务生成的 <code>Read VIew</code> 中活跃的事务 <code>m_ids</code> 为 [102], <code>m_up_limit_id</code> 为 102, <code>m_low_limit_id</code> 为 104, <code>m_creator_rtx_id</code> 为 103</strong></p> <ul><li>此时最新记录中 <code>DB_TRX_ID</code> 为 102, <code>m_up_limit_id</code> &lt;= 102 &lt; <code>m_low_limit_id</code>, 所以要在 <code>m_ids</code> 列表中查找, 发现 <code>DB_TRX_ID</code> 存在列表中, 那么这个记录不可见</li> <li>根据 <code>DB_ROLL_PTR</code> 找到 <code>undo log</code> 中的上一版本记录, 上一条记录的 <code>DB_TRX_ID</code> 为 101, 满足 101 &lt; <code>m_up_limit_id</code>, 记录可见, 所以事务 103 在 T6 时间点查询到数据为 <code>name = 李四</code>, 与 T4 事件单查询到的结果不一致, <strong>不可重复读</strong></li></ul> <blockquote><p>T9 时间点, 数据行 ID = 1 的版本链</p></blockquote> <p><img src="https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/6f82703c-36a1-4458-90fe-d7f4edbac71a.png" alt="markdown"></p> <p>由于 <code>RC</code> 级别下每次查询都会生成 <code>Read View</code>, 这时事务 101, 102已经提交</p> <p>此时 **103 事务生成的 <code>Read View</code> 中活跃的事务 <code>m_ids</code> 为 [], <code>m_up_limit_id</code> 为 104, <code>m_low_limit_id</code> 为 104, <code>m_creator_trx_id</code> 为 103, **</p> <ul><li>此时最新记录中 <code>DB_TRX_ID</code> 为 102, 满足 102 &lt; <code>m_up_limit_id</code>, 可见, 所以事务 103 在 T9 时间点查询到数据为 <code>name = 赵六</code>, 与 T6 事件单查询到的结果不一致, <strong>不可重复读</strong></li></ul> <h4 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h4> <p>在 <code>RC</code> 隔离级别下, 事务在每次查询开始时都会生成并设置新的 <code>Read View</code>, 所以导致不可重复读</p> <h3 id="在-rr-下-read-view-生成情况"><a href="#在-rr-下-read-view-生成情况" class="header-anchor">#</a> 在 RR 下 Read View 生成情况</h3> <p><strong>在可重复读级别下, 只会在事务开始后第一次读取数据时生成一个 <code>Read View</code> (<code>m_ids</code> 列表)</strong></p> <blockquote><p>T4 时间点, 数据行 ID = 1 的版本链</p></blockquote> <p><img src="https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/0e906b95-c916-4f30-beda-9cb3e49746bf.png" alt="markdown"></p> <p>在当前执行 <code>select</code> 语句时生成一个 <code>Read View</code></p> <p><strong><code>m_ids</code> 为 [101, 102], <code>m_up_limit_id</code> 为 101, <code>m_low_limit_id</code> 为 104, <code>m_creator_trx_id</code> 为 103</strong></p> <p>此时和 <code>RC</code> 级别下一样 :</p> <ul><li>最新记录的 <code>DB_TRX_ID</code> 为 101, <code>m_up_limit_id</code> &lt;= 101 &lt; <code>m_low_limit_id</code>, 所以要在 <code>m_ids</code> 列表中查找, 发现 <code>DB_TRX_ID</code> 存在列表中, 那么这个记录不可见</li> <li>根据 <code>DB_ROLL_PTR</code> 找到 <code>undo log</code> 的上一版记录, 上一条记录的 <code>DB_TRX_ID</code> 还是 101, 不可见</li> <li>继续找上一条 <code>DB_TRX_ID</code> 为 1, 满足 1 &lt; <code>m_up_limit_id</code>, 可见, 所以事务 103 在 T4 时间点查询到数据为 <code>name = 菜花</code></li></ul> <blockquote><p>T6 时间点, 数据行 ID = 1 的版本链</p></blockquote> <p><img src="https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/79ed6142-7664-4e0b-9023-cf546586aa39.png" alt="markdown"></p> <p>在 <code>RR</code> 级别下只会生成一次 <code>Read View</code>, 所以此时依然沿用 T4 时间点的 <code>Read View</code></p> <p><strong><code>m_ids</code> 为 [101, 102], <code>m_up_limit_id</code> 为 101, <code>m_low_limit_id</code> 为 104, <code>m_creator_trx_id</code> 为 103</strong></p> <ul><li>最新记录的 <code>DB_TRX_ID</code> 为 102, <code>m_up_limit_id</code> &lt;= 102 &lt; <code>m_low_limit_id</code>, 所以要在 <code>m_ids</code> 列表中查找, 发现 <code>DB_TRX_ID</code> 存在列表中, 那么这个记录不可见</li> <li>根据 <code>DB_ROLL_PTR</code> 找到 <code>undo log</code> 的上一版记录, 上一条记录的 <code>DB_TRX_ID</code> 是 101, <code>m_up_limit_id</code> &lt;= 102 &lt; <code>m_low_limit_id</code>, 所以要在 <code>m_ids</code> 列表中查找, 发现 <code>DB_TRX_ID</code> 存在列表中, 不可见</li> <li>根据 <code>DB_ROLL_PTR</code> 找到 <code>undo log</code> 的上一版记录, 上一条记录的 <code>DB_TRX_ID</code> 还是 101, 不可见</li> <li>继续找上一条 <code>DB_TRX_ID</code> 为 1, 满足 1 &lt; <code>m_up_limit_id</code>, 可见, 所以事务 103 在 T4 时间点查询到数据为 <code>name = 菜花</code></li></ul> <blockquote><p>T9 时间点, 数据行 ID = 1 的版本链</p></blockquote> <p>在 <code>RR</code> 级别下只会生成一次 <code>Read View</code>, 所以此时依然沿用 T4 时间点的 <code>Read View</code></p> <p><strong><code>m_ids</code> 为 [101, 102], <code>m_up_limit_id</code> 为 101, <code>m_low_limit_id</code> 为 104, <code>m_creator_trx_id</code> 为 103</strong></p> <p>此时情况和 T6 完全一样, 所以查询结果还是 <code>name = 菜花</code></p> <h4 id="总结-2"><a href="#总结-2" class="header-anchor">#</a> 总结</h4> <p>在 <code>RR</code> 隔离级别下, 只会在事务开始后第一次读取数据时生成一个 <code>Read View</code>, 所以是可重复读的</p> <h2 id="mvcc-next-key-lock-防止幻读"><a href="#mvcc-next-key-lock-防止幻读" class="header-anchor">#</a> MVCC + Next-key-Lock 防止幻读</h2> <p><code>InnoDB</code> 存储引擎在 <code>RR</code> 级别下通过 <code>MVCC</code> + <code>Next-key-Lock</code> 来解决幻读问题</p> <p>解决方法主要分为两个方面 :</p> <ul><li><p>执行普通 <code>select</code>, 此时会以 <code>MVCC</code> 快照读的方式读取数据</p> <p>在快照读的情况下, <code>RR</code> 隔离级别只会在事务开启后的第一次查询生成 <code>Read View</code>, 并使用至事务提交.</p> <p>所以在生成 <code>Read View</code> 之后其他事务所做的更新, 插入记录版本对当前事务并不可见, 实现了可重复读和防止快照读下的 &quot;幻读&quot;</p></li> <li><p>执行 <code>select ... for update / lock in share mode</code>, <code>insert</code>, <code>update</code>, <code>delete</code> 等当前读</p> <p>在当前读下, 读取的都是最新的数据, 如果其他事务有插入新的记录, 并且刚好在当前事务的查询范围内, 就会产生幻读.</p> <p><code>InnoDB</code> 存储引擎使用 <a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html#innodb-next-key-locks" target="_blank" rel="noopener noreferrer">Next-key-Lock<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来防止这种情况. 当执行当前读时, 会锁定读取到的记录的同时, 锁定它们的间隙, 防止其他事务在查询范围内插入数据. 只要我不让你插入, 就不会产生幻读</p></li></ul></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间: </span> <span class="time">2022/12/31 下午3:20:26</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/blogs/面经/MySQL/MySQL事务.html">
          MySQL - 事务
        </a></span></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/blogs/%E9%9D%A2%E7%BB%8F/MySQL/MySQLMVCC.html#一致性非锁定读和锁定读" class="sidebar-link reco-side-一致性非锁定读和锁定读" data-v-b57cc07c>一致性非锁定读和锁定读</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/%E9%9D%A2%E7%BB%8F/MySQL/MySQLMVCC.html#一致性非锁定读" class="sidebar-link reco-side-一致性非锁定读" data-v-b57cc07c>一致性非锁定读</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/%E9%9D%A2%E7%BB%8F/MySQL/MySQLMVCC.html#锁定读" class="sidebar-link reco-side-锁定读" data-v-b57cc07c>锁定读</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/%E9%9D%A2%E7%BB%8F/MySQL/MySQLMVCC.html#innodb-对-mvcc-的实现" class="sidebar-link reco-side-innodb-对-mvcc-的实现" data-v-b57cc07c>InnoDB 对 MVCC 的实现</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/%E9%9D%A2%E7%BB%8F/MySQL/MySQLMVCC.html#隐藏字段" class="sidebar-link reco-side-隐藏字段" data-v-b57cc07c>隐藏字段</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/%E9%9D%A2%E7%BB%8F/MySQL/MySQLMVCC.html#read-view" class="sidebar-link reco-side-read-view" data-v-b57cc07c>Read View</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/%E9%9D%A2%E7%BB%8F/MySQL/MySQLMVCC.html#undo-log" class="sidebar-link reco-side-undo-log" data-v-b57cc07c>undo log</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/%E9%9D%A2%E7%BB%8F/MySQL/MySQLMVCC.html#数据可见性算法" class="sidebar-link reco-side-数据可见性算法" data-v-b57cc07c>数据可见性算法</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/%E9%9D%A2%E7%BB%8F/MySQL/MySQLMVCC.html#rc-和-rr-隔离级别下-mvcc-的差异" class="sidebar-link reco-side-rc-和-rr-隔离级别下-mvcc-的差异" data-v-b57cc07c>RC 和 RR 隔离级别下 MVCC 的差异</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/%E9%9D%A2%E7%BB%8F/MySQL/MySQLMVCC.html#mvcc-解决不可重复读问题" class="sidebar-link reco-side-mvcc-解决不可重复读问题" data-v-b57cc07c>MVCC 解决不可重复读问题</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/%E9%9D%A2%E7%BB%8F/MySQL/MySQLMVCC.html#在-rc-下-read-view-生成情况" class="sidebar-link reco-side-在-rc-下-read-view-生成情况" data-v-b57cc07c>在 RC 下 Read View 生成情况</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/%E9%9D%A2%E7%BB%8F/MySQL/MySQLMVCC.html#在-rr-下-read-view-生成情况" class="sidebar-link reco-side-在-rr-下-read-view-生成情况" data-v-b57cc07c>在 RR 下 Read View 生成情况</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/%E9%9D%A2%E7%BB%8F/MySQL/MySQLMVCC.html#mvcc-next-key-lock-防止幻读" class="sidebar-link reco-side-mvcc-next-key-lock-防止幻读" data-v-b57cc07c>MVCC + Next-key-Lock 防止幻读</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.fa49d2c1.js" defer></script><script src="/assets/js/3.e4073929.js" defer></script><script src="/assets/js/1.de47dd8b.js" defer></script><script src="/assets/js/36.0279340d.js" defer></script>
  </body>
</html>
