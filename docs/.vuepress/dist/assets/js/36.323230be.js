(window.webpackJsonp=window.webpackJsonp||[]).push([[36],{444:function(_,v,o){"use strict";o.r(v);var t=o(2),e=Object(t.a)({},(function(){var _=this,v=_._self._c;return v("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[v("hr"),_._v(" "),v("h1",{attrs:{id:"mysql-日志"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#mysql-日志"}},[_._v("#")]),_._v(" MySQL - 日志")]),_._v(" "),v("p",[v("code",[_._v("MySQL")]),_._v(" 日志主要包含 ==错误日志==, ==查询日志==, ==慢查询日志==, ==事务日志==, ==二进制日志== 几大类.")]),_._v(" "),v("p",[_._v("其中比较重要的为这三大日志")]),_._v(" "),v("ul",[v("li",[v("strong",[_._v("二进制日志  ==bin log== (归档日志)")])]),_._v(" "),v("li",[v("strong",[_._v("事务日志 ==redo log== (重做日志)")])]),_._v(" "),v("li",[_._v("**回滚日志 ==undo log== **")])]),_._v(" "),v("blockquote",[v("p",[_._v("图示")])]),_._v(" "),v("p",[v("img",{attrs:{src:"https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/01.png",alt:"img"}})]),_._v(" "),v("h2",{attrs:{id:"redo-log"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#redo-log"}},[_._v("#")]),_._v(" redo log")]),_._v(" "),v("h3",{attrs:{id:"简介"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#简介"}},[_._v("#")]),_._v(" 简介")]),_._v(" "),v("p",[v("code",[_._v("redo log")]),_._v(" 是 "),v("strong",[_._v("物理日志")]),_._v(', 记录内容是 "在某个数据页上做了什么修改", 属于 '),v("code",[_._v("InnoDB")]),_._v(" 存储引擎")]),_._v(" "),v("p",[v("code",[_._v("redo log")]),_._v(" (重做日志) 是 "),v("code",[_._v("InnoDB")]),_._v(" 存储引擎独有的, 它让 "),v("code",[_._v("MySQL")]),_._v(" 拥有了崩溃恢复的能力")]),_._v(" "),v("p",[_._v("比如 "),v("code",[_._v("MySQL")]),_._v(" 实例挂了或宕机了, 重启时, "),v("code",[_._v("InnoDB")]),_._v(" 存储引擎会使用 "),v("code",[_._v("redo log")]),_._v(" 恢复数据, 保证数据的 "),v("strong",[_._v("持久性")]),_._v(" 与 "),v("strong",[_._v("完整性")])]),_._v(" "),v("blockquote",[v("p",[_._v("图示")])]),_._v(" "),v("p",[v("img",{attrs:{src:"https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/02.png",alt:"img"}})]),_._v(" "),v("h3",{attrs:{id:"原理"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#原理"}},[_._v("#")]),_._v(" 原理")]),_._v(" "),v("p",[v("code",[_._v("MySQL")]),_._v(" 中数据是以页为单位, 你查询一条记录, 会从硬盘把一页的数据加载出来, 加载出来的数据叫数据页, 会放入到 "),v("code",[_._v("Buffer Pool")]),_._v(" 中")]),_._v(" "),v("p",[_._v("后续的查询都是先从 "),v("code",[_._v("Buffer Pool")]),_._v(" 中找, 没有命中再去硬盘加载, 减少硬盘 "),v("code",[_._v("IO")]),_._v(" 开销, 提升性能。")]),_._v(" "),v("p",[_._v("更新表数据的时候, 也是如此, 发现 "),v("code",[_._v("Buffer Pool")]),_._v(" 里存在要更新的数据, 就直接在 "),v("code",[_._v("Buffer Pool")]),_._v(" 里更新。")]),_._v(" "),v("p",[v("strong",[_._v('然后会把"在某个数据页上做了什么修改"记录到重做日志缓存（'),v("code",[_._v("redo log buffer")]),_._v("）里, 接着刷盘到 "),v("code",[_._v("redo log")]),_._v(" 文件里")])]),_._v(" "),v("blockquote",[v("p",[_._v("图示")])]),_._v(" "),v("p",[v("img",{attrs:{src:"https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/image-20220708141703421.png",alt:"image-20220708141703421"}})]),_._v(" "),v("p",[_._v("理想情况下, 事务一提交就会进行刷盘操作, 但实际上, 刷盘的时机是根据策略来进行的")]),_._v(" "),v("blockquote",[v("p",[_._v("redo log 组成")])]),_._v(" "),v("p",[_._v('每条 redo 记录由**"表空间号 + 数据页号 + 偏移量 + 修改数据长度 + 具体修改的数据"**组成')]),_._v(" "),v("h3",{attrs:{id:"刷盘时机"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#刷盘时机"}},[_._v("#")]),_._v(" 刷盘时机")]),_._v(" "),v("p",[v("code",[_._v("InnoDB")]),_._v(" 存储引擎为 "),v("code",[_._v("redp log")]),_._v(" 的刷盘策略提供了 "),v("code",[_._v("innodb_flush_log_at_trx_commit")]),_._v(" 参数, 它支持三种策略 :")]),_._v(" "),v("ul",[v("li",[_._v("0 : 设置为 0 的时候, 表示 "),v("strong",[_._v("每次事务提交时不进行刷盘操作")])]),_._v(" "),v("li",[_._v("1: 设置为 1 的时候, 表示 "),v("strong",[_._v("每次事务提交时都将进行刷盘操作")]),_._v(" (默认值)")]),_._v(" "),v("li",[_._v("2 : 设置为 2 的时候, 表示 "),v("strong",[_._v("每次事务提交时都只把 "),v("code",[_._v("redo log buffer")]),_._v(" 内容写入 "),v("code",[_._v("page cache")])])])]),_._v(" "),v("p",[v("code",[_._v("innodb_flush_log_at_trx_commit")]),_._v(" 参数默认值为 1, 也就是说当事务提交时会调用 "),v("code",[_._v("fsync")]),_._v(" 对 "),v("code",[_._v("redo log")]),_._v(" 进行刷盘")]),_._v(" "),v("p",[_._v("另外, "),v("code",[_._v("InnoDB")]),_._v(" 存储引擎有一个后台线程, 每隔 1 秒, 就会把 "),v("code",[_._v("redo log buffer")]),_._v(" 中的内容写到 文件系统缓存 "),v("code",[_._v("page cache")]),_._v(", 然后调用 "),v("code",[_._v("fsync")]),_._v(" 刷盘")]),_._v(" "),v("blockquote",[v("p",[_._v("图示")])]),_._v(" "),v("p",[v("img",{attrs:{src:"https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/04.png",alt:"img"}})]),_._v(" "),v("p",[_._v("也就是说, 一个没有提交事务的 "),v("code",[_._v("redo log")]),_._v(" 记录, 也可能会刷盘")]),_._v(" "),v("p",[_._v("因为在事务执行过程 "),v("code",[_._v("redo log")]),_._v(" 记录是会写入"),v("code",[_._v("redo log buffer")]),_._v(" 中, 这些 "),v("code",[_._v("redo log")]),_._v(" 记录会被后台线程刷盘。")]),_._v(" "),v("p",[_._v("除了后台线程每秒 1 次的轮询操作, 还有一种情况, 当 "),v("code",[_._v("redo log buffer")]),_._v(" 占用的空间即将达到 "),v("code",[_._v("innodb_log_buffer_size")]),_._v(" 一半的时候, 后台线程会主动刷盘")]),_._v(" "),v("blockquote",[v("p",[_._v("图示")])]),_._v(" "),v("p",[v("img",{attrs:{src:"https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/05.png",alt:"img"}})]),_._v(" "),v("h4",{attrs:{id:"innodb-flush-log-at-trx-commit-0"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#innodb-flush-log-at-trx-commit-0"}},[_._v("#")]),_._v(" innodb_flush_log_at_trx_commit = 0")]),_._v(" "),v("blockquote",[v("p",[_._v("图示")])]),_._v(" "),v("p",[v("img",{attrs:{src:"https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/06.png",alt:"img"}})]),_._v(" "),v("p",[_._v("为 0 时，如果 "),v("code",[_._v("MySQL")]),_._v(" 挂了或宕机可能会有 1 秒数据的丢失")]),_._v(" "),v("h4",{attrs:{id:"innodb-flush-log-at-trx-commit-1"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#innodb-flush-log-at-trx-commit-1"}},[_._v("#")]),_._v(" innodb_flush_log_at_trx_commit = 1")]),_._v(" "),v("blockquote",[v("p",[_._v("图示")])]),_._v(" "),v("p",[v("img",{attrs:{src:"https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/07.png",alt:"img"}})]),_._v(" "),v("p",[_._v("为 1 时, 只要事务提交成功, "),v("code",[_._v("redo log")]),_._v(" 记录就一定会在硬盘里, 不会有任何数据丢失")]),_._v(" "),v("p",[_._v("如果事务执行期间 "),v("code",[_._v("MySQL")]),_._v(" 挂了或宕机了, 这部分日记丢了, 但是事务并没有提交, 所以日志丢了也不会有数据丢失")]),_._v(" "),v("h4",{attrs:{id:"innodb-flush-log-at-trx-commit-2"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#innodb-flush-log-at-trx-commit-2"}},[_._v("#")]),_._v(" innodb_flush_log_at_trx_commit = 2")]),_._v(" "),v("blockquote",[v("p",[_._v("图示")])]),_._v(" "),v("p",[v("img",{attrs:{src:"https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/09.png",alt:"img"}})]),_._v(" "),v("p",[_._v("为 2 时, 只要事务提交成功, "),v("code",[_._v("redo log buffer")]),_._v(" 中的内容只会写入文件系统缓存 "),v("code",[_._v("page cache")])]),_._v(" "),v("p",[_._v("如果仅仅只是 "),v("code",[_._v("MySQL")]),_._v(" 挂了不会有任何数据丢失, 但是宕机可能会有 1 秒数据的丢失")]),_._v(" "),v("h3",{attrs:{id:"日志文件组"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#日志文件组"}},[_._v("#")]),_._v(" 日志文件组")]),_._v(" "),v("h4",{attrs:{id:"简介-2"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#简介-2"}},[_._v("#")]),_._v(" 简介")]),_._v(" "),v("p",[_._v("硬盘上存储的 "),v("code",[_._v("redo log")]),_._v(" 日志文件不止一个, 而是以一个 "),v("strong",[_._v("日志文件组")]),_._v(" 的形式出现的, 每个的 "),v("code",[_._v("redo")]),_._v(" 日志文件大小都是一样的")]),_._v(" "),v("p",[_._v("比如可以配置为一组 4 个文件, 每个文件的大小都是 "),v("code",[_._v("1GB")]),_._v(", 整个 "),v("code",[_._v("redo log")]),_._v(" 日志文件可以记录 "),v("code",[_._v("4GB")]),_._v(" 的内容")]),_._v(" "),v("h4",{attrs:{id:"原理-2"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#原理-2"}},[_._v("#")]),_._v(" 原理")]),_._v(" "),v("p",[_._v("它采用的 "),v("strong",[_._v("环形数组")]),_._v(" 形式, 从头开始写, 写到末尾又回到头循环写")]),_._v(" "),v("blockquote",[v("p",[_._v("图示")])]),_._v(" "),v("p",[v("img",{attrs:{src:"https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/10.png",alt:"img"}})]),_._v(" "),v("p",[_._v("在 "),v("strong",[_._v("日志文件组")]),_._v(" 中还有两个重要的属性, 为")]),_._v(" "),v("ul",[v("li",[v("code",[_._v("write pos")]),_._v(" : 当前记录的位置, 一边写一边后移")]),_._v(" "),v("li",[v("code",[_._v("checkpoint")]),_._v(" : 当前要擦除的位置, 一边擦一边后移")])]),_._v(" "),v("p",[_._v("每次刷盘 "),v("code",[_._v("redo log")]),_._v(" 记录到 "),v("strong",[_._v("日志文件组")]),_._v(" 中, "),v("code",[_._v("write pos")]),_._v(" 位置就会向后移更新")]),_._v(" "),v("p",[_._v("每次 "),v("code",[_._v("MySQL")]),_._v(" 加载 "),v("code",[_._v("日志文件组")]),_._v(" 恢复数据时, 会清空加载过的 "),v("code",[_._v("redo log")]),_._v(" 记录, 并把 "),v("code",[_._v("checkpoint")]),_._v(" 后移更新")]),_._v(" "),v("p",[v("code",[_._v("write pos")]),_._v(" 和 "),v("code",[_._v("checkpoint")]),_._v(" 之间还空着的部分可以用来写入新的 "),v("code",[_._v("redo log")]),_._v(" 记录")]),_._v(" "),v("blockquote",[v("p",[_._v("图示")])]),_._v(" "),v("p",[v("img",{attrs:{src:"https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/11.png",alt:"img"}})]),_._v(" "),v("p",[_._v("如果 "),v("code",[_._v("write pos")]),_._v(" 追上 "),v("code",[_._v("checkpoint")]),_._v(", 表示 "),v("strong",[_._v("日志文件组")]),_._v(" 满了, 这时候不能再写入新的 "),v("code",[_._v("redo log")]),_._v(" 记录, "),v("code",[_._v("MySQL")]),_._v(" 得停下来. 清空一些记录, 把 "),v("code",[_._v("checkpoint")]),_._v(" 推进一下")]),_._v(" "),v("blockquote",[v("p",[_._v("图示")])]),_._v(" "),v("p",[v("img",{attrs:{src:"https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/12.png",alt:"img"}})]),_._v(" "),v("h3",{attrs:{id:"redo-log-总结"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#redo-log-总结"}},[_._v("#")]),_._v(" redo log 总结")]),_._v(" "),v("blockquote",[v("p",[_._v("redo log 意义")])]),_._v(" "),v("p",[_._v("数据页大小是 "),v("code",[_._v("16KB")]),_._v(", 刷盘比较耗时, 可能就修改了数据页里的几 "),v("code",[_._v("Byte")]),_._v(" 数据, 没有必要把完整的数据页刷盘")]),_._v(" "),v("p",[_._v("而且数据页刷盘是随机写, 因为一个数据页对应的位置可能在硬盘文件的随机位置, 所以性能是很差")]),_._v(" "),v("p",[_._v("如果是写 "),v("code",[_._v("redo log")]),_._v(", 一行记录可能就占几十 "),v("code",[_._v("Byte")]),_._v(", 只包含表空间号、数据页号、磁盘文件偏移量、更新值, 再加上是顺序写, 所以刷盘速度很快")]),_._v(" "),v("p",[_._v("所以用 "),v("code",[_._v("redo log")]),_._v(" 形式记录修改内容, 性能会远远超过刷数据页的方式, 这也让数据库的并发能力更强")]),_._v(" "),v("h2",{attrs:{id:"bin-log"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#bin-log"}},[_._v("#")]),_._v(" bin log")]),_._v(" "),v("h3",{attrs:{id:"简介-3"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#简介-3"}},[_._v("#")]),_._v(" 简介")]),_._v(" "),v("p",[v("code",[_._v("bin log")]),_._v(" 是 "),v("strong",[_._v("逻辑日志")]),_._v(', 记录内容是语句的原始逻辑, 类似于 "给 ID = 2 这一行的 c 字段加 1", 属于 '),v("code",[_._v("MySQL Server")]),_._v(" 层")]),_._v(" "),v("p",[_._v("不管是什么存储引擎, 只要发生了表数据更新, 都会产生 "),v("code",[_._v("bin log")]),_._v(" 日志")]),_._v(" "),v("h3",{attrs:{id:"用途"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#用途"}},[_._v("#")]),_._v(" 用途")]),_._v(" "),v("blockquote",[v("p",[_._v("一句话概述")])]),_._v(" "),v("p",[v("strong",[_._v("保证数据的一致性")])]),_._v(" "),v("p",[v("code",[_._v("MySQL")]),_._v(" 数据库的 "),v("strong",[_._v("数据备份")]),_._v(", "),v("strong",[_._v("主备")]),_._v(", "),v("strong",[_._v("主主")]),_._v(", "),v("strong",[_._v("主从")]),_._v(" 都离不开 "),v("code",[_._v("bin log")]),_._v(", 需要依靠 "),v("code",[_._v("bin log")]),_._v(" 来同步数据, "),v("strong",[_._v("保证数据的一致性")])]),_._v(" "),v("blockquote",[v("p",[_._v("图示")])]),_._v(" "),v("p",[v("img",{attrs:{src:"https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/01-20220305234724956.png",alt:"img"}})]),_._v(" "),v("p",[v("code",[_._v("bin log")]),_._v(" 会记录所有涉及更新数据的逻辑操作, 并且是顺序写")]),_._v(" "),v("h3",{attrs:{id:"记录格式"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#记录格式"}},[_._v("#")]),_._v(" 记录格式")]),_._v(" "),v("p",[v("code",[_._v("bin log")]),_._v(" 日志有三种格式, 可以通过 "),v("code",[_._v("binlog_format")]),_._v(" 参数指定")]),_._v(" "),v("ul",[v("li",[v("strong",[_._v("statement")])]),_._v(" "),v("li",[v("strong",[_._v("row")])]),_._v(" "),v("li",[v("strong",[_._v("mixed")])])]),_._v(" "),v("h4",{attrs:{id:"statement"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#statement"}},[_._v("#")]),_._v(" statement")]),_._v(" "),v("p",[_._v("指定为 "),v("code",[_._v("statement")]),_._v(", 记录的内容是 "),v("code",[_._v("SQL")]),_._v(" 语句原文")]),_._v(" "),v("p",[_._v("比如执行一条")]),_._v(" "),v("div",{staticClass:"language-sql line-numbers-mode"},[v("pre",{pre:!0,attrs:{class:"language-sql"}},[v("code",[v("span",{pre:!0,attrs:{class:"token keyword"}},[_._v("update")]),_._v(" T\n"),v("span",{pre:!0,attrs:{class:"token keyword"}},[_._v("set")]),_._v(" update_time "),v("span",{pre:!0,attrs:{class:"token operator"}},[_._v("=")]),_._v(" "),v("span",{pre:!0,attrs:{class:"token function"}},[_._v("now")]),v("span",{pre:!0,attrs:{class:"token punctuation"}},[_._v("(")]),v("span",{pre:!0,attrs:{class:"token punctuation"}},[_._v(")")]),_._v("\n"),v("span",{pre:!0,attrs:{class:"token keyword"}},[_._v("where")]),_._v(" id "),v("span",{pre:!0,attrs:{class:"token operator"}},[_._v("=")]),_._v(" "),v("span",{pre:!0,attrs:{class:"token number"}},[_._v("1")]),v("span",{pre:!0,attrs:{class:"token punctuation"}},[_._v(";")]),_._v("\n")])]),_._v(" "),v("div",{staticClass:"line-numbers-wrapper"},[v("span",{staticClass:"line-number"},[_._v("1")]),v("br"),v("span",{staticClass:"line-number"},[_._v("2")]),v("br"),v("span",{staticClass:"line-number"},[_._v("3")]),v("br")])]),v("p",[_._v("记录的内容如下所示")]),_._v(" "),v("p",[v("img",{attrs:{src:"https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/02-20220305234738688.png",alt:"img"}})]),_._v(" "),v("p",[_._v("同步数据时, 会执行记录的 "),v("code",[_._v("SQL")]),_._v(" 语句")]),_._v(" "),v("blockquote",[v("p",[_._v("缺点")])]),_._v(" "),v("p",[v("strong",[_._v("但是有个问题 : "),v("code",[_._v("update_time = now()")]),_._v(" 这里会获取当前系统时间, 直接执行会导致与原库的数据不一致")])]),_._v(" "),v("p",[_._v("为了解决这个问题, 就需要指定为 "),v("code",[_._v("row")])]),_._v(" "),v("h4",{attrs:{id:"row"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#row"}},[_._v("#")]),_._v(" row")]),_._v(" "),v("p",[_._v("指定为 "),v("code",[_._v("row")]),_._v(", 记录的内容就不再是简单的 "),v("code",[_._v("SQL")]),_._v(" 语句了, "),v("strong",[_._v("还包含操作的具体数据")])]),_._v(" "),v("p",[_._v("记录的内容如下图所示")]),_._v(" "),v("p",[v("img",{attrs:{src:"https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/03-20220305234742460.png",alt:"img"}})]),_._v(" "),v("blockquote",[v("p",[_._v("小贴士")])]),_._v(" "),v("p",[v("code",[_._v("row")]),_._v(" 格式记录的内容看不到详细信息, 要通过 "),v("code",[_._v("mysqlbinlog")]),_._v(" 工具解析出来")]),_._v(" "),v("blockquote",[v("p",[_._v("图解")])]),_._v(" "),v("p",[v("code",[_._v("update_time = now()")]),_._v(" 变成了具体的时间 "),v("code",[_._v("update_time = 1627112756247")]),_._v(", 条件后面的 "),v("code",[_._v("@1 @2 @3")]),_._v(" 都是该数据第 1 个 ~ 3 个字段的原始值")]),_._v(" "),v("p",[_._v("这样的就能保证同步数据的一致性, 通常情况下都是指定为 "),v("code",[_._v("row")]),_._v(", 这样可以为数据库的恢复与同步带来更好的可靠性")]),_._v(" "),v("blockquote",[v("p",[_._v("缺点")])]),_._v(" "),v("ul",[v("li",[v("p",[_._v("这样的格式, 需要更大的容量来记录, 比较占用空间")])]),_._v(" "),v("li",[v("p",[_._v("恢复与同步时会更消耗 "),v("code",[_._v("IO")]),_._v(" 资源, 影响执行速度")])])]),_._v(" "),v("h4",{attrs:{id:"mixed"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#mixed"}},[_._v("#")]),_._v(" mixed")]),_._v(" "),v("p",[_._v("指定为 "),v("code",[_._v("mixed")]),_._v(", 记录的内容具具体情况决定采用 "),v("code",[_._v("row")]),_._v(" 还是 "),v("code",[_._v("statement")]),_._v(" 格式写入")]),_._v(" "),v("p",[v("code",[_._v("MySQL")]),_._v(" 判断这条 "),v("code",[_._v("SQL")]),_._v(" 语句是否可能会引起数据不一致, 如果是, 就用 "),v("code",[_._v("row")]),_._v(" 格式, 否则就用 "),v("code",[_._v("statement")]),_._v(" 格式")]),_._v(" "),v("h3",{attrs:{id:"写入机制"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#写入机制"}},[_._v("#")]),_._v(" 写入机制")]),_._v(" "),v("p",[_._v("事务执行过程中, 先把日志写到 "),v("code",[_._v("bin log cache")]),_._v(", 事务提交的时候, 再把 "),v("code",[_._v("bin log cache")]),_._v(" 写到 "),v("code",[_._v("bin log")]),_._v(" 文件中")]),_._v(" "),v("p",[_._v("因为一个事务的 "),v("code",[_._v("bin log")]),_._v(" 不能被拆开, 无论这个事务多大, 也要确保一次性写入, 所以系统会被每个线程分配一个块内存作为 "),v("code",[_._v("bin log cache")])]),_._v(" "),v("p",[_._v("可以通过 "),v("code",[_._v("binlog_cache_size")]),_._v(" 参数控制单个线程 "),v("code",[_._v("bin log cache")]),_._v(" 大小, 如果存储内容超过了这个参数, 就要暂存到磁盘 ("),v("code",[_._v("Swap")]),_._v(")")]),_._v(" "),v("blockquote",[v("p",[_._v("刷盘流程图示")])]),_._v(" "),v("p",[v("img",{attrs:{src:"https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/04-20220305234747840.png",alt:""}})]),_._v(" "),v("blockquote",[v("p",[_._v("图解")])]),_._v(" "),v("ul",[v("li",[v("strong",[_._v("上图的 "),v("code",[_._v("write")]),_._v(", 是指把日志写入到文件系统缓存 "),v("code",[_._v("page cache")]),_._v(", 并没有把数据持久化到磁盘, 所以速度比较快")])]),_._v(" "),v("li",[v("strong",[_._v("上图的 "),v("code",[_._v("fsync")]),_._v(", 才是将数据持久化到磁盘的操作")])])]),_._v(" "),v("p",[v("code",[_._v("write")]),_._v(" 和 "),v("code",[_._v("fsync")]),_._v(" 的时机, 可以由参数 "),v("code",[_._v("sync_binlog")]),_._v(" 控制, 默认为 0")]),_._v(" "),v("h4",{attrs:{id:"sync-binlog-0"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#sync-binlog-0"}},[_._v("#")]),_._v(" sync_binlog = 0")]),_._v(" "),v("p",[_._v("当参数指定为 0 的时候, 表示 "),v("strong",[_._v("每次提交都只 "),v("code",[_._v("write")]),_._v(", 由系统自行判断什么时候执行 "),v("code",[_._v("fsync")])])]),_._v(" "),v("blockquote",[v("p",[_._v("图示")])]),_._v(" "),v("p",[v("img",{attrs:{src:"https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/05-20220305234754405.png",alt:"img"}})]),_._v(" "),v("blockquote",[v("p",[_._v("优点")])]),_._v(" "),v("ul",[v("li",[_._v("性能比较高")])]),_._v(" "),v("blockquote",[v("p",[_._v("缺点")])]),_._v(" "),v("ul",[v("li",[_._v("如果 "),v("code",[_._v("MySQL")]),_._v(" 宕机, "),v("code",[_._v("page cache")]),_._v(" 里面的 "),v("code",[_._v("bin log")]),_._v(" 会丢失")])]),_._v(" "),v("h4",{attrs:{id:"sync-binlog-1"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#sync-binlog-1"}},[_._v("#")]),_._v(" sync_binlog = 1")]),_._v(" "),v("p",[_._v("当参数指定为 1 的时候, 表示 "),v("strong",[_._v("每次提交都会执行 "),v("code",[_._v("write")]),_._v(" 和 "),v("code",[_._v("fsync")])]),_._v(", 就如同 "),v("code",[_._v("redo log")]),_._v(" 日志刷盘一样")]),_._v(" "),v("h4",{attrs:{id:"sync-binlog-n-n-1"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#sync-binlog-n-n-1"}},[_._v("#")]),_._v(" sync_binlog = N (N > 1)")]),_._v(" "),v("p",[_._v("当参数指定为 N (N > 1) 时, 表示 "),v("strong",[_._v("每次提交事务都 "),v("code",[_._v("write")]),_._v(", 但累计 N 个事物后才 "),v("code",[_._v("fsync")])])]),_._v(" "),v("blockquote",[v("p",[_._v("图示")])]),_._v(" "),v("p",[v("img",{attrs:{src:"https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/06-20220305234801592.png",alt:"img"}})]),_._v(" "),v("blockquote",[v("p",[_._v("用途")])]),_._v(" "),v("p",[_._v("在出现 "),v("code",[_._v("IO")]),_._v(" 瓶颈的场景里, 将 "),v("code",[_._v("sync_binlog")]),_._v(" 设置成一个比较大的值, 可以提升性能")]),_._v(" "),v("p",[_._v("同样的, 如果 "),v("code",[_._v("MySQL")]),_._v(" 宕机, 会丢失最近 N 个事物的 "),v("code",[_._v("bin log")]),_._v(" 日志")]),_._v(" "),v("h2",{attrs:{id:"两阶段提交"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#两阶段提交"}},[_._v("#")]),_._v(" 两阶段提交")]),_._v(" "),v("p",[v("code",[_._v("redo log")]),_._v(" 让 "),v("code",[_._v("InnoDB")]),_._v(" 存储引擎拥有了崩溃恢复能力")]),_._v(" "),v("p",[v("code",[_._v("bin log")]),_._v(" 保证了 "),v("code",[_._v("MySQL")]),_._v(" 集群架构的数据一致性")]),_._v(" "),v("p",[_._v("虽然两者都属于持久化的保证, 但是侧重点不同")]),_._v(" "),v("p",[_._v("在执行更新语句过程, 会记录 "),v("code",[_._v("redo log")]),_._v(" 与 "),v("code",[_._v("bin log")]),_._v(" 两块日志, 以基本的事务为单位, "),v("code",[_._v("redo log")]),_._v("  在事务执行过程中key不断写入, 而 "),v("code",[_._v("bin log")]),_._v(" 只有在事务提交时才写入, 所以 "),v("code",[_._v("redo log")]),_._v(" 与 "),v("code",[_._v("bin log")]),_._v(" 的写入时机不一样")]),_._v(" "),v("blockquote",[v("p",[_._v("图示")])]),_._v(" "),v("p",[v("img",{attrs:{src:"https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/01-20220305234816065.png",alt:"img"}})]),_._v(" "),v("blockquote",[v("p",[v("code",[_._v("redo log")]),_._v(" 和 "),v("code",[_._v("bin log")]),_._v(" 两份日志之间逻辑不一致, 会出现什么问题 ?")])]),_._v(" "),v("p",[_._v("我们以 "),v("code",[_._v("update")]),_._v(" 语句为例, 假设 "),v("code",[_._v("id = 2")]),_._v(" 的记录, 字段 "),v("code",[_._v("c")]),_._v(" 值是 0, 把字段 "),v("code",[_._v("c")]),_._v(" 值更新成 1, "),v("code",[_._v("SQL")]),_._v(" 语句为 "),v("code",[_._v("update T set c = 1 where id = 2")])]),_._v(" "),v("p",[_._v("假设执行过程中写完 "),v("code",[_._v("redo log")]),_._v(" 日志后, "),v("code",[_._v("bin log")]),_._v(" 日志写入期间发送了异常, 会出现什么情况呢?")]),_._v(" "),v("p",[v("img",{attrs:{src:"https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/02-20220305234828662.png",alt:"img"}})]),_._v(" "),v("p",[_._v("由于 "),v("code",[_._v("binlog")]),_._v(" 没写完就异常, 这时候 "),v("code",[_._v("binlog")]),_._v(" 里面没有对应的修改记录. 因此, 之后用 "),v("code",[_._v("binlog")]),_._v(" 日志恢复数据时, 就会少这一次更新, 恢复出来的这一行 "),v("code",[_._v("c")]),_._v(" 值是 0, 而原库因为 "),v("code",[_._v("redo log")]),_._v(" 日志恢复, 这一行 "),v("code",[_._v("c")]),_._v(" 值是 1, 最终数据不一致")]),_._v(" "),v("p",[v("img",{attrs:{src:"https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/03-20220305235104445.png",alt:"img"}})]),_._v(" "),v("p",[_._v("为了解决两份日志之间的逻辑一致问题, "),v("code",[_._v("InnoDB")]),_._v(" 存储引擎使用 "),v("strong",[_._v("两阶段提交")]),_._v(" 方案")]),_._v(" "),v("p",[_._v("原理很简单, 将 "),v("code",[_._v("redo log")]),_._v(" 的写入拆成了两个步骤 "),v("code",[_._v("prepare")]),_._v(" 和 "),v("code",[_._v("commit")]),_._v(" , 这就是"),v("strong",[_._v("两阶段提交")])]),_._v(" "),v("p",[v("img",{attrs:{src:"https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/04-20220305234956774.png",alt:"img"}})]),_._v(" "),v("p",[_._v("使用 "),v("strong",[_._v("两阶段提交")]),_._v(" 后, 写入 "),v("code",[_._v("binlog")]),_._v(" 时发生异常也不会有影响, 因为 "),v("code",[_._v("MySQL")]),_._v(" 根据 "),v("code",[_._v("redo log")]),_._v(" 日志恢复数据时, 发现 "),v("code",[_._v("redo log")]),_._v(" 还处于 "),v("code",[_._v("prepare")]),_._v(" 阶段, 并且没有对应 "),v("code",[_._v("binlog")]),_._v(" 日志, 就会回滚该事务")]),_._v(" "),v("p",[v("img",{attrs:{src:"https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/05-20220305234937243.png",alt:"img"}})]),_._v(" "),v("p",[_._v("再看一个场景, "),v("code",[_._v("redo log")]),_._v(" 设置 "),v("code",[_._v("commit")]),_._v(" 阶段发生异常, 那会不会回滚事务呢?")]),_._v(" "),v("p",[v("img",{attrs:{src:"https://typora-photo-yixihan.oss-cn-chengdu.aliyuncs.com/img/06-20220305234907651.png",alt:"img"}})]),_._v(" "),v("p",[_._v("并不会回滚事务, 它会执行上图框住的逻辑, 虽然 "),v("code",[_._v("redo log")]),_._v(" 是处于 "),v("code",[_._v("prepare")]),_._v(" 阶段，但是能通过事务 "),v("code",[_._v("id")]),_._v(" 找到对应的 "),v("code",[_._v("binlog")]),_._v(" 日志, 所以 "),v("code",[_._v("MySQL")]),_._v(" 认为是完整的, 就会提交事务恢复数据")]),_._v(" "),v("h2",{attrs:{id:"undo-log"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#undo-log"}},[_._v("#")]),_._v(" undo log")]),_._v(" "),v("p",[_._v("我们知道如果想要保证事务的 "),v("strong",[_._v("原子性")]),_._v(", 就需要在异常发生时, 对已经执行的操作进行"),v("strong",[_._v("回滚")]),_._v(", 在 MySQL 中, 恢复机制是通过 "),v("strong",[_._v("回滚日志 (undo log)")]),_._v(" 实现的, 所有事务进行的修改都会先记录到这个回滚日志中, 然后再执行相关的操作. 如果执行过程中遇到异常的话, 我们直接利用 "),v("strong",[_._v("回滚日志")]),_._v(" 中的信息将数据回滚到修改之前的样子即可. 并且, 回滚日志会先于数据持久化到磁盘上. 这样就保证了即使遇到数据库突然宕机等情况, 当用户再次启动数据库的时候, 数据库还能够通过查询回滚日志来回滚将之前未完成的事务")]),_._v(" "),v("p",[_._v("另外, "),v("code",[_._v("MVCC")]),_._v(" 的实现依赖于："),v("strong",[_._v("隐藏字段、Read View、undo log")]),_._v(". 在内部实现中, "),v("code",[_._v("InnoDB")]),_._v(" 通过数据行的 "),v("code",[_._v("DB_TRX_ID")]),_._v(" 和 "),v("code",[_._v("Read View")]),_._v(" 来判断数据的可见性, 如不可见, 则通过数据行的 "),v("code",[_._v("DB_ROLL_PTR")]),_._v(" 找到 "),v("code",[_._v("undo log")]),_._v(" 中的历史版本. 每个事务读到的数据版本可能是不一样的, 在同一个事务中, 用户只能看到该事务创建 "),v("code",[_._v("Read View")]),_._v(" 之前已经提交的修改和该事务本身做的修改")]),_._v(" "),v("h3",{attrs:{id:"用途-2"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#用途-2"}},[_._v("#")]),_._v(" 用途")]),_._v(" "),v("p",[v("strong",[_._v("保证数据的原子性")])]),_._v(" "),v("h2",{attrs:{id:"总结"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[_._v("#")]),_._v(" 总结")]),_._v(" "),v("p",[v("code",[_._v("MySQL InnoDB")]),_._v(" 存储引擎"),v("strong",[_._v("使用 "),v("code",[_._v("redo log (重做日志)")]),_._v(" 保证事务的持久性")]),_._v(", 使用  "),v("strong",[v("code",[_._v("undo log (回滚日志)")]),_._v(" 保证事务的原子性")])]),_._v(" "),v("p",[v("code",[_._v("MySQL")]),_._v(" 数据库的 "),v("strong",[_._v("数据备份, 主备, 主主, 主从")]),_._v(" 都离不开 "),v("code",[_._v("bin log")]),_._v(", 需要依靠 "),v("code",[_._v("bin log")]),_._v(" 来同步数据, "),v("strong",[_._v("保证数据的一致性")])])])}),[],!1,null,null,null);v.default=e.exports}}]);